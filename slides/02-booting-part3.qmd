---
title: "Arrencada del sistema (Part 3)"
subtitle: "Unitat 2 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Forn√©s"
logo: "/figs/corporative/institute.png"
format: 
  revealjs:
    transition: fade
    slide-number: true
    incremental: true 
    chalkboard: false
    css: styles.css
    footer: "Unitat 2 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA) [üè†](/index.html)</a>"
editor: visual

execute:
  freeze: auto
  echo: false
---

## Etapes de l'arrancada

![](../figs/slides/02-booting/linux-unix-booting-process.png)

## PID 1: init/systemd {.smaller}

Quan s'acaba el proc√©s d'inicialitzaci√≥ del sistema en l'espai del kernel i es descomprimeix i executa l'initramfs, es produeix una transici√≥ important cap a l'espai d'usuari.

``` bash
exec switch_root /mnt /sbin/init
```

-   El comandament `switch_root` substitueix l'arrel del sistema de fitxers actual (l'initramfs) per la partici√≥ arrel real del sistema operatiu.
-   El kernel deixa de gestionar directament els processos i passa el control a un proc√©s en l'espai d'usuari.
-   El proc√©s **PID 1** √©s el primer proc√©s que s'inicia en l'espai d'usuari i √©s responsable de la gesti√≥ dels processos del sistema operatiu.
-   Tradicionalment, aquest proc√©s era el programa **init**, per√≤ en els sistemes moderns, *systemd* ha substitu√Øt *init* com a responsable principal de la gesti√≥ de processos.

## Funcions de PID 1 {.smaller}

1.  **Gesti√≥ de la inicialitzaci√≥ del sistema**. Carrega els serveis i dimonis necessaris per al bon funcionament del sistema.
2.  **Gesti√≥ dels processos del sistema**. Controla la creaci√≥, execuci√≥ i finalitzaci√≥ dels processos. Si un proc√©s orfe (un proc√©s que perd el seu proc√©s pare) continua en execuci√≥, el PID 1 assumeix la seva gesti√≥ i, eventualment, la seva terminaci√≥.
3.  **Arrel de l'arbre de processos**: Tots els altres processos del sistema pengen d'ell, directament o indirectament. Aix√≤ fa que sigui fonamental per a l'estabilitat i la continu√Øtat del sistema.
4.  **Apagat i reinici del sistema**: El PID 1 tamb√© √©s responsable de controlar l'apagat i reinici del sistema, garantint que els processos es tanquin adequadament i que el sistema es desconnecti de manera segura

## Systemd vs SysVinit {.smaller}

El canvi de **SysVinit** a [**Systemd**](https://systemd.io/) en moltes distribucions de Linux va ser motivat per la necessitat de millorar l'efici√®ncia i la gesti√≥ dels serveis del sistema.

::::: columns
::: {.column width="45%"}
### SysVinit

-   **Seq√ºencial**: Basat en scripts. *Cada servei dep√®n de l'execuci√≥ completa del servei anterior, la qual cosa pot ser lenta*.
-   **Simple**: Cada servei s'inicia amb un script directament llegible i modificable per l'administrador del sistema.
-   **Inflexible**: Dificultat engestionar depend√®ncies. *No permet arrencar serveis en paral¬∑lel ni controlar els processos un cop arrencats*.
:::

::: {.column width="55%"}
### Systemd

-   **Rendiment**: Capacitat de carregar serveis en paral¬∑lel. Reducci√≥ temps d'inici del sistema.
-   **Modularitat**: Els serveis es gestionen a trav√©s d'unitats (*unit files*) que poden especificar depend√®ncies, condicions de reinici autom√†tic,etc.
-   **Cgroups**: Limitar/gestionar els recursos assignats a cada servei.
-   **Monitoratge**: Control i seguiment granular dels serveis amb *journalctl*.
:::
:::::

## Cr√≠tiques a Systemd {.smaller}

-   **Complexitat**
    -   Integra m√∫ltiples funcionalitats (gesti√≥ de serveis, journal, timers, logind, networkd, etc.) en un sol proc√©s. Aix√≤ pot augmentar la superf√≠cie de fallada i dificultar la depuraci√≥.
-   **Trenca amb la filosofia Unix tradicional**
    -   Unix promou eines petites, especialitzades i composables.\
    -   Systemd concentra moltes tasques en un √∫nic sistema de gesti√≥.
-   **Depend√®ncia del sistema**
    -   Molts scripts, paquets i eines modernes depenen de systemd, dificultant la compatibilitat amb sistemes alternatius (SysVinit, OpenRC).

::: fragment
#### Debat en la comunitat

-   Els defensors de **systemd** argumenten que simplifica l‚Äôadministraci√≥ de sistemes moderns i ofereix funcions que abans requerien m√∫ltiples eines externes.\
-   Els cr√≠tics insisteixen en que √©s massa intrusiu i redueix la flexibilitat per a administradors avan√ßats i entorns m√≠nims.\
:::

## Backdoor en XZ Utils (I) {.smaller}

Recents vulnerabilitats en paquets com **xz-utils** han posat en evid√®ncia la complexitat de *Systemd* i com una backdoor ocult pot comprometre gran part de la infraestructura moderna de Linux.

-   El backdoor va ser introdu√Øt de manera gradual, comen√ßant amb contribucions sospitoses al projecte **libarchive el 2021**.
-   Durant el 2022, un desenvolupador desconegut, *JiaT75*, va guanyar influ√®ncia dins del projecte **xz-utils**, substituint el contacte del mantenidor original i introduint canvis que van ocultar les vulnerabilitats.
-   El 2023, *JiaT75* va introduir modificacions malicioses a **xz-utils**, aprofitant-les per comprometre sistemes a trav√©s de depend√®ncies amb Systemd.

[**CVE-2024-3094**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-3094): Vulnerabilitat que permet l'execuci√≥ de codi malici√≥s en el sistema mitjan√ßant un defecte en la descompressi√≥ de fitxers **.xz**.

## Backdoor en XZ Utils (II) {.smaller}

Aquesta vulnerabilitat va afectar molts servidors Linux, que van actualitzar **xz-utils** amb la versi√≥ compromesa.

-   **liblzma** √©s una llibreria de compressi√≥ que es pot enlla√ßar amb altres programes. Per exemple, **OpenSSH** es pot vincular a **liblzma** per gestionar la descompressi√≥ de fitxers de configuraci√≥.
-   En sistemes amb **systemd**, **OpenSSH** enlla√ßa amb **systemd**, que a la vegada enlla√ßa amb **liblzma**. Aix√≤ permet a **XZ Utils** controlar indirectament serveis essencials com **sshd**.
-   Mitjan√ßant una backdoor oculta en versions modificades de **xz-utils**, un atacant amb una clau de xifrat pr√®viament establerta podria carregar codi malici√≥s en certificats SSH i executar-lo en dispositius compromesos.

::: center-container
Aquests esdeveniments posen de manifest les contrapartides de la complexitat de **Systemd** i com una vulnerabilitat en un paquet aparentment inofensiu com **xz-utils** pot tenir un impacte significatiu en la seguretat del sistema i serveis cr√≠tics com **sshd**.
:::

## Executar els Targets o Runlevels {.smaller}

El **PID 1** executa els *targets* de systemd. En sistemes m√©s antics, s'utilitzaven els *runlevels* d'init. Els targets representen un conjunt de serveis i m√≤duls que s'executen per a cada estat del sistema. La seva funci√≥ √©s definir l'estat del sistema i els serveis que s'han de carregar en aquest estat. La transici√≥ entre els *targets* es pot fer manualment amb la comanda `systemctl isolate` o autom√†ticament amb la comanda `systemctl set-default`.

::: fragment
-   **default.target**: Apunta a *graphical.target* o *multi-user.target*-
-   **graphical.target**: Defineix un entorn gr√†fic.
-   **multi-user.target**: Proporciona un entorn no gr√†fic, permetent m√∫ltiples usuaris al sistema, habitual per a servidors.
-   **rescue.target**: Proporciona un entorn de rescat amb una consola de l√≠nia de comandes.
-   **emergency.target**: Ofereix un entorn d'emerg√®ncia que inicialitza el m√≠nim de serveis necessaris per a la soluci√≥ de problemes.
-   **shutdown.target**: Gestiona l'apagat del sistema.
-   **reboot.target**: Gestiona el reinici del sistema.
:::

## Units de systemd {.smaller}

Els **units** s√≥n els fitxers de configuraci√≥ de **systemd** que defineixen els serveis, ens permeten gestionar-los i controlar-los.

-   `/etc/systemd/system/` ‚Äì Fitxers d'unitat personalitzats per l'administrador.
-   `/run/systemd/system/` ‚Äì Configuraci√≥ en temps d'execuci√≥, √©s a dir, afecta nom√©s un arrencada √∫nica.
-   `/usr/lib/systemd/system/` ‚Äì Configuraci√≥ proporcionada per la distribuci√≥. A Debian √©s `/lib/systemd/system/`.

Quan hi ha dos fitxers de configuraci√≥ amb el mateix nom, **systemd** carregar√† nom√©s un des del directori que estigui m√©s alt en la jerarquia. Per exemple, la configuraci√≥ a `/etc` sempre sobreescriu la configuraci√≥ a `/usr`.

Despr√©s de canviar la configuraci√≥, √©s necessari recarregar **systemd** amb: `systemctl daemon-reload`.

## Tipus d'unitats {.smaller}

-   **Serveis**: Fitxers que defineixen com s'inicien, s'aturen i es gestionen els serveis. Ex: `/etc/systemd/system/sshd.service` (servei SSH).
-   **Sockets**: Units que gestionen els *sockets* de comunicaci√≥ per als serveis.
-   **Devices**: Units que representen dispositius de maquinari.
-   **Mounts**: Units que gestionen els punts de muntatge del sistema de fitxers.
-   **Paths**: Units que monitoren els canvis en fitxers o directoris espec√≠fics.
-   **Timers**: Units que planifiquen tasques per a la seva execuci√≥ en moments espec√≠fics.
-   **Targets**: Units que agrupen altres units per a l'arrencada d'estats del sistema.

## Targets i Systemd {.smaller}

![](../figs/slides/02-booting/systemd.png)

## Exemple de fitxer d'unitat {.smaller}

``` bash
[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=network.target
[Service]
ExecStart=/usr/sbin/cupsd -l
Type=notify
[Install]
Also=cups.socket cups.path
WantedBy=printer.target
```

::: notes
Aquest fitxer defineix el servei **CUPS** (Common Unix Printing System) √©s un sistema que t√© una depen√®ncia amb la xarxa (`After=network.target`), s'inicia amb el comandament `/usr/sbin/cupsd -l` i es configura per iniciar-se autom√†ticament quan s'arrenca el sistema (`WantedBy=printer.target`). Printer.target √©s un *target* que agrupa serveis relacionats amb la impressi√≥. Cups.socket i cups.path s√≥n altres unitats que tamb√© s'inicien quan s'inicia el servei CUPS ja que estan lligades a aquest servei. El tipus de servei √©s `notify`, el qual indica que el servei enviar√† una notificaci√≥ a systemd quan estigui llest.
:::

## Depend√®ncies entre unitats {.smaller}

Les unitats s√≥n objectes gestionats per **systemd**. Les depend√®ncies s√≥n associacions entre elles. Cada tipus d'unitat t√© algunes depend√®ncies per defecte (a menys que s'especifiqui el contrari).

::::: columns
::: {.column width="65%"}
#### Relacionals

-   **Requires**: Indica que una unitat dep√®n d'una altra unitat per a la seva activaci√≥. Si la unitat requerida no est√† activa, la unitat que la requereix no s'activar√†.
-   **Wants**: Similar a **Requires**, per√≤ no √©s tan estricte. Si la unitat requerida no est√† activa, la unitat que la vol no es bloquejar√†.
-   **BindsTo**: Similar a **Requires**, per√≤ si la unitat requerida es det√©, la unitat que la vincula tamb√© es detindr√†.
-   **PartOf**: Indica que una unitat √©s part d'una altra unitat. Si la unitat pare es det√©, la unitat fill tamb√© es detindr√†.
-   **Conflicts**: Indica que dues unitats no poden estar actives al mateix temps. Si una unitat s'activa, l'altra es detindr√† autom√†ticament.
:::

::: {.column width="35%"}
#### Ordenaci√≥

-   **After**: Indica que una unitat s'ha d'iniciar despr√©s d'una altra unitat. No crea una depend√®ncia estricta, nom√©s defineix l'ordre d'inici.
-   **Before**: Indica que una unitat s'ha d'iniciar abans d'una altra unitat. No crea una depend√®ncia estricta, nom√©s defineix l'ordre d'inici.
:::
:::::

## Transaccions a systemd (I) {.smaller}

Cada vegada que l‚Äôusuari o un servei sol¬∑licita una acci√≥ (per exemple, iniciar o aturar un servei), es crea una **transacci√≥** que gestiona l‚Äôexecuci√≥ ordenada de les unitats afectades.

1.  **Creaci√≥ de feines (jobs)**
    -   Es crea una feina per a la unitat sol¬∑licitada.\
    -   S‚Äôafegeixen recursivament les feines corresponents a totes les **depend√®ncies** de la unitat.
2.  **Minimitzaci√≥ de la transacci√≥**
    -   Eliminar feines duplicades o redundants.\
    -   Eliminar feines que no estiguin referenciades per cap altre job (ancoratge).
3.  **Resoluci√≥ de cicles de depend√®ncies**
    -   Detectar **loops** en el gr√†fic de depend√®ncies.\
    -   Trencar-los eliminant feines problem√†tiques per evitar deadlocks.

## Transaccions a systemd (I) {.smaller}

4.  **Fusi√≥ i optimitzaci√≥ de feines**
    -   Fusionar feines similars per reduir el nombre d‚Äôoperacions.\
    -   Prioritzar feines ja existents a la cua.
5.  **Enviament i execuci√≥**
    -   Afegir les feines a la **cua de jobs** de systemd.\
    -   Executar les feines segons la depend√®ncia i l‚Äôordre optimitzat.

::: fragment
Garanteix que les unitats es gestionin de manera at√≤mica i ordenada, permetent a systemd paral¬∑lelitzar serveis mentre respecta les depend√®ncies.
:::

::: notes
-   Les **transaccions** garanteixen que les unitats es gestionin de manera at√≤mica i ordenada.\
-   Aix√≤ permet a systemd **paral¬∑lelitzar serveis** mentre respecta les depend√®ncies.\
-   Cadascuna de les feines cont√© informaci√≥ sobre la unitat, la seva acci√≥ (`start`, `stop`, `reload`) i les condicions d‚Äôexecuci√≥.
:::

## `systemctl` (I) {.smaller}

La comanda `systemctl` √©s l'eina principal per interactuar amb **systemd** i gestionar els serveis i unitats del sistema. Algunes de les operacions m√©s comunes inclouen:

| Comanda | Descripci√≥ |
|-----------------------------|-------------------------------------------|
| `systemctl start <unit>` | Inicia una unitat (servei, socket, etc.). |
| `systemctl stop <unit>` | Atura una unitat. |
| `systemctl restart <unit>` | Reinicia una unitat. |
| `systemctl status <unit>` | Mostra l'estat actual d'una unitat. |
| `systemctl enable <unit>` | Habilita una unitat perqu√® s'inici√Ø autom√†ticament en arrencar el sistema. |
| `systemctl disable <unit>` | Deshabilita una unitat perqu√® no s'inici√Ø autom√†ticament. |
| `systemctl is-active <unit>` | Comprova si una unitat est√† activa. |
| `systemctl is-enabled <unit>` | Comprova si una unitat est√† habilitada per arrencar autom√†ticament. |

## `systemctl` (II) {.smaller}

| Comanda | Descripci√≥ |
|-----------------------------|-------------------------------------------|
| `systemctl list-units` | Llista totes les unitats carregades actualment. |
| `systemctl list-unit-files` | Llista tots els fitxers d'unitats disponibles. |
| `systemctl list-dependencies <SERVICE>` | Mostra les depend√®ncies d'una unitat. |
| `systemctl list-jobs` | Mostra les feines pendents i en execuci√≥. |

## Unitat \[`INSTALL`\] {.smaller}

``` bash
[Install]
WantedBy=multi-user.target
Also=sysstat-collect.timer
Also=sysstat-summary.timer
Alias=monitoring.service
```

-   La secci√≥ `[Install]` defineix com s'instal¬∑la i s'inicia una unitat.
-   `WantedBy=multi-user.target` indica que aquesta unitat s'ha d'iniciar quan s'arrenca el sistema en mode multiusuari (runlevel 3).
-   `Also=` permet associar altres unitats que s'han d'iniciar juntament amb aquesta.
-   `Alias=` crea un nom alternatiu per a la unitat, facilitant la seva refer√®ncia.

::: notes
En aquest cas, la unitat s'iniciar√† autom√†ticament en arrencar el sistema en mode multiusuari, i tamb√© s'iniciaran els temporitzadors `sysstat-collect.timer` i `sysstat-summary.timer`. A m√©s, es pot referenciar aquesta unitat amb el nom alternatiu `monitoring.service`.
:::

## Opcions \[`Service`\] (I) {.smaller}

| Opci√≥ | Descripci√≥ |
|--------------------------|----------------------------------------------|
| `Type=` | Defineix el tipus de servei (simple, forking, oneshot, notify, idle). |
| `ExecStart=` | Comanda que s'executa per iniciar el servei. |
| `ExecStop=` | Comanda que s'executa per aturar el servei. |
| `ExecReload=` | Comanda que s'executa per recarregar la configuraci√≥ del servei. |
| `RemainAfterExit=` | Indica si el servei es mant√© actiu despr√©s de finalitzar. |
| `Restart=` | Defineix si el servei s'ha de reiniciar en cas de fallada. |
| `User=` | Defineix l'usuari amb el qual s'executa el servei. |
| `Group=` | Defineix el grup amb el qual s'executa el servei. |

## Opcions \[`Service`\] (II) {.smaller}

| Opci√≥               | Descripci√≥                                           |
|-----------------------|-------------------------------------------------|
| `Environment=`      | Defineix variables d'entorn per al servei.           |
| `WorkingDirectory=` | Defineix el directori de treball del servei.         |
| `PIDFile=`          | Especifica el fitxer que cont√© el PID del servei.    |
| `TimeoutStartSec=`  | Temps d'espera per a l'inici del servei.             |
| `TimeoutStopSec=`   | Temps d'espera per a l'aturada del servei.           |
| `StandardOutput=`   | Defineix on s'envia la sortida est√†ndard del servei. |
| `StandardError=`    | Defineix on s'envia l'error                          |

## Tipus de serveis (I) {.smaller}

-   **Simple**: Per defecte, aquest servei s'inicia immediatament despr√©s del `fork()`. No espera cap senyal de que el servei estigui llest.
-   **Forking**: Aquest tipus de servei √©s per a processos que es bifurquen (fork) i es converteixen en dimonis. El servei es considera actiu despr√©s que el proc√©s pare finalitzi.
-   **Oneshot**: Aquest tipus √©s per a serveis que realitzen una tasca √∫nica i despr√©s finalitzen. Systemd espera que el proc√©s acabi abans de considerar el servei com a actiu.
-   **Notify**: Aquest tipus de servei utilitza el mecanisme de notificaci√≥ de systemd per informar quan est√† llest. El servei ha d'enviar una notificaci√≥ expl√≠cita a systemd.
-   **DBus**: Aquest tipus de servei s'utilitza per a serveis que es comuniquen a trav√©s de DBus. El servei es considera actiu quan el nom del bus apareix al bus de sistema.
-   **Idle**: Aquest tipus de servei s'inicia nom√©s quan el sistema est√† inactiu, √©s a dir, quan no hi ha altres feines pendents.

## Efecte del tipus de servei al runtime {.smaller}

![](../figs/slides/02-booting/service-types.png)

## Script de l'usuari {.smaller}

Un cop s'han carregat tots els serveis i el sistema est√† en marxa, els usuaris poden iniciar sessi√≥ al sistema. Els scripts de l'usuari es troben a la carpeta `/etc/profile.d/` i s'executen quan l'usuari inicia sessi√≥.

-   **/etc/profile**: Cont√© la configuraci√≥ global per a tots els usuaris. S'executa en iniciar sessi√≥ en un entorn de shell.
-   **/etc/bashrc**: Proporciona configuraci√≥ per a shells interactius. S'executa cada vegada que s'inicia una nova sessi√≥ de shell.
-   **\~/.bashrc**: Fitxer de configuraci√≥ espec√≠fic per a l'usuari, que s'executa en iniciar una sessi√≥ de shell interactiu.
-   **\~/.bash_profile**: S'executa quan l'usuari inicia sessi√≥ a la terminal. Normalment, s'utilitza per configurar l'entorn de l'usuari, incloent la configuraci√≥ de l'PATH.
-   **\~/.bash_logout**: S'executa quan l'usuari tanca la sessi√≥ de shell. Aqu√≠ es poden incloure comandes de neteja o tancament.
-   **\~/.bash_history**: Fitxer que emmagatzema l'hist√≤ric de les comandes executades per l'usuari en la sessi√≥ de shell.

## That's all

::::::: columns
:::: {.column width="45%"}
::: {.callout-note title="Take Home Message"}
El proc√©s d'arrencada √©s un proc√©s complex. Els administradors de sistemes han de con√®ixer aquest proc√©s per poder gestionar i solucionar problemes durant l'arrencada del sistema i garantir un sistema segur, estable i eficient.
:::
::::

::: {.column width="5%"}
:::

::: {.column width="50%"}
![](https://static.posters.cz/image/750/posters/looney-tunes-thats-all-folks-i295.jpg){width="70%"}
:::
:::::::