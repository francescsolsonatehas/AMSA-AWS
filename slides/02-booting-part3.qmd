---
title: "Arrencada del sistema (Part 3)"
subtitle: "Unitat 2 路 Administraci贸 i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Forn茅s"
logo: "/figs/corporative/institute.png"
format: 
  revealjs:
    transition: fade
    slide-number: true
    incremental: true 
    chalkboard: false
    css: styles.css
    footer: "Unitat 2 路 Administraci贸 i Manteniment de Sistemes i Aplicacions (AMSA) [](/index.html)</a>"
editor: visual

execute:
  freeze: auto
  echo: false
---

## Etapes de l'arrancada

![](../figs/slides/02-booting/linux-unix-booting-process.png)

## PID 1: init/systemd {.smaller}

Quan s'acaba el proc茅s d'inicialitzaci贸 del sistema en l'espai del kernel i es descomprimeix i executa l'initramfs, es produeix una transici贸 important cap a l'espai d'usuari.

``` bash
exec switch_root /mnt /sbin/init
```

-   El comandament `switch_root` substitueix l'arrel del sistema de fitxers actual (l'initramfs) per la partici贸 arrel real del sistema operatiu.
-   El kernel deixa de gestionar directament els processos i passa el control a un proc茅s en l'espai d'usuari.
-   El proc茅s **PID 1** 茅s el primer proc茅s que s'inicia en l'espai d'usuari i 茅s responsable de la gesti贸 dels processos del sistema operatiu.
-   Tradicionalment, aquest proc茅s era el programa **init**, per貌 en els sistemes moderns, *systemd* ha substitu茂t *init* com a responsable principal de la gesti贸 de processos.

## Funcions de PID 1 {.smaller}

1.  **Gesti贸 de la inicialitzaci贸 del sistema**. Carrega els serveis i dimonis necessaris per al bon funcionament del sistema.
2.  **Gesti贸 dels processos del sistema**. Controla la creaci贸, execuci贸 i finalitzaci贸 dels processos. Si un proc茅s orfe (un proc茅s que perd el seu proc茅s pare) continua en execuci贸, el PID 1 assumeix la seva gesti贸 i, eventualment, la seva terminaci贸.
3.  **Arrel de l'arbre de processos**: Tots els altres processos del sistema pengen d'ell, directament o indirectament. Aix貌 fa que sigui fonamental per a l'estabilitat i la continu茂tat del sistema.
4.  **Apagat i reinici del sistema**: El PID 1 tamb茅 茅s responsable de controlar l'apagat i reinici del sistema, garantint que els processos es tanquin adequadament i que el sistema es desconnecti de manera segura

## Systemd vs SysVinit {.smaller}

El canvi de **SysVinit** a [**Systemd**](https://systemd.io/) en moltes distribucions de Linux va ser motivat per la necessitat de millorar l'efici猫ncia i la gesti贸 dels serveis del sistema.

::::: columns
::: {.column width="45%"}
#### SysVinit

-   **Seq眉encial**: Basat en scripts. *Cada servei dep猫n de l'execuci贸 completa del servei anterior, la qual cosa pot ser lenta*.
-   **Simple**: Cada servei s'inicia amb un script directament llegible i modificable per l'administrador del sistema.
-   **Inflexible**: Dificultat engestionar depend猫ncies. *No permet arrencar serveis en paral路lel ni controlar els processos un cop arrencats*.
:::

::: {.column width="55%"}
#### Systemd

-   **Rendiment**: Capacitat de carregar serveis en paral路lel. Reducci贸 temps d'inici del sistema.
-   **Modularitat**: Els serveis es gestionen a trav茅s d'unitats (*unit files*) que poden especificar depend猫ncies, condicions de reinici automtic,etc.
-   **Cgroups**: Limitar/gestionar els recursos assignats a cada servei.
-   **Monitoratge**: Control i seguiment granular dels serveis amb *journalctl*.
:::
:::::

## Cr铆tiques a Systemd {.smaller}

-   **Complexitat**: Integra m煤ltiples funcionalitats (gesti贸 de serveis, journal, timers, logind, networkd, etc.) en un sol proc茅s. Aix貌 pot augmentar la superf铆cie de fallada i dificultar la depuraci贸.
-   **Trenca amb la filosofia Unix tradicional**
    -   Unix promou eines petites, especialitzades i composables.\
    -   Systemd concentra moltes tasques en un 煤nic sistema de gesti贸.
-   **Depend猫ncia del sistema**: Molts scripts, paquets i eines modernes depenen de systemd, dificultant la compatibilitat amb sistemes alternatius (SysVinit, OpenRC).

::: fragment
#### Debat en la comunitat

-   Els defensors de **systemd** argumenten que simplifica ladministraci贸 de sistemes moderns i ofereix funcions que abans requerien m煤ltiples eines externes.\
-   Els cr铆tics insisteixen en que 茅s massa intrusiu i redueix la flexibilitat per a administradors avan莽ats i entorns m铆nims.\
:::

## Backdoor en XZ Utils (I) {.smaller}

Recents vulnerabilitats en paquets com **xz-utils** han posat en evid猫ncia la complexitat de *Systemd* i com una backdoor ocult pot comprometre gran part de la infraestructura moderna de Linux.

-   El backdoor va ser introdu茂t de manera gradual, comen莽ant amb contribucions sospitoses al projecte **libarchive el 2021**.
-   Durant el 2022, un desenvolupador desconegut, *JiaT75*, va guanyar influ猫ncia dins del projecte **xz-utils**, substituint el contacte del mantenidor original i introduint canvis que van ocultar les vulnerabilitats.
-   El 2023, *JiaT75* va introduir modificacions malicioses a **xz-utils**, aprofitant-les per comprometre sistemes a trav茅s de depend猫ncies amb Systemd.

[**CVE-2024-3094**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-3094): Vulnerabilitat que permet l'execuci贸 de codi malici贸s en el sistema mitjan莽ant un defecte en la descompressi贸 de fitxers **.xz**.

## Backdoor en XZ Utils (II) {.smaller}

Aquesta vulnerabilitat va afectar molts servidors Linux, que van actualitzar **xz-utils** amb la versi贸 compromesa.

-   **liblzma** 茅s una llibreria de compressi贸 que es pot enlla莽ar amb altres programes. Per exemple, **OpenSSH** es pot vincular a **liblzma** per gestionar la descompressi贸 de fitxers de configuraci贸.
-   En sistemes amb **systemd**, **OpenSSH** enlla莽a amb **systemd**, que a la vegada enlla莽a amb **liblzma**. Aix貌 permet a **XZ Utils** controlar indirectament serveis essencials com **sshd**.
-   Mitjan莽ant una backdoor oculta en versions modificades de **xz-utils**, un atacant amb una clau de xifrat pr猫viament establerta podria carregar codi malici贸s en certificats SSH i executar-lo en dispositius compromesos.

::: center-container
Aquests esdeveniments posen de manifest les contrapartides de la complexitat de **Systemd** i com una vulnerabilitat en un paquet aparentment inofensiu com **xz-utils** pot tenir un impacte significatiu en la seguretat del sistema i serveis cr铆tics com **sshd**.
:::

## Executar els Targets o Runlevels {.smaller}

El **PID 1** executa els *targets* de systemd o *runlevels* d'init. Els targets representen un conjunt de serveis i m貌duls que s'executen per a cada estat del sistema. La seva funci贸 茅s definir l'estat del sistema i els serveis que s'han de carregar en aquest estat. La transici贸 entre els *targets* es pot fer manualment amb la comanda `systemctl isolate` o automticament amb la comanda `systemctl set-default`.

::: fragment
-   **default.target**: Apunta a *graphical.target* o *multi-user.target*-
-   **graphical.target**: Defineix un entorn grfic.
-   **multi-user.target**: Proporciona un entorn no grfic, permetent m煤ltiples usuaris al sistema, habitual per a servidors.
-   **rescue.target**: Proporciona un entorn de rescat amb una consola de l铆nia de comandes.
-   **emergency.target**: Ofereix un entorn d'emerg猫ncia que inicialitza el m铆nim de serveis necessaris per a la soluci贸 de problemes.
-   **shutdown.target**: Gestiona l'apagat del sistema.
-   **reboot.target**: Gestiona el reinici del sistema.
:::

## Units de systemd {.smaller}

Els **units** s贸n els fitxers de configuraci贸 de **systemd** que defineixen els serveis, ens permeten gestionar-los i controlar-los.

-   `/etc/systemd/system/`: Fitxers d'unitat personalitzats per l'administrador.
-   `/run/systemd/system/`: Configuraci贸 en temps d'execuci贸, 茅s a dir, afecta nom茅s un arrencada 煤nica.
-   `/usr/lib/systemd/system/`: Configuraci贸 proporcionada per la distribuci贸. A Debian 茅s `/lib/systemd/system/`.

:::{.fragment}
Quan hi ha dos fitxers de configuraci贸 amb el mateix nom, **systemd** carregar nom茅s un des del directori que estigui m茅s alt en la jerarquia. Per exemple, la configuraci贸 a `/etc` sempre sobreescriu la configuraci贸 a `/usr`.
:::

:::{.fragment .center-container}
Despr茅s de canviar la configuraci贸, 茅s necessari recarregar **systemd** amb: `systemctl daemon-reload`.
:::

## Tipus d'unitats {.smaller}

-   **Serveis**: Fitxers que defineixen com s'inicien, s'aturen i es gestionen els serveis. Ex: `/etc/systemd/system/sshd.service` (servei SSH).
-   **Sockets**: Units que gestionen els *sockets* de comunicaci贸 per als serveis.
-   **Devices**: Units que representen dispositius de maquinari.
-   **Mounts**: Units que gestionen els punts de muntatge del sistema de fitxers.
-   **Paths**: Units que monitoren els canvis en fitxers o directoris espec铆fics.
-   **Timers**: Units que planifiquen tasques per a la seva execuci贸 en moments espec铆fics.
-   **Targets**: Units que agrupen altres units per a l'arrencada d'estats del sistema.

## Targets i Systemd {.smaller}

::: center-container
![](../figs/slides/02-booting/systemd.png)
:::

## Exemple de fitxer d'unitat {.smaller}

::: columns
::: {.column width="50%"}
``` bash
[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=network.target
[Service]
ExecStart=/usr/sbin/cupsd -l
Type=notify
[Install]
Also=cups.socket cups.path
WantedBy=printer.target
```
:::
::: {.column width="50%"}

- CUPS (Common Unix Printing System) 茅s un sistema d'impressi贸 utilitzat en sistemes Unix i Linux.
- T茅 una depend猫ncia amb la xarxa (`After=network.target`), ja que sovint es connecta a impressores de xarxa.
:::
:::

- S'inicia amb el comandament `/usr/sbin/cupsd -l`, que posa en marxa el servei d'impressi贸.
- Es configura per iniciar-se automticament quan s'arrenca el sistema (`WantedBy=printer.target`).
- `Cups.socket` 茅s una unitat de tipus *socket* que permet a CUPS escoltar connexions entrants per a serveis d'impressi贸.
- `Cups.path` 茅s una unitat de tipus *path* que monitoritza canvis en fitxers o directoris relacionats amb la configuraci贸 d'impressi贸.

::: notes
Aquest fitxer defineix el servei **CUPS** (Common Unix Printing System) 茅s un sistema que t茅 una depen猫ncia amb la xarxa (`After=network.target`), s'inicia amb el comandament `/usr/sbin/cupsd -l` i es configura per iniciar-se automticament quan s'arrenca el sistema (`WantedBy=printer.target`). Printer.target 茅s un *target* que agrupa serveis relacionats amb la impressi贸. Cups.socket i cups.path s贸n altres unitats que tamb茅 s'inicien quan s'inicia el servei CUPS ja que estan lligades a aquest servei. El tipus de servei 茅s `notify`, el qual indica que el servei enviar una notificaci贸 a systemd quan estigui llest.
:::

## Depend猫ncies entre unitats (I) {.smaller}

Les unitats s贸n objectes gestionats per **systemd**. Les depend猫ncies s贸n associacions entre elles. Cada tipus d'unitat t茅 algunes depend猫ncies per defecte (a menys que s'especifiqui el contrari).

#### Relacionals

-   **Requires**: Indica que una unitat dep猫n d'una altra unitat per a la seva activaci贸. Si la unitat requerida no est activa, la unitat que la requereix no s'activar.
-   **Wants**: Similar a **Requires**, per貌 no 茅s tan estricte. Si la unitat requerida no est activa, la unitat que la vol no es bloquejar.
-   **BindsTo**: Similar a **Requires**, per貌 si la unitat requerida es det茅, la unitat que la vincula tamb茅 es detindr.
-   **PartOf**: Indica que una unitat 茅s part d'una altra unitat. Si la unitat pare es det茅, la unitat fill tamb茅 es detindr.
-   **Conflicts**: Indica que dues unitats no poden estar actives al mateix temps. Si una unitat s'activa, l'altra es detindr automticament.

## Depend猫ncies entre unitats (II) {.smaller}

#### Ordenaci贸

-   **After**: Indica que una unitat s'ha d'iniciar despr茅s d'una altra unitat. No crea una depend猫ncia estricta, nom茅s defineix l'ordre d'inici.
-   **Before**: Indica que una unitat s'ha d'iniciar abans d'una altra unitat. No crea una depend猫ncia estricta, nom茅s defineix l'ordre d'inici.


## Transaccions a systemd (I) {.smaller}

Cada vegada que lusuari o un servei sol路licita una acci贸 (per exemple, iniciar o aturar un servei), es crea una **transacci贸** que gestiona lexecuci贸 ordenada de les unitats afectades.

1.  **Creaci贸 de feines (jobs)**
    -   Es crea una feina per a la unitat sol路licitada.\
    -   Safegeixen recursivament les feines corresponents a totes les **depend猫ncies** de la unitat.
2.  **Minimitzaci贸 de la transacci贸**
    -   Eliminar feines duplicades o redundants.\
    -   Eliminar feines que no estiguin referenciades per cap altre job (ancoratge).
3.  **Resoluci贸 de cicles de depend猫ncies**
    -   Detectar **loops** en el grfic de depend猫ncies.\
    -   Trencar-los eliminant feines problemtiques per evitar deadlocks.

## Transaccions a systemd (I) {.smaller}

4.  **Fusi贸 i optimitzaci贸 de feines**
    -   Fusionar feines similars per reduir el nombre doperacions.\
    -   Prioritzar feines ja existents a la cua.
5.  **Enviament i execuci贸**
    -   Afegir les feines a la **cua de jobs** de systemd.\
    -   Executar les feines segons la depend猫ncia i lordre optimitzat.

::: fragment
Garanteix que les unitats es gestionin de manera at貌mica i ordenada, permetent a systemd paral路lelitzar serveis mentre respecta les depend猫ncies.
:::

::: notes
-   Les **transaccions** garanteixen que les unitats es gestionin de manera at貌mica i ordenada.\
-   Aix貌 permet a systemd **paral路lelitzar serveis** mentre respecta les depend猫ncies.\
-   Cadascuna de les feines cont茅 informaci贸 sobre la unitat, la seva acci贸 (`start`, `stop`, `reload`) i les condicions dexecuci贸.
:::

## `systemctl` (I) {.smaller}

La comanda `systemctl` 茅s l'eina principal per interactuar amb **systemd** i gestionar els serveis i unitats del sistema. Algunes de les operacions m茅s comunes inclouen:

| Comanda | Descripci贸 |
|-----------------------------|-------------------------------------------|
| `systemctl start <unit>` | Inicia una unitat (servei, socket, etc.). |
| `systemctl stop <unit>` | Atura una unitat. |
| `systemctl restart <unit>` | Reinicia una unitat. |
| `systemctl status <unit>` | Mostra l'estat actual d'una unitat. |
| `systemctl enable <unit>` | Habilita una unitat perqu猫 s'inici茂 automticament en arrencar el sistema. |
| `systemctl disable <unit>` | Deshabilita una unitat perqu猫 no s'inici茂 automticament. |
| `systemctl is-active <unit>` | Comprova si una unitat est activa. |
| `systemctl is-enabled <unit>` | Comprova si una unitat est habilitada per arrencar automticament. |

## `systemctl` (II) {.smaller}

| Comanda | Descripci贸 |
|-----------------------------|-------------------------------------------|
| `systemctl list-units` | Llista totes les unitats carregades actualment. |
| `systemctl list-unit-files` | Llista tots els fitxers d'unitats disponibles. |
| `systemctl list-dependencies <SERVICE>` | Mostra les depend猫ncies d'una unitat. |
| `systemctl list-jobs` | Mostra les feines pendents i en execuci贸. |

## Unitat \[`INSTALL`\] {.smaller}

``` bash
[Install]
WantedBy=multi-user.target
Also=sysstat-collect.timer
Also=sysstat-summary.timer
Alias=monitoring.service
```

-   La secci贸 `[Install]` defineix com s'instal路la i s'inicia una unitat.
-   `WantedBy=multi-user.target` indica que aquesta unitat s'ha d'iniciar quan s'arrenca el sistema en mode multiusuari (runlevel 3).
-   `Also=` permet associar altres unitats que s'han d'iniciar juntament amb aquesta.
-   `Alias=` crea un nom alternatiu per a la unitat, facilitant la seva refer猫ncia.

::: notes
En aquest cas, la unitat s'iniciar automticament en arrencar el sistema en mode multiusuari, i tamb茅 s'iniciaran els temporitzadors `sysstat-collect.timer` i `sysstat-summary.timer`. A m茅s, es pot referenciar aquesta unitat amb el nom alternatiu `monitoring.service`.
:::

## Opcions \[`Service`\] (I) {.smaller}

| Opci贸 | Descripci贸 |
|--------------------------|----------------------------------------------|
| `Type=` | Defineix el tipus de servei (simple, forking, oneshot, notify, idle). |
| `ExecStart=` | Comanda que s'executa per iniciar el servei. |
| `ExecStop=` | Comanda que s'executa per aturar el servei. |
| `ExecReload=` | Comanda que s'executa per recarregar la configuraci贸 del servei. |
| `RemainAfterExit=` | Indica si el servei es mant茅 actiu despr茅s de finalitzar. |
| `Restart=` | Defineix si el servei s'ha de reiniciar en cas de fallada. |
| `User=` | Defineix l'usuari amb el qual s'executa el servei. |
| `Group=` | Defineix el grup amb el qual s'executa el servei. |

## Opcions \[`Service`\] (II) {.smaller}

| Opci贸               | Descripci贸                                           |
|-----------------------|-------------------------------------------------|
| `Environment=`      | Defineix variables d'entorn per al servei.           |
| `WorkingDirectory=` | Defineix el directori de treball del servei.         |
| `PIDFile=`          | Especifica el fitxer que cont茅 el PID del servei.    |
| `TimeoutStartSec=`  | Temps d'espera per a l'inici del servei.             |
| `TimeoutStopSec=`   | Temps d'espera per a l'aturada del servei.           |
| `StandardOutput=`   | Defineix on s'envia la sortida estndard del servei. |
| `StandardError=`    | Defineix on s'envia l'error                          |

## Tipus de serveis (I) {.smaller}

-   **Simple**: Per defecte, aquest servei s'inicia immediatament despr茅s del `fork()`. No espera cap senyal de que el servei estigui llest.
-   **Forking**: Aquest tipus de servei 茅s per a processos que es bifurquen (fork) i es converteixen en dimonis. El servei es considera actiu despr茅s que el proc茅s pare finalitzi.
-   **Oneshot**: Aquest tipus 茅s per a serveis que realitzen una tasca 煤nica i despr茅s finalitzen. Systemd espera que el proc茅s acabi abans de considerar el servei com a actiu.
-   **Notify**: Aquest tipus de servei utilitza el mecanisme de notificaci贸 de systemd per informar quan est llest. El servei ha d'enviar una notificaci贸 expl铆cita a systemd.
-   **DBus**: Aquest tipus de servei s'utilitza per a serveis que es comuniquen a trav茅s de DBus. El servei es considera actiu quan el nom del bus apareix al bus de sistema.
-   **Idle**: Aquest tipus de servei s'inicia nom茅s quan el sistema est inactiu, 茅s a dir, quan no hi ha altres feines pendents.

## Efecte del tipus de servei al runtime {.smaller}

![](../figs/slides/02-booting/service-types.png)

## Script de l'usuari {.smaller}

Un cop s'han carregat tots els serveis i el sistema est en marxa, els usuaris poden iniciar sessi贸 al sistema. Els scripts de l'usuari es troben a la carpeta `/etc/profile.d/` i s'executen quan l'usuari inicia sessi贸.

-   **/etc/profile**: Cont茅 la configuraci贸 global per a tots els usuaris. S'executa en iniciar sessi贸 en un entorn de shell.
-   **/etc/bashrc**: Proporciona configuraci贸 per a shells interactius. S'executa cada vegada que s'inicia una nova sessi贸 de shell.
-   **\~/.bashrc**: Fitxer de configuraci贸 espec铆fic per a l'usuari, que s'executa en iniciar una sessi贸 de shell interactiu.
-   **\~/.bash_profile**: S'executa quan l'usuari inicia sessi贸 a la terminal. Normalment, s'utilitza per configurar l'entorn de l'usuari, incloent la configuraci贸 de l'PATH.
-   **\~/.bash_logout**: S'executa quan l'usuari tanca la sessi贸 de shell. Aqu铆 es poden incloure comandes de neteja o tancament.
-   **\~/.bash_history**: Fitxer que emmagatzema l'hist貌ric de les comandes executades per l'usuari en la sessi贸 de shell.

## Exercicis Propostas

-   [Anlisi del proc茅s d'arrencada amb systemd](../exercises/02-booting/06-ex-week4.qmd)
-   [Servei de C貌pia de Seguretat Automtica amb systemd](../exercises/02-booting/07-ex-week4.qmd)
-   Discussi贸: [**Secure Boot 茅s realment segur?**](https://github.com/amsa-gei-udl-2526-105013/course/issues/3): Cerca not铆cies recents sobre Secure Boot i comparteix-les al f貌rum del curs. Debatiu sobre avantatges, desavantatges, vulnerabilitats conegudes i experi猫ncies personals.
-   [Prctica 01: Snapshots i restauraci贸 amb systemd i initramfs](../projects/01-project/01-project.qmd)

## That's all

::::::: columns
:::: {.column width="45%"}
::: {.callout-note title="Take Home Message"}
El proc茅s d'arrencada 茅s un proc茅s complex. Els administradors de sistemes han de con猫ixer aquest proc茅s per poder gestionar i solucionar problemes durant l'arrencada del sistema i garantir un sistema segur, estable i eficient.
:::
::::

::: {.column width="5%"}
:::

::: {.column width="50%"}
![](https://static.posters.cz/image/750/posters/looney-tunes-thats-all-folks-i295.jpg){width="70%"}
:::
:::::::