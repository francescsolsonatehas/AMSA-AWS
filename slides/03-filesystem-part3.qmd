---
title: "Sistema de fitxers (III)"
subtitle: "Unitat 3 路 Administraci贸 i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Forn茅s"
logo: "/figs/corporative/institute.png"
format: 
  revealjs:
    transition: fade
    slide-number: true
    incremental: true 
    chalkboard: false
    css: styles.css
    footer: "Unitat 3 路 Administraci贸 i Manteniment de Sistemes i Aplicacions (AMSA) [](/index.html)</a>"
editor: visual

execute:
  freeze: auto
  echo: false
---

# Introducci贸 a LVM

## Contextutalitzaci贸 {.smaller}

Imaginem que disposem dun servidor amb un 煤nic disc dur, dividit en quatre particions. Aquestes particions s贸n:

``` bash
Filesystem      Size  Used   Avail  Use%   Mounted on
/dev/sda1       20G   5.5G   14G    29%    /
/dev/sda2       10G   10G    0G     100%   /home
/dev/sda3       5G    1G     4G     20%    /var
/dev/sda4       5G    1G     4G     20%    /tmp
```

::: fragment
Qu猫 passa si la partici贸 `/home` somple i la resta de particions tenen espai lliure?
:::

::: fragment
La soluci贸 tradicional seria redimensionar les particions per alliberar espai per a `/home`.
:::

::: fragment
★ Aix貌 implica complexitat i possibilitat d'errors.
:::

::: fragment
Per tant, necessitem una soluci贸 m茅s **flexible** que ens permeti redimensionar les particions sense haver de moure dades i en temps real.
:::

::: notes
Una situaci贸 t铆pica quan administrem servidors 茅s que una partici贸 s'ompli i la resta de particions tinguin espai lliure. En aquest cas, la partici贸 `/home` s'ha omplert i la resta de particions tenen espai lliure. Per solucionar aquest problema, haur铆em de redimensionar les particions per alliberar espai per a `/home`. Aix貌 implica complexitat i possibilitat d'errors. Per tant, necessitem una soluci贸 m茅s flexible. Que ens permeti redimensionar les particions sense haver de moure dades i en temps real.
:::

## Introducci贸 a LVM {.smaller}

**Logical Volume Manager (LVM)** 茅s un sistema de gesti贸 de discos que permet als administradors *gestionar lespai de disc de manera m茅s flexible* que amb les particions tradicionals, resolent problemes comuns.

::: fragment
En la situaci贸 anterior, LVM ens permetria en temps real i sense aturar el sistema:

-   **Redimensionar** les particions `/var` i `/tmp` per *alliberar espai* per a `/home`.
-   **Redimensionar** la partici贸 `/home` a partir de l'espai alliberat.
:::

::: fragment
o b茅 tamb茅 ens permetria:

-   **Afegir** un nou disc dur f铆sic al servidor.
-   **Utilitzar** aquest disc dur per a **augmentar l'espai** de la partici贸 `/home`.
:::

::: {.fragment .center-container}
**Crear**, **eliminar**, **redimensionar** i **moure** particions en temps real.
:::

## Caracter铆stiques de LVM {.smaller}

-   **Aprovisionament**: Permet *combinar la capacitat* de diferents dispositius f铆sics per crear un 煤nic o m煤ltiples volums v铆rtuals. [Per exemple, es poden combinar quatre discs durs de 1TB per crear un 煤nic volum virtual de 4TB.]{.fragment}

-   **Elasticitat**: Permet *augmentar o disminuir* l'espai assignat a un volum virtual, sense necessitat de reiniciar el sistema. [Per exemple, si un volum virtual s'est quedant sense espai, es pot augmentar la seva mida o reduir-la.]{.fragment}

-   **Escalabilitat**: Permet *afegir o eliminar* dispositius f铆sics al grup de volums per augmentar o disminuir l'espai d'emmagatzematge segons les necessitats. [Per exemple, si es necessita m茅s espai d'emmagatzematge, es poden afegir nous discs f铆sics.]{.fragment}

-   **Resili猫ncia**: Atorga la capacitat de crear c貌pies de seguretat de les dades per protegir-les davant possibles errors o danys. [Per exemple, es poden crear snapshots o miralls (mirroring).]{.fragment}

## Components de LVM {.smaller}

::::: columns
::: {.column width="45%"}
-   **PV (Physical Volume)**: Dispositiu f铆sic que es pot utilitzar per emmagatzemar dades. Per exemple, un disc dur, una partici贸, un dispositiu RAID, etc.

-   **LV (Logical Volume)**: Bloc de dades que es pot utilitzar per emmagatzemar dades i contenir el seu propi sistema de fitxers. Equivalent a una partici贸 de disc en un sistema sense LVM.

-   **VG (Volume Group)**: Agrupaci贸 de LVs i PVs en una unitat administrativa. Un VG pot contenir diversos PVs i LVs.
:::

::: {.column width="55%"}
![](../figs/slides/03-lvm/anatomia.png)
:::
:::::

## Mapeig i Extensions {.smaller}

::::: columns
::: {.column width="55%"}
#### PE (Physical Extent)

s la unitat m铆nima d'emmagatzematge que es pot assignar a un PV. [Normalment, un PE t茅 una mida de 4MB.]{.fragment}

#### LE (Logical Extent)

s la unitat m铆nima d'emmagatzematge que es pot assignar a un LV. [Per exemple, si un LE t茅 una mida de 4MB, un LV de 1GB tindr 256 LE.]{.fragment}

#### Observacions

-   Cada VG sencarrega de gestionar lemmagatzematge f铆sic (physical extents) mappejant-lo en emmagatzematge l貌gic (logical extents).
-   Els PE i LE tenen la mateixa mida per貌 s贸n diferents en funci贸 de l'estrategia de mapeig.
:::

::: {.column width="35%"}
![](../figs/slides/03-lvm/mapping1.png)
:::
:::::

## Estrat猫gies de Mapeig {.smaller}

::::: columns
::: {.column width="50%"}
![](../figs/slides/03-lvm/lineal.png)
:::

::: {.column width="50%"}
![](../figs/slides/03-lvm/striped.png)
:::
:::::

## Exemple i Consideracions {.smaller}

::::: columns
::: {.column width="60%"}
![](../figs/slides/03-lvm/mapping3.png)
:::

::: {.column width="30%"}
-   Es poden utilitzar dispositius de diferents mides i velocitats.

-   Un PV nom茅s pot pertnyer a un VG.

-   Un LV nom茅s pot pertnyer a un VG.

-   Un VG pot contenir diversos PVs i LVs.

-   Les funcions de mirror i snapshot requereixen m茅s d'un PV.
:::
:::::

## Snapshots {.smaller}

Els **snapshots** s贸n c貌pies instantnies d'un LV en un moment concret. El seu funcionament 茅s **incremental**: nom茅s es copien les dades que han canviat des de l'煤ltim snapshot.

#### Per qu猫 s贸n 煤tils?

-   **C貌pies de seguretat**: Realitzar c貌pies de seguretat de les dades sense aturar el sistema.
-   **Restauraci贸**: Restaurar les dades a un estat anterior.
-   **Tests**: Provar canvis en el sistema sense afectar les dades originals.

#### Compte!

Les **instantnies ocupen espai en el VG**. Per tant, si es crea una instantnia i despr茅s es sobreescriu completament el LV original, linstantnia hauria de ser almenys tan gran com el LV original per poder emmagatzemar tots els canvis.

# LVM a Linux

## Paquet `lvm2` {.smaller}

En la majoria de les distribucions de Linux, el paquet `lvm2` permet la creaci贸 i gesti贸 de dispositius LVM.

::::: columns
::: {.column width="50%"}
#### Distribucions basades en Red Hat

``` bash
dnf search lvm2
dnf install lvm2 -y
```
:::

::: {.column width="50%"}
#### Distribucions basades en Debian

``` bash
apt search lvm2
apt install lvm2 -y
```
:::
:::::

::: center-container
El funcionament del paquet `lvm2` 茅s similar en totes les distribucions de Linux. Per tant, les instruccions d'煤s s贸n similars i no importa la distribuci贸 que s'utilitzeu.
:::

## Creaci贸 de PVs {.smaller}

``` bash
pvcreate PV [opcions]
```

On: PV pot ser un disc dur, una partici贸, un dispositiu RAID, etc.

-   **--dataalignment mida\[Unitat\]**: Alinia el comen莽ament del PV.
-   **--dataalignmentoffset mida\[Unitat\]**: Offset per modificar alineaci贸 de dades.
-   **--labelsector sector**: Per defecte, el PV est etiquetat amb un identificador LVM2 al seu segon sector (sector 1). Aix貌 us permet utilitzar un sector diferent a prop de linici del disc (entre 0 i 3).
-   **--metadatasize mida\[Unitat\]**: Mida de les metadades.
-   **--setphysicalvolumesize mida\[Unitat\]**: Mida dels PE.
-   **--longhelp**: Mostra totes les opcions (semblant a `man pvcreate`).
-   **--uuid uuid**: Assigna un UUID al PV.

::: center
**s tradicional**: `pvcreate /dev/sdb` sense opcions.
:::

## Organitzaci贸 interna dels PVs {.smaller}

::: {.center-container}
![](../figs/slides/03-lvm/PV-org-int.png)
:::

## Exemples de l'煤s de `pvcreate` {.smaller}

-   Inicialitzaci贸 a partir d'un disc dur amb alineaci贸 de dades de 1MB comen莽ant des del sector 7.

::: {.fragment}
``` bash
pvcreate --dataalignment 1M --dataalignmentoffset 7s /dev/sdb
```
:::

-   Inicialitzaci贸 a partir d'una partici贸 amb un UUID espec铆fic.

::: {.fragment}
``` bash
pvcreate --uuid "my-pv-uuid" /dev/sdb1
```
:::

-   Inicialitzaci贸 a partir d'un raid amb mida de metadades 128MB i 8MB per PE (enlloc de 4MB).

::: {.fragment}
``` bash
pvcreate --setphysicalvolumesize 8M --metadatasize 128M /dev/md0
```
:::

## Modificar PVs amb `pvchange` {.smaller}

``` bash
pvchange [opcions] PV
```

-   **--all**: Aplica l'acci贸 a tots els PVs (no cal especificar el PV).
-   **--addtag tag**: Afegeix una etiqueta al PV.
-   **--deltag tag**: Elimina una etiqueta del PV.
-   **--longhelp**: Mostra totes les opcions (semblant a `man pvcreate`).
-   **--uuid uuid**: Assigna un UUID al PV.
-   **--allocatable y/n**: Activa o desactiva l'assignaci贸 de PE al PV.
-   **--autobackup y/n**: Activa o desactiva la c貌pia de seguretat automtica de les metadades.

## Redimensionar PVs amb `pvresize` {.smaller}

``` bash
pvresize [opcions] PV
```
-   **--setphysicalvolumesize mida\[Unitat\]**: Redimensiona el PV.
-   **--longhelp**: Mostra totes les opcions (semblant a `man pvresize`).

::: {.fragment}
#### Consideracions prctiques

1.  `pvresize` redimensiona el PV, per貌 no redimensiona les particions o els sistemes de fitxers que cont茅. Haurs de fer aix貌 manualment si 茅s necessari.

2.  `pvresize` refusar reduir un PV si t茅 extensiones assignades m茅s enll del nou final. Haurs de moure o eliminar aquestes extensions primer.

3.  `pvresize` permet redimensionar un PV encara que estigui incl貌s en un VG amb LVs actius.
:::

## Exemples `pvresize` {.smaller}

-   Expandir un PV despr茅s d'ampliar la partici贸 per utilitzar tot el nou espai disponible.

::: {.fragment}
``` bash
pvresize /dev/sdb1
```
:::

-   Reduir un PV abans de reduir la partici贸 (assegurar-se que la mida del PV 茅s adequada per a la nova mida de la partici贸).

::: {.fragment}
``` bash
pvresize --setphysicalvolumesize 40G /dev/sdb1
```
:::

## Eliminar PVs amb `pvremove` {.smaller}

``` bash
pvremove PV
# Podeu obtenir la llista d'opcions amb pvremove --longhelp 
# o b茅 pvremove --help
```

-   `pvremove` elimina totes les metadades del PV, per貌 no elimina les dades.
-   `pvremove` no permet eliminar PVs que estiguin en 煤s. Haurs de moure o eliminar les extensions primer.
-   `pvremove` no permet eliminar PVs que formin part d'un VG. Haurs de treure el PV del VG primer.

::: {.center-container .fragment}
Per eliminar les dades del PV, haurs de sobreescriure el PV amb zeros `dd if=/dev/zero of=PV bs=1M count=1` o b茅 formatejar el dispositiu.
:::

## Obtenir informaci贸 `pvs` {.smaller}

``` bash
pvs [opcions]
```

-   **--allpvs**: Mostra tots els PVs, inclosos els PVs inactius.
-   **--all**: Mostra tots els dispositius que no han estat inicialitzats com a PVs.
-   **--noheadings**: No mostra la cap莽alera (bona combinaci贸 amb `grep`).
-   **--devices PV**: Restringeix la sortida als PVs especificats.
-   **--options String**: Permet seleccionar les columnes a mostrar. Per a m茅s informaci贸, consulteu `pvs -o help`.
-   **--longhelp**: Mostra totes les opcions (semblant a `man pvs`).

::: {.fragment}
Altres opcions per a visualitzar informaci贸n s贸n: `pvdisplay` i `pvscan`. La principal difer猫ncia 茅s que `pvdisplay` mostra la informaci贸 de tots els PVs, mentre que `pvscan` escaneja tots els dispositius per trobar PVs.
:::

## Inicialitzaci贸 de VGs {.smaller}

``` bash
vgcreate VG PV [opcions]
```

-   **--clustered y/n**: Activa o desactiva el VG per a l'煤s en un cl煤ster.
-   **--maxlogicalvolumes nombre**: N煤mero mxim de LVs que es poden crear en el VG.
-   **--maxphysicalvolumes nombre**: N煤mero mxim de PVs que es poden afegir al VG.
-   **--physicalextentsize mida\[Unitat\]**: Mida dels PE.
-   **--metadatasize mida\[Unitat\]**: Mida de les metadades.
-   **--alloc \[contiguous\|cling\|normal\|anywhere\]**: Estrat猫gia d'assignaci贸 de PE.
-   **--longhelp**: Mostra totes les opcions (semblant a `man vgcreate`).

::: fragment
Quan *un VG s'inicialitza a partir d'un PV, els valors de la mida de les metadades, comen莽ament dels PE,... es prenen del PV*, encara que s'hagin especificat opcions diferents amb `vgcreate`. ★ si voleu canviar-ho, `pvremove`. I despr茅s `vgcreate` amb les opcions desitjades.
:::

::: notes
-   vgcreate incialitza el PV en cas que no estigui inicialitzat.
:::

## Augmentar o Reduir VGs amb `vgextend` i `vgreduce` {.smaller}

``` bash
vgextend VG PV [opcions] # Afegir un PV o una llista de PVs a un VG
vgreduce VG PV [opcions] # Treure un PV o una llista de PVs d'un VG
```

-   `vgextend` permet afegir PVs no inicialitzats. En aquest cas, `vgextend` inicialitzar els PVs amb les opcions especificades de `--labelsector`, `--metadatasize`, `--metadataignore`, `--pvmetadatacopies`, `--dataalignment`, `--dataalignmentoffset`.

-   `vgreduce` detecta que un o m茅s PVs estan perduts, necessita `vgreduce --removemissing` per fer que les metadades del VG siguin consistents de nou.

## Altres operacions amb VGs {.smaller}

-   Modificar les propietats d'un VG

::: fragment
``` bash
vgchange [opcions] VG
```
:::

-   Eliminar un VG

::: fragment
``` bash
vgremove VG
```
:::

-   Mostrar informaci贸 detallada d'un VG

::: fragment
``` bash
vgs
vgdisplay VG
vgscan
```
:::

::: {.center-container .fragment}
Totes aquestes comandes tenen opcions similars a les ja vistes per a `pvchange`, `pvremove`, `pvs`, `pvdisplay` i `pvscan`. Per a m茅s informaci贸, consulteu el manual de cada comanda.
:::

## Inicialitzaci贸 de LVs {.smaller}

``` bash
lvcreate LV VG [opcions]
```

-   **-n\|--name nom**: Nom del LV.
-   **-L\|--size mida\[Unitat\]**: Mida del LV en unitats com MiB,GiB,TiB,....
-   **-l\|--extents nombre**: Defineix com un % del VG o b茅 com un nombre enter.
-   **-i\|--stripes nombre**: Defineix el nombre de stripes a utilitzar.
-   **-I\|--stripesize mida\[Unitat\]**: Defineix la mida de les stripes.
-   **-m\|--mirrors nombre**: Defineix el nombre de miralls a utilitzar.
-   **-s\|--snapshot**: Crea un snapshot del LV.
-   **-c\|--chunksize mida\[Unitat\]**: Defineix la mida dels chunks.
-   **-C\|--contiguous y/n**: Activa o desactiva l'assignaci贸 de PE contigus.
-   **-p\|--permission r\|rw**: Defineix els permisos del LV.
-   **-t\|--thinpool VG**: Crea un thin pool LV.
-   **--longhelp**: Mostra totes les opcions (semblant a `man lvcreate`).

## Consideracions prctiques sobre `lvcreate` (I) {.smaller}

-   `lvcreate` crea un nou LV en un VG. ★ Assigna extensions l貌giques a les extensions f铆siques lliures del VG.

::: {.fragment .center-container}
**Qu猫 passaria si no hi ha prou espai lliure al VG?** Haur铆em d'ampliar el VG amb altres PVs (`vgextend`), o b茅 reduir o eliminar els LV existents (`lvremove`, `lvreduce`). Aquesta 茅s una consideraci贸 important a tenir en compte quan es treballa amb grans volums de dades.
:::

-   `lvcreate` permet especificar quins PVs utilitzar un nou LV. ★ `lvcreate` assignar extensi贸 f铆siques nom茅s dels PVs especificats. Aix貌 pot ser 煤til quan es vol controlar l'assignaci贸 d'espai en un sistema amb m煤ltiples PVs.

-   `lvcreate` tamb茅 pot crear LV RAID especificant un tipus de LV en crear el LV. ★ Diferents nivells de RAID requereixen diferents nombres de PVs 煤nics en el VG per a l'assignaci贸. Aix貌 pot ser 煤til per a la redundncia de dades i la tolerncia a fallades.

## Consideracions prctiques sobre `lvcreate` (II) {.smaller}

-   `lvcreate` tamb茅 pot crear thin pools i cache pools. ★ Aquests no s贸n utilitzables com a dispositius de bloc estndard, per貌 els noms dels LV actuen com a refer猫ncies. Aquests pools ens poden interesar en servidors on molts usuaris comparteixen recursos d'emmagatzematge i es volen limitar els recursos d'emmagatzematge per usuari.

-   `lvcreate` tamb茅 pot crear LV thin i LV VDO. ★ Aquests es creen amb una mida virtual en lloc d'una mida f铆sica. Permeten sobreprovisionament i compressi贸 de dades. ★ Tots el usuaris tenen dret a m茅s espai del que realment tenen.

-   Podeu utilitzar qualsevol `--size` o `--extents` per especificar la mida del LV.

-   En cas de no especificar un nom, es generar un nom de LV amb el prefix **lvol** i un sufix num猫ric 煤nic. Aix貌 pot ser 煤til quan es vol crear m煤ltiples LVs de forma rpida i eficient.

## Altres operacions amb LVs {.smaller}

Els LVs ens permeten les mateixes operacions amb opcions similars a les ja vistes per a PVs i VGs:

-   Mostrar informaci贸 detallada d'un LV: `lvs`, `lvdisplay`, `lvscan`.
-   Modificar les propietats d'un LV: `lvchange`.
-   Eliminar un LV: `lvremove`.
-   Incrementar o disminuir la mida d'un LV: `lvextend`, `lvreduce`.

::: {.center-container .fragment}
Per a m茅s informaci贸, consulteu el manual de cada comanda o b茅 executeu `comanda --help`.
:::

# Casos Prctics

## Cas Prctic 01: LVM i BootLoaders {.smaller}

Durant la realitzaci贸 d'una instal路laci贸 d'un sistema operatiu, s'ha de decidir si utilitzar LVM per a la partici贸 `/boot` o `/boot/efi`. Creus que 茅s recomanable utilitzar LVM per a aquestes particions?

::: fragment
**No**, no 茅s recomanable utilitzar LVM per a la partici贸 `/boot` o `/boot/efi`. Els BootLoaders com GRUB no poden llegir els sistemes de fitxers LVM. Per tant, 茅s millor utilitzar particions tradicionals per a `/boot` i `/boot/efi`.
:::

::: fragment
Durant el proc茅s d'arrancada, el bootloader carrega el kernel i la imatge initramfs des de la partici贸 `/boot`. Si aquesta partici贸 est en un sistema de fitxers LVM, el bootloader no podr llegir-la i no podr carregar el sistema operatiu.
:::

## Cas Prctic 02: Dispositiu compartit (USB) {.smaller}

Assumeix que tens un *disc dur extern de 2TB* i vols fer-ho servir per guardar c貌pies de seguretat de dos usuaris. *El disc es connecta per usb f铆sicament als dos dispositius*. **L'usuari 1 necessita 1TB** i **l'usuari 2 necessita 500GB**. Assumeix que [l'usuari 1 utilitza Windows]{.alert} i [l'usuari 2 utilitza Linux]{.alert}. Recomanaries utilitzar LVM per aquest cas d'煤s?

::: fragment
**No**, LVM 茅s una tecnologia espec铆fica de Linux i no 茅s compatible amb Windows. Per tant, no 茅s recomanable utilitzar LVM per aquest cas d'煤s. En aquest cas, seria millor utilitzar particions tradicionals per a cada usuari. Podeu crear dues particions: una de 1TB formatada amb NTFS per a l'usuari 1 (Windows) i una altra de 500GB formatada amb ext4 per a l'usuari 2 (Linux). La resta de l'espai es podria deixar sense particionar o crear una partici贸 compartida si es desitja.
:::

## Cas Prctic 02: Dispositiu compartit (NAS) {.smaller}

Assumeix ara que el *disc dur extern s'utilitza en un NAS* on [s'ofereix emmagatzematge compartit per a tots els usuaris en xarxa local]{.alert}. En aquest cas, recomanaries utilitzar LVM per aquest cas d'煤s?

::: fragment
**S铆**, en aquest cas, LVM pot ser una bona opci贸 per a la gesti贸 de l'espai d'emmagatzematge compartit. LVM permet crear volums l貌gics que es poden redimensionar en temps real. Cada usuari podria tenir el seu LV per emmagatzemar les seves dades. Com el NAS 茅s un servidor de xarxa, els usuaris podrien accedir als seus LVs a trav茅s de la xarxa; independentment del sistema operatiu que utilitzin els usuaris en els seus dispositius.
:::

## Cas Prctic 03: Servidor de Base de Dades {.smaller}

Considerant que hem de configurar un [servidor de base de dades]{.alert} amb **4 discos durs de 1TB cadascun**. Quins avantatges i desavantatges tindria la implementaci贸 de LVM en aquest context?

::: fragment
LVM permet la creaci贸 de volums l貌gics que es poden distribuir en diversos discos f铆sics, cosa que pot *millorar el rendiment mitjan莽ant el striping*. ★ Aquesta configuraci贸 pot ser 煤til per a bases de dades que requereixen un alt rendiment d'E/S. Per貌, tamb茅 augmenta *la complexitat i pot induir a overheads addicionals dels Volums L貌gics*.
:::

::: fragment
A m茅s, LVM admet instantnies, que poden ser 煤tils per a les *c貌pies de seguretat i la recuperaci贸 de les dades*. Ara b茅, si les instantnies es guarden en el mateix disc f铆sic que la base de dades, i aquest disc falla, es perdran tant la base de dades com les instantnies.
:::

::: fragment
Tamb茅 permet *afegir o eliminar discos f铆sics* **sense temps d'inactivitat**, cosa que [millora la disponibilitat]{.alert} del servidor de base de dades. ★ Ens permet la seva ampliaci贸 en un futur sense haver de parar el servei.
:::

## Cas Prctic 04: Errors i Fallades (I) {.smaller}

Imagineu-vos que esteu treballant amb un grup de volums (**VG1**) que cont茅 diversos discos f铆sics, entre ells el [PV1]{.alert}. A m茅s, teniu un altre grup de volums (**VG2**) en un disc f铆sic diferent (*PV2*) on guardeu les vostres instantnies. Qu猫 passaria amb les metadades de LVM i les instantnies si el disc f铆sic [PV1]{.alert} falla?

::: fragment
**Si** les metadades de LVM no estan en el disc fallat [PV1]{.alert}, llavors els volums l貌gics que no estaven en el disc fallat segueixen estant disponibles. ★ En aquest cas, les metadades de LVM no es perden i es pot recuperar la informaci贸 dels volums l貌gics del **VG1**.
:::

::: fragment
No obstant aix貌, si el disc fallat [PV1]{.alert} contenia dades dun volum l貌gic, aquestes dades es perdran a menys que tinguem una **instantnia**. *A m茅s, si el disc fallat contenia una part dun volum l貌gic que sestenia per diversos discos (com en el cas dun volum l貌gic distribu茂t o striped), tot el volum l貌gic pot quedar inutilitzable*. ★ En aquest cas, les metadades de LVM es perden i no es pot recuperar la informaci贸 dels volums l貌gics del **VG1**.
:::

::: {.fragment .center-container}
**VG2** cont茅 les instantnies, per tant, si el disc f铆sic [PV1]{.alert} falla, les instantnies no es perdran. ★ Aix貌 permet restaurar les dades del volum l貌gic original del **VG1** a partir de les instantnies del **VG2**.
:::

## Cas Prctic 05: Escalabilitat d'Apps (I) {.smaller}

Una empresa est experimentant un rpid creixement i necessita implementar un nou servidor per donar suport a una nova aplicaci贸 cr铆tica per al negoci. El departament dIT **t茅 pressupost limitat i nom茅s t茅 disponible un emmagatzematge de 2TB per a aquest nou servidor**. [Laplicaci贸 requereix un m铆nim de 1TB demmagatzematge per funcionar correctament]{.alert}, per貌 es *preveu que el seu 煤s creixer rpidament en els propers mesos*.

::: fragment
Com a administrador us plantejeu la possibilitat dutilitzar el **thin provisioning de LVM** per donar suport a laplicaci贸 en creixement. Aquesta t猫cnica permet **sobreprovisionar** lespai demmagatzematge, 茅s a dir, assignar m茅s espai del que realment teniu. Aix貌 茅s possible perqu猫 el thin provisioning de LVM [nom茅s assigna lespai demmagatzematge real a mesura que laplicaci贸 lutilitza]{.alert}.★ Si assigneu 4TB demmagatzematge a laplicaci贸 en un VG format pel disc de 2TB, inicialment nom茅s sutilitzar lespai que laplicaci贸 necessita realment. Aix铆, podreu planificar una ampliaci贸 del disc dur a 4TB en el futur sense haver de parar el servei.
:::

## Cas Prctic 05: Escalabilitat d'Apps (II) {.smaller}

No obstant aix貌, que pot passar si les vostres *previsions no s贸n correctes i el creixement es mes r谩pid de lesperat*. ★ Laplicaci贸 intenta escriure m茅s de 2TB de dades al disc.

::: fragment
El **thin provisioning** de LVM no evitar que l'aplicaci贸 s'aturi o es produeixin errors d'E/S quan l'aplicaci贸 excedeixi la capacitat real. ★ Quan l'aplicaci贸 intenti escriure m茅s de 2TB de dades al disc, [**es produir un error d'E/S**]{.alert}, ja que no hi haur prou espai d'emmagatzematge disponible per emmagatzemar les dades.
:::

::: {.fragment .center-container}
En aquest cas, es necessitar [afegir m茅s espai d'emmagatzematge al grup de volums]{.alert} i **ampliar el volum l貌gic thin provisioned** per donar suport a l'aplicaci贸 en creixement.
:::

## Cas Prctic 05: Escalabilitat d'Apps (III) {.smaller}

En la situaci贸 anterior, heu decidit utilitzar el **thin provisioning de LVM** per donar suport a l'aplicaci贸 en creixement. Per貌, com a administrador de sistemes, us preocupa que l'aplicaci贸 pugui aturar-se o produir errors d'E/S si l'espai d'emmagatzematge s'omple rpidament. *Qu猫 far铆eu per reduir el risc d'aturades i errors d'E/S en aquest escenari?*

:::{.fragment}
Una opci贸 seria **implementar un sistema de monitoreig i alertes** que supervisi l'煤s de l'espai d'emmagatzematge del grup de volums. Quan l'煤s d'emmagatzematge superi un determinat llindar, el sistema generaria una alerta per **afegir m茅s espai d'emmagatzematge al grup de volums** i **ampliar el volum l貌gic thin provisioned** per donar suport a l'aplicaci贸 en creixement.
:::

# Exercicis i Laboratoris

## Laboratoris

-   Laboratori 01: Instal路laci贸 de LVM a AlmaLinux
-   Laboratori 02: Gesti贸 de LVM a AlmaLinux

## Laboratori 01: Instal路laci贸 de LVM a AlmaLinux {.smaller}

#### Requeriments

-   Mquina virtual amb 1 disc dur de 20 GB, 1 GB de RAM i 1 CPU.
-   Imatge ISO d'AlmaLinux.

::: fragment
#### Tasques

-   Instal路lar AlmaLinux i configurar LVM durant la instal路laci贸.
-   Crearem un PV a partir del disc dur principal de 20GB.
-   Crearem un VG anomenta almalinux.
-   `/` ser un LV amb un sistema de fitxers xfs de 16,4 GB (almalinx-root).
-   `/boot` i `boot/efi` seran particions tradicionals de 600MiB i 1024MiB respectivament.
-   `swap` ser un LV de 2GB (almalinux-swap).
:::

## Laboratori 01: Selecci贸 de dispositius {.smaller}

![](../figs/slides/03-lvm/exemple1/seleccio_dispositius.png)

## Laboratori 01: Configuraci贸 LVM {.smaller}

![](../figs/slides/03-lvm/exemple1/particionatge.png)

## Laboratori 01: Configuraci贸 de les particions {.smaller}

![](../figs/slides/03-lvm/exemple1/lvm-config.png)

## Laboratori 02: Configuraci贸 manual LVM {.smaller}

#### Requeriments

-   Afegir un disc dur secundari de 10 GB a la mquina virtual.

::: fragment
#### Tasques

-   Crear un PV a partir del disc dur secundari.
-   Crear un VG anomenat `datavg` a partir del PV.
-   Crear un LV anomenat `home` amb un sistema de fitxers ext4 de 5GB.
-   Muntarem el LV `home` a `/home`.
-   Redimensionarem el LV en calent.
:::

## Laboratori 02: Creaci贸 de PVs, VGs i LVs {.smaller}

-   Creaci贸 d'un PV amb el dispositiu `/dev/vdb`:

::: fragment
``` bash
pvcreate /dev/vdb
```
:::

-   Creaci贸 d'un VG anomenat `datavg` amb el PV `/dev/vdb`:

::: fragment
``` bash
vgcreate datavg /dev/vdb
```
:::

-   Creaci贸 d'un LV de 5GB anomenat `home` en el VG `datavg`:

::: fragment
``` bash
lvcreate -L 5GB M -n home datavg
```
:::

## Laboratori 02: Creaci贸 de sistema de fitxers i muntatge {.smaller}

-   Creaci贸 d'un sistema de fitxers ext4 en el LV `home`:

::: fragment
``` bash
mkfs.ext4 /dev/datavg/home
```
:::

-   Muntatge del LV `home` en el directori `/home`:

::: fragment
``` bash
mount /dev/datavg/home /home
```
:::

## Laboratori 02: Ampliaci贸 LVs {.smaller}

-   Ampliaci贸 del LV `home` a 7GB:

::: fragment
``` bash
lvextend -L 7GB /dev/datavg/home
```
:::

-   Redimensionar el sistema de fitxers ext4:

::: fragment
``` bash
resize2fs /dev/datavg/home
```
:::

## Laboratori 02: Reducci贸n LVs {.smaller}

-   Reducci贸 del sistema de fitxers ext4:

::: fragment
``` bash
resize2fs /dev/datavg/home 6G
```
:::

-   Reducci贸 del LV `home` a 6GB:

::: fragment
``` bash
lvreduce -L 6GB /dev/datavg/home
```
:::


## That's all

::::::: columns
:::: {.column width="45%"}
::: {.callout-note title="Take Home Message"}
-   LVM 茅s una eina potent que **simplifica** la **gesti贸 de lespai demmagatzematge** en sistemes Linux.
-   Ofereix als administradors de sistemes la **flexibilitat** de crear, modificar i eliminar particions de manera **dinmica** sense necessitat daturar el sistema.
:::
::::

::: {.column width="5%"}
:::

::: {.column width="50%"}
![](https://static.posters.cz/image/750/posters/looney-tunes-thats-all-folks-i295.jpg){width="70%"}
:::
:::::::