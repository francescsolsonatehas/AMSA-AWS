---
title: "PrÃ ctica 01: Snapshots i restauraciÃ³ amb systemd i initramfs"
subtitle: "Unitat 2 Â· AdministraciÃ³ i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo FornÃ©s <jordi.mateo@udl.cat>"
format: html
lang: ca
---

## Objectius
- Comprendre el procÃ©s d'arrencada en Linux (GRUB â†’ initramfs â†’ systemd).
- Configurar i gestionar serveis `systemd`.
- Crear snapshots de lâ€™estat del sistema i restaurar-los.
- Introduir-se a la personalitzaciÃ³ dâ€™`initramfs` i opcionalment GRUB.

## Context

En entorns reals, Ã©s freqÃ¼ent necessitar tornar a un estat anterior del sistema desprÃ©s dâ€™una fallada o una actualitzaciÃ³ incorrecta. Aquesta prÃ ctica simula aquest escenari: configurarem un mecanisme de snapshots i un procÃ©s per restaurar-los en arrencar la mÃ quina.

## Entorn de treball
- MÃ quina virtual amb Debian 12 i amb UEFI amb 20 GB de disc.
- Disc virtual addicional de 20 GB per emmagatzemar els snapshots.

## PreparaciÃ³ de la mÃ quina virtual

Un cop arrencada la mÃ quina virtual, afegiu un disc dur addicional de 20 GB. Aquest disc serÃ  utilitzat per emmagatzemar els snapshots. Per exemple, si el disc principal Ã©s `/dev/nvme0n1`, el nou disc podria ser `/dev/nvme0n2`. Un cop afegit el disc, inicieu la mÃ quina virtual i comproveu que el nou disc Ã©s visible amb `lsblk`.

Un cop identificat el nou disc, cal crear-hi un sistema de fitxers i muntar-lo. Per exemple, si el nou disc Ã©s `/dev/nvme0n2`, podeu fer-ho aixÃ­:

```bash
# Com a root o amb sudo
mkfs.ext4 /dev/nvme0n2
mount /dev/nvme0n2 /mnt
mkdir -p /mnt/snapshots
```

Per evitar haver de muntar el disc manualment cada cop, afegiu una entrada a `/etc/fstab`. Per exemple, afegiu aquesta lÃ­nia al final del fitxer:

```bash
/dev/nvme0n2  /mnt  ext4  defaults  0  2
```

:::{.callout-warning title="AdvertÃ¨ncia"}
Assegureu-vos d'indicar el disc correcte que pot ser nvme0n2, sdb, vdb,... No utilitzeu el disc principal on estÃ  instalÂ·lat el sistema operatiu.
:::



Un cop muntat el disc, instalÂ·leu `rsync` si no estÃ  instalÂ·lat:

```bash
# Com a root o amb sudo
apt update
apt install rsync
```

En cas de problemes amb el `update`, igual necessitareu fer un `apt upgrade` abans.


## Tasques

1. **Crear snapshots amb `rsync` (bÃ sic)** ğŸ“
   - Escriure un script que creÃ¯ snapshots del directori `/home` i  a `/mnt/snapshots` utilitzant `rsync`.
   - Crea un primer snapshot manualment per tenir una base de dades inicial i anomeneu-lo `snapshot_00000000_000000`, feu servir script com a `root` o amb `sudo`.
   - Provar lâ€™script manualment i assegurar-se que es poden crear diversos snapshots.
   - Utilitzar un format de nom com `snapshot_YYYYMMDD_HHMMSS` per al directori. 
   - Els snapshots han de ser cÃ²pies completes del sistema, excepte el directori de snapshots.
   - Implementar una polÃ­tica per mantenir el snapshot inicial i els 3 snapshots mÃ©s recents, eliminant els mÃ©s antics.
  
2. **Automatitzar la creaciÃ³ de snapshots amb `systemd` (nivell mitjÃ )** âš™ï¸
   - Crear un servei `systemd` que executi lâ€™script de creaciÃ³ de snapshots a cada apagada de la mÃ quina.
   - Validar que cada vegada que sâ€™aturi la mÃ quina es crea un nou snapshot.

3. **Restaurar snapshots en arrencada amb `systemd` (nivell mitjÃ )** ğŸ”„
    - Escriure un script que mostri un llistat de snapshots disponibles i permeti seleccionar-ne un per restaurar.
    - Crear un servei `systemd` que sâ€™executi abans de `multi-user.target` i cridi aquest script.
    - Comprovar que en arrencar la mÃ quina es mostra el menÃº de snapshots.

4. **Restaurar snapshots des dâ€™`initramfs` (nivell avanÃ§at)** ğŸš€
    - Afegir un parametre al kernel per indicar el fitxer de snapshot a restaurar.
    - Afegir un script a `initramfs` que carregui el disc secundari, llegeixi el parÃ metre i restauri el snapshot abans de muntar `/`.
    - Reconstruir lâ€™`initramfs` i validar que s'ha restaurat el snapshot correcte.

  
## Preguntes de reflexiÃ³

- Quins riscos implica restaurar snapshots a nivell de fitxers?  (**bÃ sic**)
- Com es pot assegurar la integritat dels snapshots creats?  (**intermedi**)
- Quina diferÃ¨ncia hi ha entre executar el menÃº de restauraciÃ³ a initramfs i fer-ho amb systemd desprÃ©s dâ€™arrencar? (**avanÃ§at**)



## Criteris dâ€™avaluaciÃ³

| Criteri                        | PuntuaciÃ³ |
|-------------------------------|-----------|
| BÃ sic (script manual)         | 5 punts   |
| Intermedi (systemd)            | 7 punts   |
| AvanÃ§at (initramfs)            | 9 punts  |
| Extra (GRUB)                   | 10 punts  |


## OrganitzaciÃ³ i lliurament

Creeu un directori anomenat `practica01` amb lâ€™estructura segÃ¼ent i pengeu-lo al vostre repositori de GitHub:

```text
ğŸ“‚ practica01/
â”œâ”€â”€ SOLUCIÃ“.md                # SoluciÃ³ i explicaciÃ³ de cada part amb captures 
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ create_snapshot.sh    # Esquelet d'script per crear snapshots
â”‚   â”œâ”€â”€ restore_snapshot.sh   # Esquelet d'script per restaurar snapshots
â”‚   â””â”€â”€ helpers.sh            # Funcions auxiliars (ordenar, netejar snapshots, etc.)
â”œâ”€â”€ systemd/
â”‚   â”œâ”€â”€ snapshot.service      # Unit file per crear snapshot al shutdown
â”‚   â””â”€â”€ restore.service       # Unit file per restaurar snapshot a l'arrencada
â”œâ”€â”€ initramfs/
â”‚   â””â”€â”€ snapshot_menu         # Hook dâ€™exemple per initramfs 
â””â”€â”€ grub/
    â””â”€â”€ 40_custom_snapshot    # Exemple dâ€™entrada extra per GRUB 
```

Es permet tambÃ© documentar la prÃ ctica en un document `.pdf` enlloc de `.md` amb les explicacions i captures de pantalla. Assegureu-vos dâ€™incloure totes les parts desenvolupades i les respostes a les preguntes de reflexiÃ³.

