---
title: "PrÃ ctica 01: Snapshots i restauraciÃ³ amb systemd i initramfs"
subtitle: "Unitat 2 Â· AdministraciÃ³ i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo FornÃ©s <jordi.mateo@udl.cat>"
format: html
lang: ca
---

## Objectius
- Comprendre el procÃ©s d'arrencada en Linux (GRUB â†’ initramfs â†’ systemd).
- Configurar i gestionar serveis `systemd`.
- Crear snapshots de lâ€™estat del sistema i restaurar-los.
- Introduir-se a la personalitzaciÃ³ dâ€™`initramfs` i opcionalment GRUB.

## Context

En entorns reals, Ã©s freqÃ¼ent necessitar tornar a un estat anterior del sistema desprÃ©s dâ€™una fallada o una actualitzaciÃ³ incorrecta. Aquesta prÃ ctica simula aquest escenari: configurarem un mecanisme de snapshots i un procÃ©s per restaurar-los en arrencar la mÃ quina.

## Entorn de treball
- MÃ quina virtual amb Debian 12 i amb UEFI amb 20 GB de disc.
- Disc virtual addicional de 20 GB per emmagatzemar els snapshots.

## PreparaciÃ³ de la mÃ quina virtual

Un cop arrencada la mÃ quina virtual, afegiu un disc dur addicional de 20 GB. Aquest disc serÃ  utilitzat per emmagatzemar els snapshots. Per exemple, si el disc principal Ã©s `/dev/nvme0n1`, el nou disc podria ser `/dev/nvme0n2`. Un cop afegit el disc, inicieu la mÃ quina virtual i comproveu que el nou disc Ã©s visible amb `lsblk`.

Un cop identificat el nou disc, cal crear-hi un sistema de fitxers i muntar-lo. Per exemple, si el nou disc Ã©s `/dev/nvme0n2`, podeu fer-ho aixÃ­:

```bash
# Com a root o amb sudo
mkfs.ext4 /dev/nvme0n2
mount /dev/nvme0n2 /mnt
mkdir -p /mnt/snapshots
```

Per evitar haver de muntar el disc manualment cada cop, afegiu una entrada a `/etc/fstab`. Per exemple, afegiu aquesta lÃ­nia al final del fitxer:

```bash
/dev/nvme0n2  /mnt  ext4  defaults  0  2
```

:::{.callout-warning title="AdvertÃ¨ncia"}
Assegureu-vos d'indicar el disc correcte que pot ser nvme0n2, sdb, vdb,... No utilitzeu el disc principal on estÃ  instalÂ·lat el sistema operatiu.
:::



Un cop muntat el disc, instalÂ·leu `rsync` si no estÃ  instalÂ·lat:

```bash
# Com a root o amb sudo
apt update
apt install rsync
```

En cas de problemes amb el `update`, igual necessitareu fer un `apt upgrade` abans.


## Tasques

1. **Crear snapshots amb `rsync` (2 punts)** ğŸ“
   - Escriure un script que creÃ¯ snapshots dels directoris `/home, /opt, /bin, /usr`  a `/mnt/snapshots` utilitzant `rsync`.
   - Crea un primer snapshot manualment per tenir una base de dades inicial i anomeneu-lo `snapshot_00000000_000000`, feu servir script com a `root`.
   - Provar lâ€™script manualment i assegurar-se que es poden crear diversos snapshots.
   - Utilitzar un format de nom com `snapshot_YYYYMMDD_HHMMSS` per al directori. 
   - Els snapshots han de ser cÃ²pies completes: `/home, /opt, /bin, /usr` . No cal comprimir aquests snapshots. Poden ser carpetes independents utilitzant la nomenclatura indicada.
   - Implementar una polÃ­tica per mantenir el snapshot inicial i els 3 snapshots mÃ©s recents, eliminant els mÃ©s antics.
  
2. **Automatitzar la creaciÃ³ de snapshots amb `systemd` (3 punts)** âš™ï¸
   - Crear un servei `systemd` que executi lâ€™script de creaciÃ³ de snapshots a cada apagada de la mÃ quina.
   - Validar que cada vegada que sâ€™aturi la mÃ quina es crea un nou snapshot.

3. **Restaurar snapshots en arrencada amb `systemd` (3 punts)** ğŸ”„
    - Escriure un script que mostri un llistat de snapshots disponibles i permeti seleccionar-ne un per restaurar.
    - Crear un servei `systemd` que sâ€™executi abans de `multi-user.target` i cridi aquest script.
    - Comprovar que en arrencar la mÃ quina es mostra el menÃº de snapshots.
    - Validar que es pot restaurar un snapshot seleccionat.

4. **Restaurar snapshots des dâ€™`initramfs` (1/2 punts)** ğŸš€
    - Afegir un parametre al kernel per indicar el fitxer de snapshot a restaurar. Aquest parÃ metres'anomenarÃ  `snapshot=` i rebrrÃ  el nom de la snapshot a restaurar, per exemple `snapshot=snapshot_20240101_120000`. En cas de no rebre cap parÃ metre, no es restaurarÃ  cap snapshot.
    - Afegir un script a `initramfs` que carregui el disc secundari, llegeixi el parÃ metre i restauri el snapshot abans de muntar `/`.
      - **Simple**: Utilitzant comandes integrades a `initramfs`. (**1 punt**)
      - **AvanÃ§at**: Afegint programari compilat estaticament a `initramfs`. (**2 punts**)
    - Reconstruir lâ€™`initramfs` i validar que s'ha restaurat el snapshot correcte. 

  
## OrganitzaciÃ³ i lliurament

Accediu a l'activitat a travÃ©s de l'enllaÃ§ al [Github Classroom](https://classroom.github.com/a/MT3q9LBg). Un cop acceptada l'activitat, clonareu el repositori a la vostra mÃ quina local i comenÃ§areu a treballar. Podeu treballar amb grups de fins a 3 persones.

```text
ğŸ“‚ practica01/
â”œâ”€â”€ SOLUCIÃ“.md               
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ create_snapshot.sh    
â”‚   â”œâ”€â”€ restore_snapshot.sh   
â”‚   â””â”€â”€ helpers.sh            
â”œâ”€â”€ systemd/
â”‚   â”œâ”€â”€ snapshot.service      
â”‚   â””â”€â”€ restore.service       
â”œâ”€â”€ initramfs/
â”‚   â””â”€â”€ snapshot_menu        
â””â”€â”€ grub/
    â””â”€â”€ 40_custom_snapshot    
```

El document `SOLUCIÃ“.md` ha dâ€™incloure:

- ExplicaciÃ³ de cada part de la prÃ ctica i comandes utilitzades.
- DiferÃ¨ncies entre les comandes `cp`, `rsync` i `tar` per fer cÃ²pies de seguretat.
- Conjunt de proves realitzades per validar cada part.
- Enregistrament en format vÃ­deo de la consola on es demostri el funcionament correcte de les diferents parts de la prÃ ctica, o bÃ© captures de pantalla on es mostri el procÃ©s i els resultats.
- DocumentaciÃ³ o prompts consultats.


