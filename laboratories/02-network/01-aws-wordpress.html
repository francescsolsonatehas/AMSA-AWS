<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Deployment of a high-availability web application with AWS ‚Äì AMSA - Fall 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-c30451789a0a2bcd5e941535c675cd30.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Deployment of a high-availability web application with AWS</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../figs/logo.png" alt="AMSA Logo" class="sidebar-logo light-content py-0 d-lg-inline d-none">
      <img src="../../figs/logo.png" alt="AMSA Logo" class="sidebar-logo dark-content py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="../../index.html" title="Home" class="quarto-navigation-tool px-1" aria-label="Home"><i class="bi bi-house"></i></a>
    <a href="https://github.com/francescsolsonatehas/AMSA-AWS" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <a href="https://cv.udl.cat/" title="Sakai" class="quarto-navigation-tool px-1" aria-label="Sakai"><i class="bi bi-person-fill"></i></a>
</div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../laboratories/01-foundations/01-aws-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 ¬∑ Executing a Python script in a EC2 instance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../laboratories/01-foundations/02-aws-wordpress.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 ¬∑ Deploying a web application</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#vpc-and-subnets" id="toc-vpc-and-subnets" class="nav-link active" data-scroll-target="#vpc-and-subnets">1. VPC and Subnets</a>
  <ul class="collapse">
  <li><a href="#creating-the-subnets" id="toc-creating-the-subnets" class="nav-link" data-scroll-target="#creating-the-subnets">1.2. Creating the Subnets</a></li>
  </ul></li>
  <li><a href="#routing-tables-and-associations" id="toc-routing-tables-and-associations" class="nav-link" data-scroll-target="#routing-tables-and-associations">2. Routing Tables and Associations</a>
  <ul class="collapse">
  <li><a href="#internet-gateway-configuration" id="toc-internet-gateway-configuration" class="nav-link" data-scroll-target="#internet-gateway-configuration">2.1. Internet Gateway Configuration</a></li>
  <li><a href="#creation-of-routing-tables" id="toc-creation-of-routing-tables" class="nav-link" data-scroll-target="#creation-of-routing-tables">2.2. Creation of Routing Tables</a></li>
  </ul></li>
  <li><a href="#security-groups" id="toc-security-groups" class="nav-link" data-scroll-target="#security-groups">3. Security Groups</a>
  <ul class="collapse">
  <li><a href="#security-group-for-ec2-instances" id="toc-security-group-for-ec2-instances" class="nav-link" data-scroll-target="#security-group-for-ec2-instances">3.1. Security Group for EC2 instances</a></li>
  <li><a href="#security-group-for-the-database-rds" id="toc-security-group-for-the-database-rds" class="nav-link" data-scroll-target="#security-group-for-the-database-rds">3.2. Security Group for the database RDS</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">3.3. Summary</a></li>
  </ul></li>
  <li><a href="#creation-of-the-rds-database" id="toc-creation-of-the-rds-database" class="nav-link" data-scroll-target="#creation-of-the-rds-database">4. Creation of the RDS Database</a></li>
  <li><a href="#creation-of-ec2-instances-and-web-server-configuration-with-wordpress" id="toc-creation-of-ec2-instances-and-web-server-configuration-with-wordpress" class="nav-link" data-scroll-target="#creation-of-ec2-instances-and-web-server-configuration-with-wordpress">5. Creation of EC2 instances and Web Server Configuration with WordPress</a></li>
  <li><a href="#load-balancer-configuration" id="toc-load-balancer-configuration" class="nav-link" data-scroll-target="#load-balancer-configuration">6. Load Balancer Configuration</a></li>
  <li><a href="#vpn-configuration" id="toc-vpn-configuration" class="nav-link" data-scroll-target="#vpn-configuration">7. VPN configuration</a>
  <ul class="collapse">
  <li><a href="#create-an-ec2-to-deploy-the-vpn-server" id="toc-create-an-ec2-to-deploy-the-vpn-server" class="nav-link" data-scroll-target="#create-an-ec2-to-deploy-the-vpn-server">7.1.Create an EC2 to deploy the VPN server</a></li>
  </ul></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">8. Cleanup</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Deployment of a high-availability web application with AWS</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>ARCHITECTURE</strong></p>
<p>In this lab, we will design and implement a robust and secure network architecture to host a WordPress application. The architecture is based on the use of 2 <strong>Availability Zones (AZ)</strong> located in 1 <strong>Region</strong> to ensure that our WordPress is highly available and fault-tolerant.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/infra.png" class="img-fluid figure-img"></p>
<figcaption>Diagram of components, connections, and elements of the architecture</figcaption>
</figure>
</div>
<p>The image shows how, through the internet, users access the Load Balancer, which distributes traffic to the EC2 instances hosting WordPress. These instances connect to the RDS database to manage WordPress content. The EC2 instance in the DMZ allows secure access for the administration of private resources</p>
<p><strong>Components:</strong></p>
<ul>
<li><strong>VPC, subnets, route tables, and security groups</strong>.</li>
<li>Secure <strong>VPN</strong> for administrative access.</li>
<li>Wordpress EC2 instances distributed across private subnets in different AZs, accessible only through the Load Balancer, never directly from the Internet.‚Äù.</li>
<li><strong>Load Balancer</strong> which acts as a public entry point that ensures the uniform distribution of traffic to the WordPress EC2 instances.</li>
<li>High available <strong>Data Base RDS (MySQL)</strong> located in dedicated private subnets.</li>
<li><strong>DMZ</strong> designed with an EC2 instance in a public subnet that will act as a secure access point (via SSH tunnel) for managing all private resources.</li>
</ul>
<section id="vpc-and-subnets" class="level2">
<h2 class="anchored" data-anchor-id="vpc-and-subnets">1. VPC and Subnets</h2>
<p>The first step in our architecture is to define a VPC (Virtual Private Cloud) and the necessary subnets to isolate the different components of the application. The VPC will provide a virtualized network environment where we can deploy our AWS resources. We will configure it with the network <strong>10.0.0.0/16</strong>, which gives us up to 65,536 IP addresses, more than enough for our use case.</p>
<div class="callout callout-style-default callout-note callout-titled" title="CIDR, Hosts and Reserved Adresses üß†">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>CIDR, Hosts and Reserved Adresses üß†
</div>
</div>
<div class="callout-body-container callout-body">
<p>The subnet mask determines the number of IP addresses available within a network or subnet. This is expressed using CIDR notation (Classless Inter-Domain Routing), where the value (/n) indicates the number of bits reserved for the Network portion. A subnet mask of /16 means that the first 16 bits of the IP address are reserved for network identification, leaving the other 16 bits for host identification. This allows up to 65,536 IP addresses (<span class="math inline">\(2^{32-16}\)</span>) within that network.</p>
<p>When you perform subnetting to create subnets within your VPC, you increase the CIDR value (for example, from /16 to /24) to reduce the size of the subnets and better isolate traffic. For example, a subnet with CIDR /24 has 256 IP addresses (<span class="math inline">\(2^{32-24}\)</span>).</p>
<p>Remember that the total calculated addresses are not the total usable addresses for your servers (hosts). Some addresses are reserved for special uses, such as network identification and broadcast.</p>
</div>
</div>
<p>Podem definir la VPC a trav√©s de la interf√≠cie web d‚ÄôAWS, utilitzant els formularis disponibles:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpc.png" class="img-fluid figure-img"></p>
<figcaption>VPC definition</figcaption>
</figure>
</div>
<section id="creating-the-subnets" class="level3">
<h3 class="anchored" data-anchor-id="creating-the-subnets">1.2. Creating the Subnets</h3>
<p>Add the necessary subnets for our architecture. Go to <strong>VPC</strong> ‚Üí <strong>Subnets</strong> ‚Üí <strong>Create subnet</strong>. Select the VPC we just created and add the following subnets:</p>
<ul>
<li><strong>AMSA-DMZ-01</strong>: Public subnet in the zone <strong>us-east-1a</strong>. This subnet will host the EC2 instance that will serve as a secure access bridge (via SSH tunnel) for managing all private resources. <em>(10.0.1.0/24)</em>.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ-01.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-DMZ-01</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-DMZ-02</strong>: Public subnet in the zone <strong>us-east-1b</strong>. This subnet will host the EC2 instance that will serve as a secure access bridge (via SSH tunnel) for managing all private resources. <em>(10.0.2.0/24)</em>.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ-02.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-DMZ-02</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-Private01</strong>: Private subnet for the WordPress instances in the availability zone <strong>us-east-1a</strong>. <em>(10.0.3.0/24)</em>.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Private01.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-Private01</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-Private02</strong>: Private subnet for the WordPress instances in the availability zone <strong>us-east-1b</strong>. <em>(10.0.4.0/24)</em></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Private02.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-Private02</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-Data</strong>: Private subnet for the WordPress instances in the availability zone <strong>us-east-1c</strong>. <em>(10.0.5.0/24)</em></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Data.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-Data</figcaption>
</figure>
</div>
</section>
</section>
<section id="routing-tables-and-associations" class="level2">
<h2 class="anchored" data-anchor-id="routing-tables-and-associations">2. Routing Tables and Associations</h2>
<p>To manage traffic routes and determine how it is distributed among the subnets, we will create route tables and associate them with the corresponding subnets..</p>
<section id="internet-gateway-configuration" class="level3">
<h3 class="anchored" data-anchor-id="internet-gateway-configuration">2.1. Internet Gateway Configuration</h3>
<p>We will use an <strong>Internet Gateway (IGW)</strong> to allow the public subnets <em>(AMSA-DMZ-01 and AMSA-DMZ-02)</em> to have both inbound and outbound Internet access. To do this, we will first create the IGW and then associate it with our VPC.</p>
<p>The first step is to create the Internet Gateway. Go to <strong>VPC</strong> ‚Üí <strong>Internet Gateways</strong> ‚Üí <strong>Create internet gateway</strong>. Once created, name it <strong>AMSA-IG</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ig.png" class="img-fluid figure-img"></p>
<figcaption>Internet Gateway for the VPC</figcaption>
</figure>
</div>
<p>The second step is to associate the Internet Gateway with the VPC. Select the Internet Gateway we just created and click on <strong>Actions</strong> ‚Üí <strong>Attach to VPC</strong>. Select the VPC <strong>AMSA-VPC</strong> and click on <strong>Attach internet gateway</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/attachIG.png" class="img-fluid figure-img"></p>
<figcaption>Association of the Internet Gateway with the VPC</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/attachIG2.png" class="img-fluid figure-img"></p>
<figcaption>Association of the Internet Gateway with the VPC</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="Attached IGW üõë">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Attached IGW üõë
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make sure the Internet Gateway is correctly associated with the VPC. If it is not associated, the public subnets will not be able to access the Internet.</p>
</div>
</div>
</section>
<section id="creation-of-routing-tables" class="level3">
<h3 class="anchored" data-anchor-id="creation-of-routing-tables">2.2. Creation of Routing Tables</h3>
<p>Each subnet needs a route table to define how inbound and outbound traffic is directed. We will create specific route tables for each type of subnet (public and private) and associate them with the corresponding subnets.</p>
<section id="routing-for-public-subnets-dmz" class="level4">
<h4 class="anchored" data-anchor-id="routing-for-public-subnets-dmz">2.2.1. Routing for public subnets (DMZ)</h4>
<p>The first step is to create the route table for the public subnets. Go to <strong>VPC</strong> ‚Üí <strong>Route Tables</strong> ‚Üí <strong>Create route table</strong>. Select VPC <strong>AMSA-VPC</strong> and name the route table <strong>AMSA-DMZ01-RT</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ01-RT.png" class="img-fluid figure-img"></p>
<figcaption>Route table for the subnet AMSA-DMZ01-RT</figcaption>
</figure>
</div>
<p>The second step is to associate the route table (<em>AMSA-DMZ01-RT</em>) with the subnet <strong>AMSA-DMZ-01</strong> allow outbound traffic to the Internet through the Internet Gateway we created earlier.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ-Subnet-Association.png" class="img-fluid figure-img"></p>
<figcaption>Association of the route table with the subnet AMSA-DMZ-01</figcaption>
</figure>
</div>
<p>The third step is to allow outbound traffic to the Internet through the Internet Gateway we created earlier. To do this, go to the section <em>Routes</em> and click on <em>Edit routes</em>. Next, <strong>Add route</strong> and edit (Destination: 0.0.0.0/0; Target:Seleccionar el <strong>AMSA-IG</strong>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/IG.png" class="img-fluid figure-img"></p>
<figcaption>Allowing traffic with the outside through the IG</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="AMSA-DMZ-02 üõë">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>AMSA-DMZ-02 üõë
</div>
</div>
<div class="callout-body-container callout-body">
<p>Perform the same steps for the subnet <strong>AMSA-DMZ-02</strong>, modifying only the name of the route table and the association with the subnet.</p>
</div>
</div>
</section>
<section id="routing-for-private-subnets" class="level4">
<h4 class="anchored" data-anchor-id="routing-for-private-subnets">2.2.2. Routing for private subnets</h4>
<p>Private subnets do not have direct access to the Internet for security reasons. Therefore, we need to configure the route tables for these subnets so that they can access the Internet through a NAT Gateway (Network Address Translation Gateway). This will allow instances within the private subnets to initiate outbound connections, but prevent external sources from initiating connections to them.</p>
<div class="callout callout-style-default callout-note callout-titled" title="NAT Gateway üß†">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>NAT Gateway üß†
</div>
</div>
<div class="callout-body-container callout-body">
<p>A NAT Gateway is a managed service by AWS that allows instances in a private subnet to access the Internet for software updates, package downloads, etc., without exposing those instances directly to the Internet. The NAT Gateway translates the private IP addresses of the instances into a public IP address when those instances make requests to the Internet.</p>
</div>
</div>
<p>To create the NAT Gateway, we need an Elastic IP. Therefore, we will first create an Elastic IP and then use it to create the NAT Gateway. Name it <strong>AMSA-NAT-EIP</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ElasticIP-NAT.png" class="img-fluid figure-img"></p>
<figcaption>Creating the Elastic IP</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ElasticIp-Nat2.png" class="img-fluid figure-img"></p>
<figcaption>Update the name of the Elastic IP</figcaption>
</figure>
</div>
<p>Once we have the Elastic IP, we can create the NAT Gateway. Name it <strong>AMSA-NG</strong> and associate it with the subnet <strong>AMSA-DMZ-01</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/nat-gw-create.png" class="img-fluid figure-img"></p>
<figcaption>Creating the NAT Gateway</figcaption>
</figure>
</div>
<p>Create the route table (<em>AMSA-Private01-RT</em>) for the subnet <strong>AMSA-Private01</strong> and we will associate it with the subnet. This route table will allow the instances within this subnet to access the Internet through the NAT Gateway.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-Private01-RT.png" class="img-fluid figure-img"></p>
<figcaption>Route table for the subnet AMSA-Private01</figcaption>
</figure>
</div>
<p>The second step is to associate the route table (<em>AMSA-Private01-RT</em>) with the subnet <strong>AMSA-Private01</strong> and allow outbound traffic to the Internet through the NAT Gateway we created earlier.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Private01-RT-create.png" class="img-fluid figure-img"></p>
<figcaption>Creating the route table for the subnet AMSA-Private01</figcaption>
</figure>
</div>
<p>The third step is to allow outbound traffic to the Internet through the NAT Gateway we created earlier. To do this, go to the section <em>Routes</em> and click on <em>Edit routes</em>. Next, <strong>Add route</strong> and edit (Destination: 0.0.0.0/0; Target:Select <strong>AMSA-NG</strong>).</p>
<div class="callout callout-style-default callout-warning callout-titled" title="AMSA-Private02 üõë">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>AMSA-Private02 üõë
</div>
</div>
<div class="callout-body-container callout-body">
<p>Repeat the same steps for the subnet <strong>AMSA-Private02</strong>, modifying only the name of the route table and the association with the subnet.</p>
</div>
</div>
</section>
<section id="routing-for-the-data-subnet-amsa-data" class="level4">
<h4 class="anchored" data-anchor-id="routing-for-the-data-subnet-amsa-data">2.2.3. Routing for the data subnet (AMSA-Data)</h4>
<p>The subnet <strong>AMSA-Data</strong> will not host instances that require Internet access. Therefore, we do not need to configure any route for this subnet. We will create an empty route table and associate it with the subnet <strong>AMSA-Data</strong>. This network will be completely isolated and will only allow internal communication within the VPC.</p>
</section>
</section>
</section>
<section id="security-groups" class="level2">
<h2 class="anchored" data-anchor-id="security-groups">3. Security Groups</h2>
<p>Security Groups are a tool for controlling network traffic for instances and other AWS resources, acting as a virtual firewall. They allow defining rules that specify which connections are allowed for both inbound and outbound traffic</p>
<ul>
<li><strong>Trafic inbound</strong>: It allows you to decide which types of incoming connections (to the resource) are permitted.</li>
<li><strong>Trafic outbound</strong>: Control which outbound connections (from the resource to other destinations) are authorized.</li>
</ul>
<section id="security-group-for-ec2-instances" class="level3">
<h3 class="anchored" data-anchor-id="security-group-for-ec2-instances">3.1. Security Group for EC2 instances</h3>
<ul>
<li><strong>Inbound connections</strong> for web services HTTP (port 80) and HTTPS (port 443), accessible from any origin.</li>
<li><strong>SSH conections (port 22)</strong> for remote administration, also accessible from any origin (initially, but later they will be restricted).</li>
<li>All outbound connections (<strong>outbound</strong>). By default, they are allowed in AWS, which enables EC2 instances to communicate with other resources such as RDS.</li>
</ul>
<p>To do this, we will navigate to the AWS VPC console, select the <em>Security Groups</em> section, and click <em>Create security group</em>. Next, we will fill in the fields with the necessary information and click <em>Create security group</em>. You can name it <strong>AMSA-WP-SG</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-WP-SG.png" class="img-fluid figure-img"></p>
<figcaption>Security Group for EC2 instances</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Security note üîê">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Security note üîê
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now we allow all network traffic for web services and SSH. Once everything is configured, we will restrict this access only to inbound traffic coming from the load balancer for web services and from our internal network for SSH.</p>
</div>
</div>
</section>
<section id="security-group-for-the-database-rds" class="level3">
<h3 class="anchored" data-anchor-id="security-group-for-the-database-rds">3.2. Security Group for the database RDS</h3>
<ul>
<li><strong>Inbound connections</strong>: t will only allow traffic on port 3306 (MySQL) and exclusively from EC2 instances that belong to the security group <strong>AMSA-WP-SG</strong>.</li>
<li><strong>Outbound connections</strong>: By default, AWS will allow all outbound connections, which ensures that the database can communicate with other resources if necessary.</li>
</ul>
<p>To do this, we will navigate to the AWS VPC console, select the Security Groups section, and click Create security group. Next, we will fill in the fields with the necessary information and click <em>Create security group</em>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-DB-SG.png" class="img-fluid figure-img"></p>
<figcaption>Security Group for the database RDS</figcaption>
</figure>
</div>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">3.3. Summary</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 23%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Security Group</th>
<th>Inbound</th>
<th>Outbound</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AMSA-WP-SG</td>
<td>HTTP (80) and HTTPS (443) from 0.0.0.0/0; SSH (22) from 0.0.0.0/0</td>
<td>All allowed</td>
</tr>
<tr class="even">
<td>AMSA-DB-SG</td>
<td>MySQL (3306) from AMSA-Web-SG</td>
<td>All allowed</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="creation-of-the-rds-database" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-the-rds-database">4. Creation of the RDS Database</h2>
<p>We already configured the database in the previous lab Deploying a web application with AWS. The only difference is that now the database is located in a private subnet and is only accessible from EC2 instances that belong to the security group <strong>AMSA-Web-SG</strong>.</p>
<ul>
<li><strong>Compute resources</strong>: Don‚Äôt connect to an EC2 compute resource</li>
<li><strong>VPC</strong>: AMSA-VPC</li>
<li><strong>Subnet Group</strong>: Create new DB Subnet Group</li>
<li><strong>Public accessibility</strong>: No</li>
<li><strong>VPC security group</strong>: AMSA-DB-SG</li>
<li><strong>Availability Zone</strong>: us-east-1d</li>
</ul>
</section>
<section id="creation-of-ec2-instances-and-web-server-configuration-with-wordpress" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-ec2-instances-and-web-server-configuration-with-wordpress">5. Creation of EC2 instances and Web Server Configuration with WordPress</h2>
<p>The EC2 instances that will host WordPress will be deployed in private subnets. AWS allows us to create instance templates (Launch Templates) that make it easier to create instances with a predefined configuration. Therefore, we will create an instance template that includes the necessary configuration for our WordPress EC2 instances.</p>
<ol type="1">
<li><p>Create an EC2 instance with Amazon Linux, selecting the VPC <strong>AMSA-VPC</strong> and the subnet <strong>AMSA-DMZ-01</strong>. Make sure that the instance uses the security group <strong>AMSA-WP-SG</strong>. You can name it <strong>AMSA-DB-Config</strong>. Select <em>assign public IP</em>. We will only use this instance to initialize the database and then we can delete it.</p></li>
<li><p>Once the instance is configured, connect to it via SSH using the private key corresponding to the public key you associated with the instance during its creation. Then configure the MySQL database for WordPress.</p></li>
<li><p>Let‚Äôs create a launch template (<strong>Launch Template</strong>) for the EC2 instances that will host WordPress. This template will include the necessary configuration for the instances, including the installation and configuration script for WordPress.</p>
<ul>
<li>Template name: <strong>AMSA-WP-Template</strong></li>
<li>AMI: Amazon Linux 2023 (64-bit x86)</li>
<li>Instance Type: t2.micro</li>
<li>Key Pair: AMSA-KEY</li>
<li>Subnet: Do not select any subnet (it will be selected dynamically</li>
<li>Security group: <em>AMSA-WP-SG</em></li>
<li>Advanced Details: Add the following script to the User Data section.</li>
</ul></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="WordPress installation and configuration script üìù">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>WordPress installation and configuration script üìù
</div>
</div>
<div class="callout-body-container callout-body">
<p>Modify the database connection details according to your own data.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sudo bash install_wp.sh</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the following data according to your own details</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="va">DB_NAME</span><span class="op">=</span><span class="st">""</span> </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="va">DB_USER</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="va">DB_USER_PASSWORD</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="va">DB_HOST</span><span class="op">=</span><span class="st">""</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$(</span><span class="fu">id</span> <span class="at">-u</span><span class="va">)</span><span class="st">"</span> <span class="ot">-ne</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Please run this script with sudo or as root."</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">dnf</span> install <span class="at">-y</span> wget php-mysqlnd httpd php-fpm php-mysqli php-json php php-devel php-gd expect</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://wordpress.org/latest.tar.gz</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> latest.tar.gz</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure WordPress</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> wordpress/wp-config-sample.php wordpress/wp-config.php</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/database_name_here/</span><span class="va">$DB_NAME</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/username_here/</span><span class="va">$DB_USER</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/password_here/</span><span class="va">$DB_USER_PASSWORD</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/localhost/</span><span class="va">$DB_HOST</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp <span class="at">-r</span> wordpress/<span class="pp">*</span> /var/www/html/</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> sed <span class="at">-i</span> <span class="st">'s/AllowOverride None/AllowOverride All/g'</span> /etc/httpd/conf/httpd.conf</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chown <span class="at">-R</span> apache:apache /var/www</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod 2775 /var/www</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart httpd</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Once the launch template is created, you can use it to create EC2 instances with WordPress already configured and ready to connect to your RDS database. Go to <strong>EC2</strong> and select <strong>Launch Instance</strong>. Then select the launch template <strong>AMSA-WP-Template</strong> and configure the remaining parameters according to your needs.</p>
<ul>
<li>Number of instances: 2</li>
<li>Subnet: Select the subnet <strong>AMSA-Private01</strong> for the first instance and <strong>AMSA-Private02</strong> for the second instance. You can name them <strong>AMSA-WP-01</strong> i <strong>AMSA-WP-02</strong> respectively.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled" title="Note about EC2 instances üñ•Ô∏è">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Note about EC2 instances üñ•Ô∏è
</div>
</div>
<div class="callout-body-container callout-body">
<p>These instances will not have a public IP, as they will only be accessible through the load balancer that we will configure later. For now, you will not be able to access them directly via SSH or HTTP.</p>
</div>
</div>
</section>
<section id="load-balancer-configuration" class="level2">
<h2 class="anchored" data-anchor-id="load-balancer-configuration">6. Load Balancer Configuration</h2>
<p>At this point, we will create a load balancer for our EC2 instances. This load balancer will be responsible for evenly distributing traffic among the EC2 instances hosting WordPress.</p>
<p>There are 3 types of load balancers in AWS: <strong>Application Load Balancer (ALB)</strong>, <strong>Network Load Balancer (NLB)</strong> and <strong>Gateway Load Balancer (GWLB)</strong>. In this case, we will use an <strong>Application Load Balancer (ALB)</strong>, as it is recommended for web applications that use HTTP and HTTPS.</p>
<p>Navigate to the AWS console and select the <strong>EC2</strong> service. In the sidebar, select <strong>Load Balancers</strong> and then <strong>Create Load Balancer</strong>. Choose <strong>Application Load Balancer</strong> and click <strong>Create</strong>.</p>
<ul>
<li><strong>Load Balancer name</strong>: AMSA-ALB</li>
<li><strong>Scheme</strong>: Internet-facing</li>
<li><strong>IP Address Type</strong>: IPv4</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-01.png" class="img-fluid figure-img"></p>
<figcaption>Load Balancer Configuration</figcaption>
</figure>
</div>
<ul>
<li><p><strong>VPC</strong>: AMSA-VPC</p></li>
<li><p><strong>Availability Zones</strong>: Select the availability zones where we have the public subnet <strong>AMSA-DMZ-01</strong> (us-east-1a) and <strong>AMSA-DMZ-02</strong> (us-east-1b).</p></li>
<li><p><strong>Security Groups</strong>: New security group (<strong>AMSA-ALB-SG</strong>), this security group will allow inbound traffic for ports 80 (HTTP) and 443 (HTTPS) from any source but will restrict outbound traffic to the EC2 instances (security group <strong>AMSA-WP-SG</strong>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-ALB-SG.png" class="img-fluid figure-img"></p>
<figcaption>Security Group for the Load Balancer</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-03.png" class="img-fluid figure-img"></p>
<figcaption>Load balancer configuration</figcaption>
</figure>
</div></li>
<li><p><strong>Listeners</strong>: Create a listener for port 80 (HTTP), which will redirect traffic to port 80 of the EC2 instances. For port 443 (HTTPS), we will not configure any redirection for now. To do this, you must first create a <strong>Target Group</strong>. This group is necessary to indicate to the load balancer where to send the traffic.</p>
<ul>
<li><em>Target Group</em>:
<ul>
<li><strong>Target Type</strong>: Instances</li>
<li><strong>Nom</strong>: AMSA-WP-TG</li>
<li><strong>Protocol</strong>: HTTP</li>
<li><strong>Port</strong>: 80</li>
<li><strong>VPC</strong>: AMSA-VPC</li>
<li><strong>Health checks</strong>: HTTP, ruta <strong>/</strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/tg-03.png" class="img-fluid figure-img"></p>
<figcaption>Target group configuration</figcaption>
</figure>
</div></li>
</ul></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Health Check üéØ">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Health Check üéØ
</div>
</div>
<div class="callout-body-container callout-body">
<p>The load balancer checks the health of the EC2 instances through port 80 and the path <strong>/</strong>. This means that the load balancer will send traffic to EC2 instances that respond correctly to HTTP requests on the <strong>/</strong> path. Since our EC2 instances have WordPress installed, these instances will respond correctly to HTTP requests on the <strong>/</strong> path. <em>We can leave the default configuration</em>. The WordPress installation includes a home page that will respond with 302 (Found) when accessing the root path (/), which is why the health check may show that the instance is unhealthy. Once WordPress is configured, the health check will show that the instance is healthy.</p>
</div>
</div>
<ul>
<li><p>Select the two EC2 instances that host WordPress (AMSA-WP-01 and AMSA-WP-02) and add them to the target group using the <strong>Include as pending below</strong> button and then <strong>Add to registered</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/tg-04.png" class="img-fluid figure-img"></p>
<figcaption>Target group configuration</figcaption>
</figure>
</div></li>
<li><p>Once the target group has been created, we will select it as the target for the load balancer‚Äôs listener.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-05.png" class="img-fluid figure-img"></p>
<figcaption>Load balancer configuration</figcaption>
</figure>
</div></li>
<li><p>Once the load balancer has been created, you must wait a few minutes until its status changes from <strong>Provisioning</strong> to <strong>Active</strong>. Once the status change to <strong>Active</strong>, you can access the load balancer through its DNS address</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-active.png" class="img-fluid figure-img"></p>
<figcaption>Active load balancer</figcaption>
</figure>
</div>
<ul>
<li>Now we can access the load balancer through its DNS address and see the WordPress installation page:</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/wp-config-01.png" class="img-fluid figure-img"></p>
<figcaption>WordPress installation through the load balancer</figcaption>
</figure>
</div>
<p>We will proceed to install WordPress through the load balancer. Follow the installation steps and configure the administrator username and password. Now you have the web server configured with WordPress and the load balancer to distribute traffic between the EC2 instances.</p>
</section>
<section id="vpn-configuration" class="level2">
<h2 class="anchored" data-anchor-id="vpn-configuration">7. VPN configuration</h2>
<section id="create-an-ec2-to-deploy-the-vpn-server" class="level3">
<h3 class="anchored" data-anchor-id="create-an-ec2-to-deploy-the-vpn-server">7.1.Create an EC2 to deploy the VPN server</h3>
<p>To deploy the VPN server, we will create a new EC2 instance that will act as the VPN server. This EC2 instance must be in a public subnet connected to the internet. We will name this instance <strong>AMSA-VPN</strong> and place it in the public subnet <strong>AMSA-DMZ-01</strong>. This EC2 instance will use the security group <strong>AMSA-VPN-SG</strong>, which will allow the necessary traffic for the VPN server to function.</p>
<ol type="1">
<li>Navigate to the AWS console and select the <strong>EC2</strong> service. In the sidebar, select <strong>Instances</strong> and then <strong>Launch Instances</strong>.</li>
<li>Select the image <strong>Ubuntu Server 22.04 LTS</strong>.</li>
<li>Select the instance <strong>t2.micro</strong>.</li>
<li>Configure the instance:
<ul>
<li><strong>Network</strong>: AMSA-VPC</li>
<li><strong>Subnet</strong>: AMSA-DMZ-01</li>
<li><strong>Auto-assign Public IP</strong>: Enable</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-VPN.png" class="img-fluid figure-img"></p>
<figcaption>EC2 instance configuration for the VPN server</figcaption>
</figure>
</div></li>
<li>Configure the security group: <strong>AMSA-VPN-SG</strong>.</li>
</ol>
<p>If you review the installation documentation for the OpenVPN server: OpenVPN: <a href="https://openvpn.net/images/pdf/OpenVPN_Access_Server_Sysadmin_Guide_Rev.pdf">OpenVPN Access Server System Administrator Guide</a>, you will see that we need the following ports open: <strong>TCP 943, UDP 1194</strong>.</p>
<pre><code>![Security group configuration for the VPN server](../../figs/laboratories/03-aws-wp/wordpress/AMSA-SG-VPN.png)</code></pre>
<ol start="6" type="1">
<li><p>Connect to the EC2 instance through the AWS online console or with an SSH connection and run the following command to install the OpenVPN server:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="at">-y</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install ca-certificates gnupg wget net-tools <span class="at">-y</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> wget https://as-repository.openvpn.net/as-repo-public.asc <span class="at">-qO</span> /etc/apt/trusted.gpg.d/as-repo-public.asc</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> echo <span class="st">"deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/as-repo-public.asc] http://as-repository.openvpn.net/as/debian jammy main"</span> <span class="kw">|</span> <span class="fu">sudo</span> tee /etc/apt/sources.list.d/openvpn-as-repo.list</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt install openvpn-as <span class="at">-y</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-config.png" class="img-fluid figure-img"></p>
<figcaption>OpenVPN server installation</figcaption>
</figure>
</div></li>
<li><p>With these credentials, you will be able to access the OpenVPN server‚Äôs web interface through your web browser. Navigate to the public IP of the EC2 instance (in my case https://44.199.196.242:943/admin). Since we don‚Äôt have the SSL certificate configured, a warning message will appear‚Äîignore it and continue. Log in with the credentials you configured earlier..</p>
<blockquote class="blockquote">
<p>Note: If you have lost the <code>openvpn</code> user credentials, you can recover them by checking the OpenVPN server log file. For example, you can view the log file with the following command:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> less /usr/local/openvpn_as/init.log </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</blockquote>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-login.png" class="img-fluid figure-img"></p>
<figcaption>OpenVPN server web interface</figcaption>
</figure>
</div>
<ul>
<li>Accept the license terms..</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-accept-terms.png" class="img-fluid figure-img"></p>
<figcaption>Accepting the license terms.</figcaption>
</figure>
</div>
<ul>
<li><p>Go to <strong>VPN Server/Network Settings</strong> and set the <strong>Hostname or IP Address</strong> to the public IP of the EC2 instance where your OpenVPN server is running. Once done, click <strong>Save</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-01.png" class="img-fluid figure-img"></p>
<figcaption>Configuring the VPN Server‚Äôs Public IP</figcaption>
</figure>
</div></li>
<li><p>Go to <strong>Access Controls/Internet Access and DNS</strong> and select the <strong>Split Tunnel</strong> option to prevent all client traffic from being redirected through the VPN. Only traffic destined for the VPC subnets will be routed through the VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-Split-Tunnel.png" class="img-fluid figure-img"></p>
<figcaption>Configuring Split Tunnel</figcaption>
</figure>
</div></li>
<li><p>Go to <strong>Access Controls/Global Access Rules</strong> and add a rule to allow VPN traffic to the VPC subnets:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-Global-Acces.png" class="img-fluid figure-img"></p>
<figcaption>Configuring Global Access Rules</figcaption>
</figure>
</div></li>
<li><p>Go to <strong>User</strong> and create a username and password to connect to the VPN server.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-User.png" class="img-fluid figure-img"></p>
<figcaption>Creating a VPN Server User</figcaption>
</figure>
</div></li>
<li><p>Once you have the configuration file, you can <strong>Restart</strong> the OpenVPN service to apply all changes. Then, access the OpenVPN server web interface again.</p></li>
<li><p>Go to <strong>User/user/Connection Profiles</strong> and create a default connection profile. Once created, a configuration file will be downloaded, which we will later use to connect to the VPN server.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-Connection-Profile.png" class="img-fluid figure-img"></p>
<figcaption>Downloading the VPN client configuration file</figcaption>
</figure>
</div></li>
<li><p>Install the <a href="https://openvpn.net/client/">OpenVPN Connect</a> application on your computer. This application is the VPN client we will use to connect to the VPN server.</p></li>
<li><p>Once installed, open the application and import the configuration file you downloaded earlier.</p></li>
</ul></li>
<li><p>Once everything is configured, we will update the security group of the EC2 instances to allow traffic on port 22 only from the VPN server. This means that the EC2 instances will only accept SSH traffic from the VPN server and not from any other source.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ec2-ssh-only-vpn.png" class="img-fluid figure-img"></p>
<figcaption>Configuring SSH traffic to EC2 from the VPN server.</figcaption>
</figure>
</div></li>
</ol>
<p>At this point, you will no longer be able to access the EC2 instances running the WordPress service via SSH, since SSH traffic is only allowed from the VPN server. To access the EC2 instances, you must first connect to the VPN server and then connect to the EC2 instances. To do this:</p>
<ul>
<li><p>Import the OpenVPN Connect client configuration file into the application and connect to the VPN server.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-01.png" class="img-fluid figure-img"></p>
<figcaption>Connecting to the VPN Server</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p><strong>TroubleShooting</strong>: If you see in the configuration file (<strong>Server Hostname</strong>) an IP in the range 10.0.X.X, this means that the VPN has not been configured correctly. Make sure to restart the server and download the client configuration file again; it must include the VPN server‚Äôs public IP address.</p>
</blockquote></li>
<li><p>Use the same password as the user <code>openvpn</code> to connect to the VPN server.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-02.png" class="img-fluid figure-img"></p>
<figcaption>Connection to the VPN server</figcaption>
</figure>
</div></li>
<li><p>If everything went well, you will see that you are connected to the VPN server.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-03.png" class="img-fluid figure-img"></p>
<figcaption>Connection to the VPN server</figcaption>
</figure>
</div></li>
</ul>
<p>Finally, connect to the EC2 instances:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-SSH.png" class="img-fluid figure-img"></p>
<figcaption>Access to EC2 instances through the VPN server</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p><strong>Important considerations</strong>: The VPN server allows us to access the EC2 instances via SSH, but using the internal address (10.0.X.X) of the EC2 instance. We will not be able to access the EC2 instances through their public address because we have configured the VPN to access the VPC subnets.</p>
</blockquote>
</section>
</section>
<section id="cleanup" class="level2">
<h2 class="anchored" data-anchor-id="cleanup">8. Cleanup</h2>
<p>Once completed, you can delete all EC2 instances and the RDS database to avoid unnecessary charges to your AWS account.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/francescsolsonatehas\.github\.io\/AMSA-AWS\/index\.html");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>