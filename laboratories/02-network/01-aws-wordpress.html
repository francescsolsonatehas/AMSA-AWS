<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ca" xml:lang="ca"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Desplegament d’una aplicació web amb alta disponibilitat amb AWS – AMSA - Fall 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-c30451789a0a2bcd5e941535c675cd30.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Cap resultat",
    "search-matching-documents-text": "documents que coincideixen",
    "search-copy-link-title": "Copia l'enllaç a la cerca",
    "search-hide-matches-text": "Amaga les coincidències addicionals",
    "search-more-match-text": "altra coincidència en aquest document",
    "search-more-matches-text": "altres coincidències en aquest document",
    "search-clear-button-title": "Neteja",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel·la",
    "search-submit-button-title": "Envia",
    "search-label": "Cerca"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Commuta la navegació de la barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Laboratoris</li><li class="breadcrumb-item"><a href="../../laboratories/02-network/01-aws-wordpress.html">Networking</a></li><li class="breadcrumb-item"><a href="../../laboratories/02-network/01-aws-wordpress.html">Laboratori 03 · Desplegament d’una aplicació web amb alta disponibilitat amb AWS</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Commuta la navegació de la barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../figs/logo.png" alt="AMSA Logo" class="sidebar-logo light-content py-0 d-lg-inline d-none">
      <img src="../../figs/logo.png" alt="AMSA Logo" class="sidebar-logo dark-content py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="../../index.html" title="Home" class="quarto-navigation-tool px-1" aria-label="Home"><i class="bi bi-house"></i></a>
    <a href="https://github.com/amsa-gei-udl-2526-105013/course/" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <a href="https://cv.udl.cat/" title="Sakai" class="quarto-navigation-tool px-1" aria-label="Sakai"><i class="bi bi-person-fill"></i></a>
</div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Informació del curs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../.././course-information/schedule.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Planificació</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Diapositives</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/01-foundations-of-systems-administration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 01 · Fonaments de l’Administració de Sistemes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/02-booting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 02 · Arrencada del sistema</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/02-booting-part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 02 · Arrencada del sistema (Part 2)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/02-booting-part3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 02 · Arrencada del sistema (Part 3)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/03-filesystem-part1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 03 · Sistemes de fitxers (Part 1)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/03-filesystem-part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 03 · Sistemes de fitxers (Part 2)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slides/03-filesystem-part3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unitat 03 · Sistemes de fitxers (Part 3)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Activitats</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Unitat 01 · Fonaments de l’Administració de Sistemes</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/01-foundations-of-systems-administration/01-ex-week1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 1 · Configuració d’entorn de virtualització</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/01-foundations-of-systems-administration/02-ex-week1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 2 · Emulació en mode d’usuari amb QEMU</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Unitat 02 · Arrencada del sistema</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/01-ex-week2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 1 · Booting amb MBR i BIOS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/02-ex-week2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 2 · Booting amb UEFI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/03-ex-week2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 3 · Dual Boot amb UEFI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/04-ex-week3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 4 · Modificant la contrasenya de l’usuari root a través del GRUB</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/05-ex-week3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 5 · Arrencada automàtica d’una partició LUKS amb clau en un disc secundari</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/06-ex-week4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 6 · Anàlisi del procés d’arrencada amb systemd</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/02-booting/07-ex-week4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 7 · Servei de Còpia de Seguretat Automàtica amb systemd</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Unitat 03 · Sistemes de fitxers</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/03-fs/08-ex-week5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 8 · Administració bàsica de Sistemes de Fitxers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/03-fs/09-ex-week6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 9 · Configuració de RAIDs amb mdadm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../exercises/03-fs/10-ex-week7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activitat 10 · Administració de volums lògics amb LVM</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Laboratoris</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">Unitat 01 · Fonaments de l’Administració de Sistemes</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../laboratories/01-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laboratori · Fonaments de l’Administració de Sistemes amb AWS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../laboratories/01-foundations/01-aws-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laboratori 01 · Introducció a AWS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../laboratories/01-foundations/02-aws-wordpress.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laboratori 02 · Desplegament d’una aplicació web amb AWS</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true">
 <span class="menu-text">Networking</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../laboratories/02-network/01-aws-wordpress.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Laboratori 03 · Desplegament d’una aplicació web amb alta disponibilitat amb AWS</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">Projectes</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Commuta la secció">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/01-project/01-project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Projecte 1 · Snapshots i Backups amb systemd i initramfs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/02-project/02-project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Projecte 2 · Diagnòstic i Resolució d’Incidències</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">En aquesta pàgina</h2>
   
  <ul>
  <li><a href="#diagrama-de-larquitectura" id="toc-diagrama-de-larquitectura" class="nav-link active" data-scroll-target="#diagrama-de-larquitectura">Diagrama de l’Arquitectura</a></li>
  <li><a href="#objectius" id="toc-objectius" class="nav-link" data-scroll-target="#objectius">Objectius</a></li>
  <li><a href="#requeriments-prèvis" id="toc-requeriments-prèvis" class="nav-link" data-scroll-target="#requeriments-prèvis">Requeriments Prèvis</a></li>
  <li><a href="#vpc-i-subxarxes" id="toc-vpc-i-subxarxes" class="nav-link" data-scroll-target="#vpc-i-subxarxes">VPC i Subxarxes</a>
  <ul class="collapse">
  <li><a href="#creació-de-les-subxarxes" id="toc-creació-de-les-subxarxes" class="nav-link" data-scroll-target="#creació-de-les-subxarxes">Creació de les subxarxes</a></li>
  </ul></li>
  <li><a href="#taules-denrutament-i-associacions" id="toc-taules-denrutament-i-associacions" class="nav-link" data-scroll-target="#taules-denrutament-i-associacions">Taules d’Enrutament i Associacions</a>
  <ul class="collapse">
  <li><a href="#configuració-del-gateway-dinternet" id="toc-configuració-del-gateway-dinternet" class="nav-link" data-scroll-target="#configuració-del-gateway-dinternet">Configuració del Gateway d’Internet</a></li>
  <li><a href="#creació-de-les-taules-de-rutes" id="toc-creació-de-les-taules-de-rutes" class="nav-link" data-scroll-target="#creació-de-les-taules-de-rutes">Creació de les taules de rutes</a></li>
  </ul></li>
  <li><a href="#grups-de-seguretat" id="toc-grups-de-seguretat" class="nav-link" data-scroll-target="#grups-de-seguretat">Grups de Seguretat</a>
  <ul class="collapse">
  <li><a href="#grup-de-seguretat-per-a-les-instàncies-ec2" id="toc-grup-de-seguretat-per-a-les-instàncies-ec2" class="nav-link" data-scroll-target="#grup-de-seguretat-per-a-les-instàncies-ec2">Grup de Seguretat per a les instàncies EC2</a></li>
  <li><a href="#grup-de-seguretat-per-a-la-base-de-dades-rds" id="toc-grup-de-seguretat-per-a-la-base-de-dades-rds" class="nav-link" data-scroll-target="#grup-de-seguretat-per-a-la-base-de-dades-rds">Grup de Seguretat per a la base de dades RDS</a></li>
  <li><a href="#resum" id="toc-resum" class="nav-link" data-scroll-target="#resum">Resum</a></li>
  </ul></li>
  <li><a href="#creació-de-la-base-de-dades-rds" id="toc-creació-de-la-base-de-dades-rds" class="nav-link" data-scroll-target="#creació-de-la-base-de-dades-rds">Creació de la Base de Dades RDS</a></li>
  <li><a href="#creació-de-les-instàncies-ec2" id="toc-creació-de-les-instàncies-ec2" class="nav-link" data-scroll-target="#creació-de-les-instàncies-ec2">Creació de les instàncies EC2</a></li>
  <li><a href="#configuració-del-servidor-web-amb-wordpress" id="toc-configuració-del-servidor-web-amb-wordpress" class="nav-link" data-scroll-target="#configuració-del-servidor-web-amb-wordpress">Configuració del Servidor Web amb WordPress</a>
  <ul class="collapse">
  <li><a href="#configuració-del-balancejador-de-càrrega" id="toc-configuració-del-balancejador-de-càrrega" class="nav-link" data-scroll-target="#configuració-del-balancejador-de-càrrega">Configuració del Balancejador de Càrrega</a></li>
  <li><a href="#configuració-vpn" id="toc-configuració-vpn" class="nav-link" data-scroll-target="#configuració-vpn">Configuració VPN</a>
  <ul class="collapse">
  <li><a href="#ec2-per-desplegar-el-servidor-vpn" id="toc-ec2-per-desplegar-el-servidor-vpn" class="nav-link" data-scroll-target="#ec2-per-desplegar-el-servidor-vpn">EC2 per desplegar el servidor VPN</a></li>
  </ul></li>
  <li><a href="#neteja-els-recursos-creats" id="toc-neteja-els-recursos-creats" class="nav-link" data-scroll-target="#neteja-els-recursos-creats">Neteja els recursos creats</a></li>
  <li><a href="#exercics-adicionals" id="toc-exercics-adicionals" class="nav-link" data-scroll-target="#exercics-adicionals">Exercics Adicionals</a></li>
  <li><a href="#recursos-addicionals" id="toc-recursos-addicionals" class="nav-link" data-scroll-target="#recursos-addicionals">Recursos Addicionals</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Laboratoris</li><li class="breadcrumb-item"><a href="../../laboratories/02-network/01-aws-wordpress.html">Networking</a></li><li class="breadcrumb-item"><a href="../../laboratories/02-network/01-aws-wordpress.html">Laboratori 03 · Desplegament d’una aplicació web amb alta disponibilitat amb AWS</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Desplegament d’una aplicació web amb alta disponibilitat amb AWS</h1>
<p class="subtitle lead">Laboratoris Pràctics d’Administració de Sistemes i Aplicacions</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>En aquest laboratori intensiu, dissenyarem i implementarem una arquitectura de xarxa robusta i segura per allotjar una aplicació de WordPress. L’arquitectura es basa en la separació de capes (<strong>pública, aplicació, dades</strong>) i l’ús de <strong>Zones de Disponibilitat (AZ)</strong> per garantir que el nostre WordPress sigui altament disponible i resistent a fallades.</p>
<ul>
<li><strong>Instàncies EC2 (WordPress)</strong>: Distribuïdes en subxarxes privades de diferents AZs, accessibles només a través del Balancejador de Càrrega, mai directament des d’Internet.</li>
<li><strong>Base de Dades RDS (MySQL)</strong>: Servei gestionat d’alta disponibilitat, també en subxarxes privades dedicades.</li>
<li><strong>DMZ</strong>: Una instància EC2 en una subxarxa pública que actuarà com a punt d’accés segur (mitjançant túnel SSH) per a la gestió de tots els recursos privats.</li>
<li><strong>Load Balancer</strong>: El punt d’entrada públic que assegura la distribució uniforme del tràfic a les instàncies de WordPress.</li>
</ul>
<section id="diagrama-de-larquitectura" class="level2">
<h2 class="anchored" data-anchor-id="diagrama-de-larquitectura">Diagrama de l’Arquitectura</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/infra.png" class="img-fluid figure-img"></p>
<figcaption>Esquema de components, conexions i elements de l’arquitectura</figcaption>
</figure>
</div>
<p>La imatge mostra com a través d’internet, els usuaris accedeixen al Load Balancer, que distribueix el tràfic a les instàncies EC2 que allotgen WordPress. Aquestes instàncies es connecten a la base de dades RDS per gestionar el contingut de WordPress. La instància EC2 en la DMZ permet l’accés segur per a l’administració dels recursos privats.</p>
</section>
<section id="objectius" class="level2">
<h2 class="anchored" data-anchor-id="objectius">Objectius</h2>
<ul>
<li>Dissenyar i implementar una arquitectura de xarxa segura i altament disponible a AWS.</li>
<li>Configurar VPCs, subxarxes, taules de rutes i grups de seguretat.</li>
<li>Configurar una VPN segura per a l’accés administratiu.</li>
<li>Configurar un load balancer per distribuir el tràfic a les instàncies EC2.</li>
</ul>
</section>
<section id="requeriments-prèvis" class="level2">
<h2 class="anchored" data-anchor-id="requeriments-prèvis">Requeriments Prèvis</h2>
<ul>
<li>Accés al curs AWS Academy Learner Lab.</li>
<li>Completar el laboratori <a href="../../laboratories/01-foundations/02-aws-wordpress.html">Desplegament d’una aplicació web amb AWS</a> per entendre els conceptes bàsics d’AWS i la configuració inicial de WordPress.</li>
</ul>
</section>
<section id="vpc-i-subxarxes" class="level2">
<h2 class="anchored" data-anchor-id="vpc-i-subxarxes">VPC i Subxarxes</h2>
<p>El primer pas en la nostra arquitectura és definir una VPC (Virtual Private Cloud) i les subxarxes necessàries per aïllar els diferents components de l’aplicació. La VPC proporcionarà un entorn de xarxa virtualitzat on podrem desplegar els nostres recursos d’AWS. La configurarem amb la xarxa <strong>10.0.0.0/16</strong>, la qual ens proporciona fins a 65.536 adreces IP, més que suficients per al nostre cas d’ús.</p>
<div class="callout callout-style-default callout-note callout-titled" title="CIDR, Hosts i Adreces Reservades 🧠">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Nota</span>CIDR, Hosts i Adreces Reservades 🧠
</div>
</div>
<div class="callout-body-container callout-body">
<p>La màscara de subxarxa determina el nombre d’adreces IP disponibles dins d’una xarxa o subxarxa. Això s’expressa mitjançant la Notació CIDR (Classless Inter-Domain Routing), on el valor (/n) indica la quantitat de bits reservats per a la part de Xarxa. Una màscara de subxarxa de <em>/16</em> significa que els primers 16 bits de l’adreça IP estan reservats per a la identificació de la xarxa, deixant els altres 16 bits per a la identificació dels hosts. Això permet tenir fins a 65.536 adreces IP (<span class="math inline">\(2^{32-16}\)</span>) dins d’aquesta xarxa.</p>
<p>Quan feu el Subnetting per crear subxarxes dins de la vostra VPC, esteu augmentant el valor CIDR (per exemple, de /16 a /24), per tal de reduir la mida de les subxarxes i aïllar millor el tràfic. Per exemple, una subxarxa amb CIDR /24 té 256 adreces IP (<span class="math inline">\(2^{32-24}\)</span>).</p>
<p>Recordeu que el total d’adreces calculat no és el total d’adreces útils per als vostres servidors (hosts). Algunes adreces es reserven per a usos especials, com identificar la xarxa i la difusió (broadcast).</p>
</div>
</div>
<p>Podem definir la VPC a través de la interfície web d’AWS, utilitzant els formularis disponibles:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpc.png" class="img-fluid figure-img"></p>
<figcaption>Definició de la VPC utilitzant AWS</figcaption>
</figure>
</div>
<section id="creació-de-les-subxarxes" class="level3">
<h3 class="anchored" data-anchor-id="creació-de-les-subxarxes">Creació de les subxarxes</h3>
<p>A continuació, afegirem les subxarxes necessàries per a la nostra arquitectura. Aneu a <strong>VPC</strong> → <strong>Subnets</strong> → <strong>Create subnet</strong>. Seleccioneu la VPC que acabem de crear i afegiu les subxarxes següents:</p>
<ul>
<li><strong>AMSA-DMZ-01</strong>: Subxarxa pública a la zona <strong>us-east-1a</strong>. Aquesta subxarxa allotjarà la instància EC2 que farà de pont segur d’accés (mitjançant túnel SSH) per a la gestió de tots els recursos privats. <em>(10.0.1.0/24)</em>.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ-01.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-DMZ-01</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-DMZ-02</strong>: Subxarxa pública a la zona <strong>us-east-1b</strong>. Aquesta subxarxa allotjarà la instància EC2 que farà de pont segur d’accés (mitjançant túnel SSH) per a la gestió de tots els recursos privats. <em>(10.0.2.0/24)</em>.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ-02.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-DMZ-02</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-Private01</strong>: Subxarxa privada per a les instàncies de WordPress a la zona de disponibilitat <strong>us-east-1a</strong>. <em>(10.0.3.0/24)</em>.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Private01.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-Private01</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-Private02</strong>: Subxarxa privada per a les instàncies de WordPress a la zona de disponibilitat <strong>us-east-1b</strong>. <em>(10.0.4.0/24)</em></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Private02.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-Private02</figcaption>
</figure>
</div>
<ul>
<li><strong>AMSA-Data</strong>: Subxarxa privada per a dades a la zona de disponibilitat <strong>us-east-1c</strong>. <em>(10.0.5.0/24)</em></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Data.png" class="img-fluid figure-img"></p>
<figcaption>AMSA-Data</figcaption>
</figure>
</div>
</section>
</section>
<section id="taules-denrutament-i-associacions" class="level2">
<h2 class="anchored" data-anchor-id="taules-denrutament-i-associacions">Taules d’Enrutament i Associacions</h2>
<p>Per gestionar les rutes del tràfic i determinar com es distribueix entre les subxarxes, crearem taules de rutes i les associem a les subxarxes corresponents.</p>
<section id="configuració-del-gateway-dinternet" class="level3">
<h3 class="anchored" data-anchor-id="configuració-del-gateway-dinternet">Configuració del Gateway d’Internet</h3>
<p>Utilitzarem un <strong>Gateway d’Internet (IGW)</strong> per permetre que les subxarxes públiques <em>(AMSA-DMZ-01 i AMSA-DMZ-02</em>) tinguin accés a Internet tant per a tràfic entrant com sortint. Per fer-ho, primer crearem el IGW i després l’associarem a la nostra VPC.</p>
<p>El primer pas és crear el Gateway d’Internet. Aneu a <strong>VPC</strong> → <strong>Internet Gateways</strong> → <strong>Create internet gateway</strong>. Un cop creat, l’anomeneu <strong>AMSA-IG</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ig.png" class="img-fluid figure-img"></p>
<figcaption>Gateway d’Internet per a la VPC</figcaption>
</figure>
</div>
<p>El segon pas és associar el Gateway d’Internet amb la VPC. Seleccioneu el Gateway d’Internet que acabem de crear i feu clic a <strong>Actions</strong> → <strong>Attach to VPC</strong>. Seleccioneu la VPC <strong>AMSA-VPC</strong> i feu clic a <strong>Attach internet gateway</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/attachIG.png" class="img-fluid figure-img"></p>
<figcaption>Associació del Gateway d’Internet amb la VPC</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/attachIG2.png" class="img-fluid figure-img"></p>
<figcaption>Associació del Gateway d’Internet amb la VPC</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="Attached IGW 🛑">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Alerta</span>Attached IGW 🛑
</div>
</div>
<div class="callout-body-container callout-body">
<p>Assegureu-vos que el Gateway d’Internet estigui correctament associat a la VPC. Si no està associat, les subxarxes públiques no podran accedir a Internet.</p>
</div>
</div>
</section>
<section id="creació-de-les-taules-de-rutes" class="level3">
<h3 class="anchored" data-anchor-id="creació-de-les-taules-de-rutes">Creació de les taules de rutes</h3>
<p>Cada subxarxa necessita una taula de rutes per definir com es dirigeix el tràfic sortint i entrant. Crearem taules de rutes específiques per a cada tipus de subxarxa (pública i privada) i les associem a les subxarxes corresponents.</p>
<section id="enrutament-per-a-les-subxarxes-públiques-dmz" class="level4">
<h4 class="anchored" data-anchor-id="enrutament-per-a-les-subxarxes-públiques-dmz">Enrutament per a les subxarxes públiques (DMZ)</h4>
<p>El primer pas és crear la taula de rutes per a les subxarxes públiques. Aneu a <strong>VPC</strong> → <strong>Route Tables</strong> → <strong>Create route table</strong>. Seleccioneu la VPC <strong>AMSA-VPC</strong> i anomeneu la taula de rutes <strong>AMSA-DMZ01-RT</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ01-RT.png" class="img-fluid figure-img"></p>
<figcaption>Taula de rutes per a la subxarxa AMSA-DMZ01-RT</figcaption>
</figure>
</div>
<p>El segon pas és associar la taula de rutes (<em>AMSA-DMZ01-RT</em>) amb la subxarxa <strong>AMSA-DMZ-01</strong> i permetre el tràfic de sortida a Internet a través del Gateway d’Internet que hem creat anteriorment.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-DMZ-Subnet-Association.png" class="img-fluid figure-img"></p>
<figcaption>Associació de la taula de rutes amb la subxarxa AMSA-DMZ-01</figcaption>
</figure>
</div>
<p>El tercer pas és permetre el tràfic de sortida a Internet a través del Gateway d’Internet que hem creat anteriorment. Per fer-ho aneu a la secció <em>Routes</em> i clicareu a <em>Edit routes</em>. A continuació, <strong>Add route</strong> i editareu (Destination: 0.0.0.0/0; Target:Seleccionar el <strong>AMSA-IG</strong>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/IG.png" class="img-fluid figure-img"></p>
<figcaption>Permetem el tràfic amb l’exterior a través del IG</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="AMSA-DMZ-02 🛑">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Alerta</span>AMSA-DMZ-02 🛑
</div>
</div>
<div class="callout-body-container callout-body">
<p>Realitzeu els mateixos passos per a la subxarxa <strong>AMSA-DMZ-02</strong>, modificant només el nom de la taula de rutes i l’associació amb la subxarxa.</p>
</div>
</div>
</section>
<section id="enrutament-per-a-les-subxarxes-privades" class="level4">
<h4 class="anchored" data-anchor-id="enrutament-per-a-les-subxarxes-privades">Enrutament per a les subxarxes privades</h4>
<p>Les subxarxes privades no tenen accés directe a Internet per motius de seguretat. Per tant, necessitem configurar les taules de rutes per a aquestes subxarxes de manera que puguin accedir a Internet a través d’un NAT Gateway (Network Address Translation Gateway). Això permetrà que les instàncies dins de les subxarxes privades puguin iniciar connexions cap a l’exterior, però impedirà que l’exterior iniciï connexions cap a elles.</p>
<div class="callout callout-style-default callout-note callout-titled" title="NAT Gateway 🧠">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Nota</span>NAT Gateway 🧠
</div>
</div>
<div class="callout-body-container callout-body">
<p>Un NAT Gateway és un servei gestionat per AWS que permet a les instàncies en una subxarxa privada accedir a Internet per a actualitzacions de programari, descàrregues de paquets, etc., sense exposar aquestes instàncies directament a Internet. El NAT Gateway tradueix les adreces IP privades de les instàncies a una adreça IP pública quan aquestes instàncies fan peticions a Internet.</p>
</div>
</div>
<p>Per crear el NAT Gateway, necessitem una IP elàstica (Elastic IP). Per tant, primer crearem una IP elàstica i després la utilitzarem per crear el NAT Gateway. L’anomeneu <strong>AMSA-NAT-EIP</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ElasticIP-NAT.png" class="img-fluid figure-img"></p>
<figcaption>Creació de la IP elàstica</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ElasticIp-Nat2.png" class="img-fluid figure-img"></p>
<figcaption>Actualitzar el nom de la IP elàstica</figcaption>
</figure>
</div>
<p>Un cop tenim la IP elàstica, podem crear el NAT Gateway. L’anomeneu <strong>AMSA-NG</strong> i l’associeu a la subxarxa <strong>AMSA-DMZ-01</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/nat-gw-create.png" class="img-fluid figure-img"></p>
<figcaption>Creació del NAT Gateway</figcaption>
</figure>
</div>
<p>Crearem la taula de rutes (<em>AMSA-Private01-RT</em>) per a la subxarxa <strong>AMSA-Private01</strong> i l’associarem a la subxarxa. Aquesta taula de rutes permetrà que les instàncies dins d’aquesta subxarxa accedeixin a Internet a través del NAT Gateway.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-Private01-RT.png" class="img-fluid figure-img"></p>
<figcaption>Taula de rutes per a la subxarxa AMSA-Private01</figcaption>
</figure>
</div>
<p>El segon pas és associar la taula de rutes (<em>AMSA-Private01-RT</em>) amb la subxarxa <strong>AMSA-Private01</strong> i permetre el tràfic de sortida a Internet a través del NAT Gateway que hem creat anteriorment.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/AMSA-Private01-RT-create.png" class="img-fluid figure-img"></p>
<figcaption>Creació de la taula de rutes per a la subxarxa AMSA-Private01</figcaption>
</figure>
</div>
<p>El tercer pas és permetre el tràfic de sortida a Internet a través del NAT Gateway que hem creat anteriorment. Per fer-ho aneu a la secció <em>Routes</em> i clicareu a <em>Edit routes</em>. A continuació, <strong>Add route</strong> i editareu (Destination: 0.0.0.0/0; Target:Seleccionar el <strong>AMSA-NG</strong>).</p>
<div class="callout callout-style-default callout-warning callout-titled" title="AMSA-Private02 🛑">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Alerta</span>AMSA-Private02 🛑
</div>
</div>
<div class="callout-body-container callout-body">
<p>Repetiu els mateixos passos per a la subxarxa <strong>AMSA-Private02</strong>, modificant només el nom de la taula de rutes i l’associació amb la subxarxa.</p>
</div>
</div>
</section>
<section id="enrutament-per-a-la-subxarxa-de-dades-amsa-data" class="level4">
<h4 class="anchored" data-anchor-id="enrutament-per-a-la-subxarxa-de-dades-amsa-data">Enrutament per a la subxarxa de dades (AMSA-Data)</h4>
<p>La subxarxa <strong>AMSA-Data</strong> no allotjarà instàncies que necessitin accés a Internet. Per tant, no necessitem configurar cap ruta per a aquesta subxarxa. Crearem una taula de rutes buida i l’associarem a la subxarxa <strong>AMSA-Data</strong>. Aquesta xarxa serà completament aïllada i només permetrà la comunicació interna dins de la VPC.</p>
</section>
</section>
</section>
<section id="grups-de-seguretat" class="level2">
<h2 class="anchored" data-anchor-id="grups-de-seguretat">Grups de Seguretat</h2>
<p>Els grups de seguretat (Security Groups) són una eina per controlar el tràfic de xarxa de les instàncies i altres recursos d’AWS, actuant com un tallafocs virtual. Permeten definir regles que especifiquen quines connexions estan permeses tant d’entrada (inbound) com de sortida (outbound).</p>
<ul>
<li><strong>Trafic inbound</strong>: Permet decidir quins tipus de connexions entrants (cap al recurs) són permeses.</li>
<li><strong>Trafic outbound</strong>: Controla quines connexions sortints (des del recurs cap a altres destinacions) estan autoritzades.</li>
</ul>
<section id="grup-de-seguretat-per-a-les-instàncies-ec2" class="level3">
<h3 class="anchored" data-anchor-id="grup-de-seguretat-per-a-les-instàncies-ec2">Grup de Seguretat per a les instàncies EC2</h3>
<ul>
<li><strong>Connexions entrants (inbound)</strong> per als serveis web HTTP (port 80) i HTTPS (port 443), accessibles des de qualsevol origen.</li>
<li><strong>Connexions SSH (port 22)</strong> per a administració remota, també accessibles des de qualsevol origen (inicialment, però més endavant es restringiran).</li>
<li>Totes les connexions sortints (<strong>outbound</strong>), que per defecte estan permeses a AWS, cosa que permet a les instàncies EC2 comunicar-se amb altres recursos com ara RDS.</li>
</ul>
<p>Per fer-ho, navegarem a la consola de VPC d’AWS, seleccionarem la secció <em>Security Groups</em> i clicarem a <em>Create security group</em>. A continuació, omplirem els camps amb la informació necessària i clicarem a <em>Create security group</em>. El podeu anomenar <strong>AMSA-WP-SG</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-WP-SG.png" class="img-fluid figure-img"></p>
<figcaption>Grup de Seguretat per a les instàncies EC2</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Nota sobre la seguretat 🔐">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Nota</span>Nota sobre la seguretat 🔐
</div>
</div>
<div class="callout-body-container callout-body">
<p>En aquest moment, estem permetent tot el tràfic de xarxa per als serveis web i SSH. Quan ho tinguem tot configurat, restringirem aquest accés únicament al trafic entrant provinent del balancejador de càrrega pels serveis web i a la nostra xarxa interna per a SSH.</p>
</div>
</div>
</section>
<section id="grup-de-seguretat-per-a-la-base-de-dades-rds" class="level3">
<h3 class="anchored" data-anchor-id="grup-de-seguretat-per-a-la-base-de-dades-rds">Grup de Seguretat per a la base de dades RDS</h3>
<ul>
<li><strong>Connexions inbound</strong>: Només permetrà tràfic al port 3306 (MySQL) i exclusivament des de les instàncies EC2 que pertanyin al grup de seguretat <strong>AMSA-WP-SG</strong>.</li>
<li><strong>Connexions outbound</strong>: Per defecte, AWS permetrà totes les connexions sortints, cosa que garanteix que la base de dades pugui comunicar-se amb altres recursos si és necessari.</li>
</ul>
<p>Per fer-ho, navegarem a la consola de VPC d’AWS, seleccionarem la secció <em>Security Groups</em> i clicarem a <em>Create security group</em>. A continuació, omplirem els camps amb la informació necessària i clicarem a <em>Create security group</em>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-DB-SG.png" class="img-fluid figure-img"></p>
<figcaption>Grup de Seguretat per a la base de dades RDS</figcaption>
</figure>
</div>
</section>
<section id="resum" class="level3">
<h3 class="anchored" data-anchor-id="resum">Resum</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 23%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Grup de Seguretat</th>
<th>Inbound</th>
<th>Outbound</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AMSA-WP-SG</td>
<td>HTTP (80) i HTTPS (443) des de 0.0.0.0/0; SSH (22) des de 0.0.0.0/0</td>
<td>Totes permeses</td>
</tr>
<tr class="even">
<td>AMSA-DB-SG</td>
<td>MySQL (3306) des de AMSA-Web-SG</td>
<td>Totes permeses</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="creació-de-la-base-de-dades-rds" class="level2">
<h2 class="anchored" data-anchor-id="creació-de-la-base-de-dades-rds">Creació de la Base de Dades RDS</h2>
<p>La base de dades ja la vam configurar en el laboratori anterior <a href="../../laboratories/01-foundations/02-aws-wordpress.html">Desplegament d’una aplicació web amb AWS</a>. La única diferència és que ara la base de dades es troba en una subxarxa privada i només és accessible des de les instàncies EC2 que pertanyen al grup de seguretat <strong>AMSA-Web-SG</strong>.</p>
<ul>
<li><strong>Compute resources</strong>: Don’t connect to an EC2 compute resource</li>
<li><strong>VPC</strong>: AMSA-VPC</li>
<li><strong>Subnet Group</strong>: Create new DB Subnet Group</li>
<li><strong>Public accessibility</strong>: No</li>
<li><strong>VPC security group</strong>: AMSA-DB-SG</li>
<li><strong>Availability Zone</strong>: us-east-1d</li>
</ul>
</section>
<section id="creació-de-les-instàncies-ec2" class="level2">
<h2 class="anchored" data-anchor-id="creació-de-les-instàncies-ec2">Creació de les instàncies EC2</h2>
<p>Les instàncies EC2 que allotjaran WordPress es desplegaran en les subxarxes privades, recordeu que vam configurar ansible en el laboratori anterior <a href="../../laboratories/01-foundations/02-aws-wordpress.html">Desplegament d’una aplicació web amb AWS</a>. AWS ens permet crear plantilles d’instàncies (<strong>Launch Templates</strong>) que faciliten la creació d’instàncies amb una configuració predefinida. Per tant, crearem una plantilla d’instància que inclogui la configuració necessària per a les nostres instàncies EC2 de WordPress, enlloc d’utiltizar el mètode amb ansible que vam utilitzar en el laboratori anterior.</p>
</section>
<section id="configuració-del-servidor-web-amb-wordpress" class="level1">
<h1>Configuració del Servidor Web amb WordPress</h1>
<ol type="1">
<li><p>Creareu una instancia EC2 amb Amazon Linux, seleccionant la VPC <strong>AMSA-VPC</strong> i la subxarxa <strong>AMSA-DMZ-01</strong>. Assegureu-vos que l’instància utilitzi el grup de seguretat <strong>AMSA-WP-SG</strong>. La podeu anomenar <strong>AMSA-DB-Config</strong>. Seleccionar <em>assignar ip pública</em>. Aquesta instància només la farem servir per inicialitzar la base de dades i després la podrem eliminar.</p></li>
<li><p>Un cop configurada la instància, connecteu-vos-hi mitjançant SSH utilitzant la clau privada corresponent a la clau pública que vau associar a la instància durant la seva creació. I realitzeu la configuració de la base de dades MySQL per a WordPress.</p></li>
<li><p>Anem a crear una plantilla de llançament (<strong>Launch Template</strong>) per a les instàncies EC2 que allotjaran WordPress. Aquesta plantilla inclourà la configuració necessària per a les instàncies, incloent-hi el script d’instal·lació i configuració de WordPress.</p>
<ul>
<li>Nom de la plantilla: <strong>AMSA-WP-Template</strong></li>
<li>AMI: Amazon Linux 2023 (64-bit x86)</li>
<li>Instància Type: t2.micro</li>
<li>Key Pair: AMSA-KEY</li>
<li>Subxarxa: No seleccionar cap subxarxa (es seleccionarà dinàmicament)</li>
<li>Grup de Seguretat: <em>AMSA-WP-SG</em></li>
<li>Advanced Details: Afegiu el següent script a la secció de UserData.</li>
</ul></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="Script d'instal·lació i configuració de WordPress 📝">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Nota</span>Script d’instal·lació i configuració de WordPress 📝
</div>
</div>
<div class="callout-body-container callout-body">
<p>Modifiqueu les dades de connexió a la base de dades segons les vostres dades.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sudo bash install_wp.sh</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajusteu les dades següents segons les vostres dades</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="va">DB_NAME</span><span class="op">=</span><span class="st">""</span> </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="va">DB_USER</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="va">DB_USER_PASSWORD</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="va">DB_HOST</span><span class="op">=</span><span class="st">""</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$(</span><span class="fu">id</span> <span class="at">-u</span><span class="va">)</span><span class="st">"</span> <span class="ot">-ne</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Please run this script with sudo or as root."</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">dnf</span> install <span class="at">-y</span> wget php-mysqlnd httpd php-fpm php-mysqli php-json php php-devel php-gd expect</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://wordpress.org/latest.tar.gz</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> latest.tar.gz</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure WordPress</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> wordpress/wp-config-sample.php wordpress/wp-config.php</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/database_name_here/</span><span class="va">$DB_NAME</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/username_here/</span><span class="va">$DB_USER</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/password_here/</span><span class="va">$DB_USER_PASSWORD</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/localhost/</span><span class="va">$DB_HOST</span><span class="st">/g"</span> wordpress/wp-config.php</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp <span class="at">-r</span> wordpress/<span class="pp">*</span> /var/www/html/</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> sed <span class="at">-i</span> <span class="st">'s/AllowOverride None/AllowOverride All/g'</span> /etc/httpd/conf/httpd.conf</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chown <span class="at">-R</span> apache:apache /var/www</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod 2775 /var/www</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart httpd</span></code></pre></div><button title="Copia al porta-retalls" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>Un cop creada la plantilla de llançament, podeu utilitzar-la per crear instàncies EC2 amb WordPress ja configurat i preparades per connectar amb la vostra base de dades RDS. Aneu a <strong>EC2</strong> i seleccioneu <strong>Launch Instance</strong>. A continuació, seleccioneu la plantilla de llançament <strong>AMSA-WP-Template</strong> i configureu la resta de paràmetres segons les vostres necessitats.</p>
<ul>
<li>Nombre d’instàncies: 2</li>
<li>Subxarxa: Seleccioneu la subxarxa <strong>AMSA-Private01</strong> per a la primera instància i <strong>AMSA-Private02</strong> per a la segona instància. Les podeu anomenar <strong>AMSA-WP-01</strong> i <strong>AMSA-WP-02</strong> respectivament.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled" title="Nota sobre les instàncies EC2 🖥️">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Nota sobre les instàncies EC2 🖥️
</div>
</div>
<div class="callout-body-container callout-body">
<p>Aquestes instàncies no tindran IP pública, ja que només seran accessibles a través del balancejador de càrrega que configurarem més endavant. Ara mateix no podreu accedir-hi directament ni per SSH ni per HTTP.</p>
</div>
</div>
<section id="configuració-del-balancejador-de-càrrega" class="level2">
<h2 class="anchored" data-anchor-id="configuració-del-balancejador-de-càrrega">Configuració del Balancejador de Càrrega</h2>
<p>En aquest punt, crearem un balancejador de càrrega per a les nostres instàncies EC2. Aquest balancejador de càrrega serà responsable de distribuir uniformement el tràfic entre les instàncies EC2 que allotgen WordPress.</p>
<p>Existeixen 3 tipus de balancejadors de càrrega a AWS: <strong>Application Load Balancer (ALB)</strong>, <strong>Network Load Balancer (NLB)</strong> i <strong>Gateway Load Balancer (GWLB)</strong>. En aquest cas, utilitzarem un <strong>Application Load Balancer (ALB)</strong>, ja que és el recomanat per a aplicacions web que utiltizen HTTP i HTTPS.</p>
<p>Navegueu a la consola de AWS i seleccioneu el servei <strong>EC2</strong>. A la barra lateral, seleccioneu <strong>Load Balancers</strong> i després <strong>Create Load Balancer</strong>. Seleccioneu <strong>Application Load Balancer</strong> i feu clic a <strong>Create</strong>.</p>
<ul>
<li><strong>Nom del balancejador de càrrega</strong>: AMSA-ALB</li>
<li><strong>Scheme</strong>: Internet-facing</li>
<li><strong>IP Address Type</strong>: IPv4</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-01.png" class="img-fluid figure-img"></p>
<figcaption>Configuració del balancejador de càrrega</figcaption>
</figure>
</div>
<ul>
<li><p><strong>VPC</strong>: AMSA-VPC</p></li>
<li><p><strong>Availability Zones</strong>: Seleccionar les zones de disponibilitat on tenim la subxarxa pública <strong>AMSA-DMZ-01</strong> (us-east-1a) i les <strong>AMSA-DMZ-02</strong> (us-east-1b).</p></li>
<li><p><strong>Grups de Seguretat</strong>: Nou grup de seguretat (<strong>AMSA-ALB-SG</strong>), aquest grup de seguretat permetrà el tràfic d’entrada per als ports 80 (HTTP) i 443 (HTTPS) des de qualsevol origen però restringirà el tràfic de sortida a les instàncies EC2 (grup de seguretat <strong>AMSA-WP-SG</strong>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-ALB-SG.png" class="img-fluid figure-img"></p>
<figcaption>Grup de Seguretat per al balancejador de càrrega</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-03.png" class="img-fluid figure-img"></p>
<figcaption>Configuració del balancejador de càrrega</figcaption>
</figure>
</div></li>
<li><p><strong>Listeners</strong>: Crearem un listener per al port 80 (HTTP), que redirigirà el tràfic al port 80 de les instàncies EC2. Al port 443 (HTTPS) de moment no configurarem cap redirecció. Per fer-ho, primer haureu de crear un <strong>Target Group</strong>. Aquest grup es necessari per indicar al balancejador de càrrega on enviar el tràfic.</p>
<ul>
<li><em>Target Group</em>:
<ul>
<li><strong>Target Type</strong>: Instances</li>
<li><strong>Nom</strong>: AMSA-WP-TG</li>
<li><strong>Protocol</strong>: HTTP</li>
<li><strong>Port</strong>: 80</li>
<li><strong>VPC</strong>: AMSA-VPC</li>
<li><strong>Health checks</strong>: HTTP, ruta <strong>/</strong></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/tg-03.png" class="img-fluid figure-img"></p>
<figcaption>Configuració del target group</figcaption>
</figure>
</div></li>
</ul></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Health Check 🎯">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Nota</span>Health Check 🎯
</div>
</div>
<div class="callout-body-container callout-body">
<p>El balancejador de càrrega comprova la salut de les instàncies EC2 a través del port 80 i la ruta <strong>/</strong>. Això significa que el balancejador de càrrega enviarà tràfic a les instàncies EC2 que responguin correctament a les peticions HTTP a la ruta <strong>/</strong>. Com que les nostres instàncies EC2 tenen WordPress instal·lat, aquestes instàncies respondran correctament a les peticions HTTP a la ruta <strong>/</strong>. <em>Podem deixar la configuració per defecte</em>. La instal·lació de WordPress inclou una pàgina d’inici que respondrà amb 302 (Found) quan s’accedeixi a la ruta arrel (/), per això pot passar que el health check mostri que la instància no està saludable. Un cop configurat el WordPress, el health check mostrarà que la instància està saludable.</p>
</div>
</div>
<ul>
<li><p>Seleccionarem les dos instàncies EC2 que allotgen WordPress (AMSA-WP-01 i AMSA-WP-02) i les afegirem al target group. Utilitzant el botó <strong>Include as pending below</strong> i després <strong>Add to registered</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/tg-04.png" class="img-fluid figure-img"></p>
<figcaption>Configuració del target group</figcaption>
</figure>
</div></li>
<li><p>Un cop creat el target group, el seleccionarem com a target del listener del balancejador de càrrega.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-05.png" class="img-fluid figure-img"></p>
<figcaption>Configuració del balancejador de càrrega</figcaption>
</figure>
</div></li>
<li><p>Un cop creat el balancejador de càrrega, heu d’esperar uns minuts fins que el seu estat passi de <strong>Provisioning</strong> a <strong>Active</strong>. Un cop l’estat sigui <strong>Active</strong>, podeu accedir al balancejador de càrrega a través de la seva adreça DNS.</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/lb-active.png" class="img-fluid figure-img"></p>
<figcaption>Balancejador de càrrega actiu</figcaption>
</figure>
</div>
<ul>
<li>Ara ja podem accedir al balancejador de càrrega a través de la seva adreça DNS i veure la pàgina d’instal·lació de WordPress:</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/wp-config-01.png" class="img-fluid figure-img"></p>
<figcaption>Instal·lació de WordPress a través del balancejador de càrrega</figcaption>
</figure>
</div>
<p>Procedirem a instal·lar WordPress a través del balancejador de càrrega. Seguiu els passos de la instal·lació i configureu l’usuari administrador i la contrasenya. Ara ja teniu el servidor web configurat amb WordPress i el balancejador de càrrega per distribuir el tràfic entre les instàncies EC2.</p>
</section>
<section id="configuració-vpn" class="level2">
<h2 class="anchored" data-anchor-id="configuració-vpn">Configuració VPN</h2>
<section id="ec2-per-desplegar-el-servidor-vpn" class="level3">
<h3 class="anchored" data-anchor-id="ec2-per-desplegar-el-servidor-vpn">EC2 per desplegar el servidor VPN</h3>
<p>Per desplegar el servidor VPN, crearem una nova instància EC2 que actuarà com a servidor VPN. Aquesta instància EC2 haurà d’estar en una subxarxa pública connectada a interent. Anomenarem aquesta instància <strong>AMSA-VPN</strong> i la situarem a la subxarxa pública <strong>AMSA-DMZ-01</strong>. Aquesta instància EC2 utilitzarà el grup de seguretat <strong>AMSA-VPN-SG</strong> que permetrà el tràfic necessari per al funcionament del servidor VPN.</p>
<ol type="1">
<li><p>Navegueu a la consola de AWS i seleccioneu el servei <strong>EC2</strong>. A la barra lateral, seleccioneu <strong>Instances</strong> i després <strong>Launch Instances</strong>.</p></li>
<li><p>Seleccioneu la imatge <strong>Ubuntu Server 22.04 LTS</strong>.</p></li>
<li><p>Seleccioneu la instància <strong>t2.micro</strong>.</p></li>
<li><p>Configureu la instància:</p>
<ul>
<li><strong>Network</strong>: AMSA-VPC</li>
<li><strong>Subnet</strong>: AMSA-DMZ-01</li>
<li><strong>Auto-assign Public IP</strong>: Enable</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-VPN.png" class="img-fluid figure-img"></p>
<figcaption>Configuració de la instància EC2 per al servidor VPN</figcaption>
</figure>
</div></li>
<li><p>Configureu el grup de seguretat: <strong>AMSA-VPN-SG</strong>.</p>
<p>Si reviseu la documentació d’instal·lació del servidor OpenVPN: <a href="https://openvpn.net/images/pdf/OpenVPN_Access_Server_Sysadmin_Guide_Rev.pdf">OpenVPN Access Server System Administrator Guide</a>. Veure que necessitem els següents ports oberts: <strong>TCP 943, UDP 1194</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/AMSA-SG-VPN.png" class="img-fluid figure-img"></p>
<figcaption>Configuració del grup de seguretat per al servidor VPN</figcaption>
</figure>
</div></li>
<li><p>Connecteu-vos a la instància EC2 a través de la consola online de AWS o amb una connexió SSH i executeu la següent comanda per instal·lar el servidor OpenVPN:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="at">-y</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install ca-certificates gnupg wget net-tools <span class="at">-y</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> wget https://as-repository.openvpn.net/as-repo-public.asc <span class="at">-qO</span> /etc/apt/trusted.gpg.d/as-repo-public.asc</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> echo <span class="st">"deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/as-repo-public.asc] http://as-repository.openvpn.net/as/debian jammy main"</span> <span class="kw">|</span> <span class="fu">sudo</span> tee /etc/apt/sources.list.d/openvpn-as-repo.list</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt install openvpn-as <span class="at">-y</span></span></code></pre></div><button title="Copia al porta-retalls" class="code-copy-button"><i class="bi"></i></button></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-config.png" class="img-fluid figure-img"></p>
<figcaption>Instal·lació del servidor OpenVPN</figcaption>
</figure>
</div></li>
<li><p>Amb aquestes credencials, podreu accedir a la interfície web del servidor OpenVPN a través del vostre navegador web. Navegueu a la IP pública de la instància EC2 (en el meu cas https://44.199.196.242:943/admin), com no tenim el certificat SSL configurat, ens sortirà un missatge d’advertència, ignoreu-lo i continueu. Inicieu sessió amb les credencials que heu configurat anteriorment.</p>
<blockquote class="blockquote">
<p>Nota: Si heu perdut les credencials de l’usuari <code>openvpn</code>, les podeu recuperar consultat el fitxer de logs del servidor OpenVPN. Per exemple, podeu consultar el fitxer de logs amb la següent comanda:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> less /usr/local/openvpn_as/init.log </span></code></pre></div><button title="Copia al porta-retalls" class="code-copy-button"><i class="bi"></i></button></div>
</blockquote>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-login.png" class="img-fluid figure-img"></p>
<figcaption>Interfície web del servidor OpenVPN</figcaption>
</figure>
</div>
<ul>
<li>Accepteu els termes de llicència.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-accept-terms.png" class="img-fluid figure-img"></p>
<figcaption>Acceptació dels termes de llicència</figcaption>
</figure>
</div>
<ul>
<li><p>Aneu a <strong>VPN Server/Network Settings</strong> i configureu el <strong>Hostname or IP Address</strong> amb la IP pública de la instància EC2 on teniu el servidor OpenVPN. Un cop fet, clicareu a <strong>Save</strong>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-01.png" class="img-fluid figure-img"></p>
<figcaption>Configuració de la IP pública del servidor VPN</figcaption>
</figure>
</div></li>
<li><p>Aneu a <strong>Access Controls/Internet Access and DNS</strong> i seleccioneu l’opció <strong>Split Tunnel</strong> per evitar que tot el tràfic del client sigui redirigit a través de la VPN. Únicament el tràfic dirigit a les subxarxes de la VPC serà redirigit a través de la VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-Split-Tunnel.png" class="img-fluid figure-img"></p>
<figcaption>Configuració de Split Tunnel</figcaption>
</figure>
</div></li>
<li><p>Aneu a <strong>Access Controls/Global Access Rules</strong> i afegiu una regla per permetre el tràfic de la VPN a les subxarxes de la VPC:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-Global-Acces.png" class="img-fluid figure-img"></p>
<figcaption>Configuració de les regles d’accés global</figcaption>
</figure>
</div></li>
<li><p>Aneu a <strong>User</strong> i creu-vos un usuari i una contrasenya per connectar-vos al servidor VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-User.png" class="img-fluid figure-img"></p>
<figcaption>Creació d’un usuari per al servidor VPN</figcaption>
</figure>
</div></li>
<li><p>Un cop tinguem el fitxer de configuració, ja podeu fer un <strong>Restart</strong> del servei OpenVPN per aplicar tots els canvis. Torneu a accedir a la interfície web del servidor OpenVPN.</p></li>
<li><p>Aneu a <strong>User/user/Connection Profiles</strong> i creeu un perfil de connexió per defecte. Un cop creat us baixarà un fitxer de configuració que després utilitzarem per connectar-nos al servidor VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-Connection-Profile.png" class="img-fluid figure-img"></p>
<figcaption>Descàrrega del fitxer de configuració del client VPN</figcaption>
</figure>
</div></li>
<li><p>Installeu l’aplicació <a href="https://openvpn.net/client/">OpenVPN Connect</a> al vostre ordinador. Aquesta aplicació és el client VPN que utilitzarem per connectar-nos al servidor VPN.</p></li>
<li><p>Un cop instal·lat, obriu l’aplicació i importeu el fitxer de configuració que heu descarregat anteriorment.</p></li>
</ul></li>
<li><p>Un cop tot configurat, actualitzarem el grup de seguretat de les instàncies EC2 per permetre el tràfic al port 22 únicament provinent del servidor VPN. Això significa que les instàncies EC2 només acceptaran tràfic SSH del servidor VPN i no de qualsevol altre origen.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/ec2-ssh-only-vpn.png" class="img-fluid figure-img"></p>
<figcaption>Configuració tràfic SSH a Ec2 del servidor VPN</figcaption>
</figure>
</div></li>
</ol>
<p>En aquest punt, ja no podreu accedir a les instàncies EC2 on teniu el servei de WordPress a través de SSH, ja que el tràfic SSH només es permet des del servidor VPN. Per accedir a les instàncies EC2, primer heu de connectar-vos al servidor VPN i després connectar-vos a les instàncies EC2. Per fer-ho:</p>
<ul>
<li><p>Importeu el fitxer de configuració del client OpenVPN Connect a l’aplicació i connecteu-vos al servidor VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-01.png" class="img-fluid figure-img"></p>
<figcaption>Connexió al servidor VPN</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p><strong>TroubleShooting</strong>: Si en el fitxer de configuració veieu (<strong>Server Hostname</strong>) una ip del rang 10.0.X.X, això vol dir que la VPN no s’ha configurat correctament. Assegureu-vos de reiniciar el servidor i tornar a descarregar el fitxer de configuració del client, ha de tenir la ip pública del servidor VPN.</p>
</blockquote></li>
<li><p>Utilitzeu la mateixa contrasenya del usuari <code>openvpn</code> per connectar-vos al servidor VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-02.png" class="img-fluid figure-img"></p>
<figcaption>Connexió al servidor VPN</figcaption>
</figure>
</div></li>
<li><p>Si tot ha anat bé, veureu que esteu connectats al servidor VPN.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-03.png" class="img-fluid figure-img"></p>
<figcaption>Connexió al servidor VPN</figcaption>
</figure>
</div></li>
</ul>
<p>Finalment, connecteu-vos a les instàncies EC2:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../figs/laboratories/03-aws-wp/wordpress/VPN-SSH.png" class="img-fluid figure-img"></p>
<figcaption>Accés a les instàncies EC2 a través del servidor VPN</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p><strong>Consideracions importants</strong>: El servidor VPN ens permet accedir a les instàncies EC2 a través de SSH, però a partir de l’adreça interna (10.0.X.X) de la instància EC2. No podrem accedir a les instàncies EC2 a través de la seva adreça pública ja que hem configurat la VPN per accedir a les subxarxes de la VPC.</p>
</blockquote>
</section>
</section>
<section id="neteja-els-recursos-creats" class="level2">
<h2 class="anchored" data-anchor-id="neteja-els-recursos-creats">Neteja els recursos creats</h2>
<p>Un cop finalitzat podeu eliminar totes les instàncies EC2 i la base de dades RDS per evitar càrrecs innecessaris al vostre compte d’AWS.</p>
</section>
<section id="exercics-adicionals" class="level2">
<h2 class="anchored" data-anchor-id="exercics-adicionals">Exercics Adicionals</h2>
<ol type="1">
<li>Com milloraríeu els grups de seguretat, quins canvis faríeu?</li>
<li>Què caldria fer per connectar un client MySQL des de casa a la base de dades RDS? Expliqueu els passos.</li>
<li>Prepara un script que faci una prova de càrrega al balancejador de càrrega i mostri com es distribueix el tràfic entre les instàncies EC2.</li>
<li>Genera un infra_v3.yaml que contingui tota la infraestructura com a codi.</li>
</ol>
</section>
<section id="recursos-addicionals" class="level2">
<h2 class="anchored" data-anchor-id="recursos-addicionals">Recursos Addicionals</h2>
<ul>
<li><a href="src/infra-v1.yaml">infra_v1.yaml</a>: Aquest fitxer conté la infraestructura com a codi per crear tots els recursos d’AWS utilitzant AWS CloudFormation fins a la creació de templates de llançament.</li>
<li><a href="src/infra-v2.yaml">infra_v2.yaml</a>: Aquest fitxer conté la infraestructura com a codi per crear tots els recursos d’AWS utilitzant AWS CloudFormation sense el load balancer ni les instancies EC2 corresponents als WordPress.</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiat!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiat!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/amsa-gei-udl-2526-105013\.github\.io\/course\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>