---
title: Deployment of a high-availability web application with AWS
lang: en
---


**ARCHITECTURE**

In this lab, we will design and implement a robust and secure network architecture to host a WordPress application. The architecture is based on the  use of 2 **Availability Zones (AZ)** located in 1 **Region** to ensure that our WordPress is highly available and fault-tolerant.

![Diagram of components, connections, and elements of the architecture](../../figs/laboratories/03-aws-wp/wordpress/infra.png) 

The image shows how, through the internet, users access the Load Balancer, which distributes traffic to the EC2 instances hosting WordPress. These instances connect to the RDS database to manage WordPress content. The EC2 instance in the DMZ allows secure access for the administration of private resources

**Components:**

- **VPC, subnets, route tables, and security groups**.
- Secure **VPN** for administrative access.
- Wordpress EC2 instances distributed across private subnets in different AZs, accessible only through the Load Balancer, never directly from the Internet.‚Äù.
 - **Load Balancer** which acts as a public entry point that ensures the uniform distribution of traffic to the WordPress EC2 instances.
- High available **Data Base RDS (MySQL)** located in dedicated private subnets.
- **DMZ** designed with an EC2 instance in a public subnet that will act as a secure access point (via SSH tunnel) for managing all private resources.


##  1. VPC and Subnets

The first step in our architecture is to define a VPC (Virtual Private Cloud) and the necessary subnets to isolate the different components of the application. The VPC will provide a virtualized network environment where we can deploy our AWS resources. We will configure it with the network **10.0.0.0/16**, which gives us up to 65,536 IP addresses, more than enough for our use case.

:::{.callout-note title="CIDR, Hosts and Reserved Adresses üß†"}
The subnet mask determines the number of IP addresses available within a network or subnet. This is expressed using CIDR notation (Classless Inter-Domain Routing), where the value (/n) indicates the number of bits reserved for the Network portion. A subnet mask of /16 means that the first 16 bits of the IP address are reserved for network identification, leaving the other 16 bits for host identification. This allows up to 65,536 IP addresses ($2^{32-16}$) within that network.

When you perform subnetting to create subnets within your VPC, you increase the CIDR value (for example, from /16 to /24) to reduce the size of the subnets and better isolate traffic. For example, a subnet with CIDR /24 has 256 IP addresses ($2^{32-24}$).

Remember that the total calculated addresses are not the total usable addresses for your servers (hosts). Some addresses are reserved for special uses, such as network identification and broadcast.
:::

Podem definir la VPC a trav√©s de la interf√≠cie web d'AWS, utilitzant els formularis disponibles:

![VPC definition](../../figs/laboratories/03-aws-wp/wordpress/vpc.png)


### 1.2. Creating the Subnets

Add the necessary subnets for our architecture. Go to **VPC** ‚Üí **Subnets** ‚Üí **Create subnet**. Select the VPC we just created and add the following subnets:

- **AMSA-DMZ-01**: Public subnet in the zone **us-east-1a**. This subnet will host the EC2 instance that will serve as a secure access bridge (via SSH tunnel) for managing all private resources. *(10.0.1.0/24)*.

![AMSA-DMZ-01](../../figs/laboratories/03-aws-wp/AMSA-DMZ-01.png)

- **AMSA-DMZ-02**: Public subnet in the zone **us-east-1b**. This subnet will host the EC2 instance that will serve as a secure access bridge (via SSH tunnel) for managing all private resources. *(10.0.2.0/24)*.

![AMSA-DMZ-02](../../figs/laboratories/03-aws-wp/AMSA-DMZ-02.png)

- **AMSA-Private01**: Private subnet for the WordPress instances in the availability zone **us-east-1a**. *(10.0.3.0/24)*.

![AMSA-Private01](../../figs/laboratories/03-aws-wp/AMSA-Private01.png)

- **AMSA-Private02**: Private subnet for the WordPress instances in the availability zone **us-east-1b**. *(10.0.4.0/24)*

![AMSA-Private02](../../figs/laboratories/03-aws-wp/AMSA-Private02.png)

- **AMSA-Data**: Private subnet for the WordPress instances in the availability zone **us-east-1c**. *(10.0.5.0/24)*

![AMSA-Data](../../figs/laboratories/03-aws-wp/AMSA-Data.png)

## 2. Routing Tables and Associations

To manage traffic routes and determine how it is distributed among the subnets, we will create route tables and associate them with the corresponding subnets.. 

### 2.1. Internet Gateway Configuration

We will use an **Internet Gateway (IGW)** to allow the public subnets *(AMSA-DMZ-01 and AMSA-DMZ-02)* to have both inbound and outbound Internet access. To do this, we will first create the IGW and then associate it with our VPC.

The first step is to create the Internet Gateway. Go to **VPC** ‚Üí **Internet Gateways** ‚Üí **Create internet gateway**. Once created, name it  **AMSA-IG**.

![Internet Gateway for the VPC](../../figs/laboratories/03-aws-wp/wordpress/ig.png)

The second step is to associate the Internet Gateway with the VPC. Select the Internet Gateway we just created and click on **Actions** ‚Üí **Attach to VPC**. Select the VPC **AMSA-VPC** and click on **Attach internet gateway**.

![Association of the Internet Gateway with the VPC](../../figs/laboratories/03-aws-wp/wordpress/attachIG.png)


![Association of the Internet Gateway with the VPC](../../figs/laboratories/03-aws-wp/wordpress/attachIG2.png)

:::{.callout-warning title="Attached IGW üõë"}
Make sure the Internet Gateway is correctly associated with the VPC. If it is not associated, the public subnets will not be able to access the Internet.
:::

### 2.2. Creation of Routing Tables

Each subnet needs a route table to define how inbound and outbound traffic is directed. We will create specific route tables for each type of subnet (public and private) and associate them with the corresponding subnets.


#### 2.2.1. Routing for public subnets (DMZ)

The first step is to create the route table for the public subnets. Go to **VPC** ‚Üí **Route Tables** ‚Üí **Create route table**. Select VPC **AMSA-VPC** and name the route table **AMSA-DMZ01-RT**.

![Route table for the subnet AMSA-DMZ01-RT](../../figs/laboratories/03-aws-wp/AMSA-DMZ01-RT.png)

The second step is to associate the route table (*AMSA-DMZ01-RT*) with the subnet **AMSA-DMZ-01** allow outbound traffic to the Internet through the Internet Gateway we created earlier. 

![Association of the route table with the subnet AMSA-DMZ-01](../../figs/laboratories/03-aws-wp/AMSA-DMZ-Subnet-Association.png)

The third step is to allow outbound traffic to the Internet through the Internet Gateway we created earlier. To do this, go to the section *Routes* and click on *Edit routes*. Next, **Add route** and edit (Destination: 0.0.0.0/0; Target:Seleccionar el **AMSA-IG**).

![Allowing traffic with the outside through the IG](../../figs/laboratories/03-aws-wp/wordpress/IG.png)


:::{.callout-warning title="AMSA-DMZ-02 üõë"}
Perform the same steps for the subnet **AMSA-DMZ-02**, modifying only the name of the route table and the association with the subnet.
:::

#### 2.2.2. Enrutament per a les subxarxes privades

Les subxarxes privades no tenen acc√©s directe a Internet per motius de seguretat. Per tant, necessitem configurar les taules de rutes per a aquestes subxarxes de manera que puguin accedir a Internet a trav√©s d'un NAT Gateway (Network Address Translation Gateway). Aix√≤ permetr√† que les inst√†ncies dins de les subxarxes privades puguin iniciar connexions cap a l'exterior, per√≤ impedir√† que l'exterior inici√Ø connexions cap a elles. 

:::{.callout-note title="NAT Gateway üß†"}
Un NAT Gateway √©s un servei gestionat per AWS que permet a les inst√†ncies en una subxarxa privada accedir a Internet per a actualitzacions de programari, desc√†rregues de paquets, etc., sense exposar aquestes inst√†ncies directament a Internet. El NAT Gateway tradueix les adreces IP privades de les inst√†ncies a una adre√ßa IP p√∫blica quan aquestes inst√†ncies fan peticions a Internet.
:::

Per crear el NAT Gateway, necessitem una IP el√†stica (Elastic IP). Per tant, primer crearem una IP el√†stica i despr√©s la utilitzarem per crear el NAT Gateway. L'anomeneu **AMSA-NAT-EIP**.
  
![Creaci√≥ de la IP el√†stica](../../figs/laboratories/03-aws-wp/wordpress/ElasticIP-NAT.png)

![Actualitzar el nom de la IP el√†stica](../../figs/laboratories/03-aws-wp/wordpress/ElasticIp-Nat2.png)

Un cop tenim la IP el√†stica, podem crear el NAT Gateway. L'anomeneu **AMSA-NG** i l'associeu a la subxarxa **AMSA-DMZ-01**. 

![Creaci√≥ del NAT Gateway](../../figs/laboratories/03-aws-wp/wordpress/nat-gw-create.png)

Crearem la taula de rutes (*AMSA-Private01-RT*) per a la subxarxa **AMSA-Private01** i l'associarem a la subxarxa. Aquesta taula de rutes permetr√† que les inst√†ncies dins d'aquesta subxarxa accedeixin a Internet a trav√©s del NAT Gateway.

![Taula de rutes per a la subxarxa AMSA-Private01](../../figs/laboratories/03-aws-wp/wordpress/AMSA-Private01-RT.png)

El segon pas √©s associar la taula de rutes (*AMSA-Private01-RT*) amb la subxarxa **AMSA-Private01** i permetre el tr√†fic de sortida a Internet a trav√©s del NAT Gateway que hem creat anteriorment. 

![Creaci√≥ de la taula de rutes per a la subxarxa AMSA-Private01](../../figs/laboratories/03-aws-wp/AMSA-Private01-RT-create.png)

El tercer pas √©s permetre el tr√†fic de sortida a Internet a trav√©s del NAT Gateway que hem creat anteriorment. Per fer-ho aneu a la secci√≥ *Routes* i clicareu a *Edit routes*. A continuaci√≥, **Add route** i editareu (Destination: 0.0.0.0/0; Target:Seleccionar el **AMSA-NG**).

:::{.callout-warning title="AMSA-Private02 üõë"}
Repetiu els mateixos passos per a la subxarxa **AMSA-Private02**, modificant nom√©s el nom de la taula de rutes i l'associaci√≥ amb la subxarxa.
:::

#### 2.2.3. Enrutament per a la subxarxa de dades (AMSA-Data)

La subxarxa **AMSA-Data** no allotjar√† inst√†ncies que necessitin acc√©s a Internet. Per tant, no necessitem configurar cap ruta per a aquesta subxarxa. Crearem una taula de rutes buida i l'associarem a la subxarxa **AMSA-Data**. Aquesta xarxa ser√† completament a√Øllada i nom√©s permetr√† la comunicaci√≥ interna dins de la VPC.


## 3. Grups de Seguretat

Els grups de seguretat (Security Groups) s√≥n una eina per controlar el tr√†fic de xarxa de les inst√†ncies i altres recursos d‚ÄôAWS, actuant com un tallafocs virtual. Permeten definir regles que especifiquen quines connexions estan permeses tant d'entrada (inbound) com de sortida (outbound).

- **Trafic inbound**: Permet decidir quins tipus de connexions entrants (cap al recurs) s√≥n permeses.
- **Trafic outbound**: Controla quines connexions sortints (des del recurs cap a altres destinacions) estan autoritzades.
  
### 3.1. Grup de Seguretat per a les inst√†ncies EC2

- **Connexions entrants (inbound)** per als serveis web HTTP (port 80) i HTTPS (port 443), accessibles des de qualsevol origen.
- **Connexions SSH (port 22)** per a administraci√≥ remota, tamb√© accessibles des de qualsevol origen (inicialment, per√≤ m√©s endavant es restringiran).
- Totes les connexions sortints (**outbound**), que per defecte estan permeses a AWS, cosa que permet a les inst√†ncies EC2 comunicar-se amb altres recursos com ara RDS.

Per fer-ho, navegarem a la consola de VPC d'AWS, seleccionarem la secci√≥ *Security Groups* i clicarem a *Create security group*. A continuaci√≥, omplirem els camps amb la informaci√≥ necess√†ria i clicarem a *Create security group*. El podeu anomenar **AMSA-WP-SG**.

![Grup de Seguretat per a les inst√†ncies EC2](../../figs/laboratories/03-aws-wp/wordpress/AMSA-WP-SG.png)

:::{.callout-note title="Nota sobre la seguretat üîê"}
En aquest moment, estem permetent tot el tr√†fic de xarxa per als serveis web i SSH. Quan ho tinguem tot configurat, restringirem aquest acc√©s √∫nicament al trafic entrant provinent del balancejador de c√†rrega pels serveis web i a la nostra xarxa interna per a SSH.
:::

### Grup de Seguretat per a la base de dades RDS

- **Connexions inbound**: Nom√©s permetr√† tr√†fic al port 3306 (MySQL) i exclusivament des de les inst√†ncies EC2 que pertanyin al grup de seguretat **AMSA-WP-SG**.
- **Connexions outbound**: Per defecte, AWS permetr√† totes les connexions sortints, cosa que garanteix que la base de dades pugui comunicar-se amb altres recursos si √©s necessari.

Per fer-ho, navegarem a la consola de VPC d'AWS, seleccionarem la secci√≥ *Security Groups* i clicarem a *Create security group*. A continuaci√≥, omplirem els camps amb la informaci√≥ necess√†ria i clicarem a *Create security group*.

![Grup de Seguretat per a la base de dades RDS](../../figs/laboratories/03-aws-wp/wordpress/AMSA-DB-SG.png)

### Resum

| Grup de Seguretat | Inbound | Outbound |
|-------------------|---------|----------|
| AMSA-WP-SG       | HTTP (80) i HTTPS (443) des de 0.0.0.0/0; SSH (22) des de 0.0.0.0/0| Totes permeses |
| AMSA-DB-SG        | MySQL (3306) des de AMSA-Web-SG | Totes permeses |


## Creaci√≥ de la Base de Dades RDS

La base de dades ja la vam configurar en el laboratori anterior [Desplegament d'una aplicaci√≥ web amb AWS](../01-foundations/02-aws-wordpress.qmd). La √∫nica difer√®ncia √©s que ara la base de dades es troba en una subxarxa privada i nom√©s √©s accessible des de les inst√†ncies EC2 que pertanyen al grup de seguretat **AMSA-Web-SG**.

- **Compute resources**: Don't connect to an EC2 compute resource
- **VPC**: AMSA-VPC
- **Subnet Group**: Create new DB Subnet Group
- **Public accessibility**: No
- **VPC security group**: AMSA-DB-SG
- **Availability Zone**: us-east-1d


## Creaci√≥ de les inst√†ncies EC2

Les inst√†ncies EC2 que allotjaran WordPress es desplegaran en les subxarxes privades, recordeu que vam configurar ansible en el laboratori anterior [Desplegament d'una aplicaci√≥ web amb AWS](../01-foundations/02-aws-wordpress.qmd). AWS ens permet crear plantilles d'inst√†ncies (**Launch Templates**) que faciliten la creaci√≥ d'inst√†ncies amb una configuraci√≥ predefinida. Per tant, crearem una plantilla d'inst√†ncia que inclogui la configuraci√≥ necess√†ria per a les nostres inst√†ncies EC2 de WordPress, enlloc d'utiltizar el m√®tode amb ansible que vam utilitzar en el laboratori anterior.

# Configuraci√≥ del Servidor Web amb WordPress

1. Creareu una instancia EC2 amb Amazon Linux, seleccionant la VPC **AMSA-VPC** i la subxarxa **AMSA-DMZ-01**. Assegureu-vos que l'inst√†ncia utilitzi el grup de seguretat **AMSA-WP-SG**. La podeu anomenar **AMSA-DB-Config**. Seleccionar *assignar ip p√∫blica*. Aquesta inst√†ncia nom√©s la farem servir per inicialitzar la base de dades i despr√©s la podrem eliminar.

2. Un cop configurada la inst√†ncia, connecteu-vos-hi mitjan√ßant SSH utilitzant la clau privada corresponent a la clau p√∫blica que vau associar a la inst√†ncia durant la seva creaci√≥. I realitzeu la configuraci√≥ de la base de dades MySQL per a WordPress.

3. Anem a crear una plantilla de llan√ßament (**Launch Template**) per a les inst√†ncies EC2 que allotjaran WordPress. Aquesta plantilla inclour√† la configuraci√≥ necess√†ria per a les inst√†ncies, incloent-hi el script d'instal¬∑laci√≥ i configuraci√≥ de WordPress.

   - Nom de la plantilla: **AMSA-WP-Template**
   - AMI: Amazon Linux 2023 (64-bit x86)
   - Inst√†ncia Type: t2.micro
   - Key Pair: AMSA-KEY
   - Subxarxa: No seleccionar cap subxarxa (es seleccionar√† din√†micament)
   - Grup de Seguretat: *AMSA-WP-SG*
   - Advanced Details: Afegiu el seg√ºent script a la secci√≥ de UserData.

:::{.callout-note title="Script d'instal¬∑laci√≥ i configuraci√≥ de WordPress üìù"}

Modifiqueu les dades de connexi√≥ a la base de dades segons les vostres dades.

```bash
#!/bin/bash
# sudo bash install_wp.sh

# Ajusteu les dades seg√ºents segons les vostres dades
DB_NAME="" 
DB_USER=""
DB_USER_PASSWORD=""
DB_HOST="" 

if [ "$(id -u)" -ne 0 ]; then
    echo "Please run this script with sudo or as root."
    exit 1
fi

dnf install -y wget php-mysqlnd httpd php-fpm php-mysqli php-json php php-devel php-gd expect

cd /tmp
wget https://wordpress.org/latest.tar.gz
tar -xzf latest.tar.gz

# Configure WordPress
cp wordpress/wp-config-sample.php wordpress/wp-config.php
sed -i "s/database_name_here/$DB_NAME/g" wordpress/wp-config.php
sed -i "s/username_here/$DB_USER/g" wordpress/wp-config.php
sed -i "s/password_here/$DB_USER_PASSWORD/g" wordpress/wp-config.php
sed -i "s/localhost/$DB_HOST/g" wordpress/wp-config.php

sudo cp -r wordpress/* /var/www/html/

sudo sed -i 's/AllowOverride None/AllowOverride All/g' /etc/httpd/conf/httpd.conf

sudo chown -R apache:apache /var/www
sudo chmod 2775 /var/www

sudo systemctl restart httpd
```
:::

Un cop creada la plantilla de llan√ßament, podeu utilitzar-la per crear inst√†ncies EC2 amb WordPress ja configurat i preparades per connectar amb la vostra base de dades RDS. Aneu a **EC2** i seleccioneu **Launch Instance**. A continuaci√≥, seleccioneu la plantilla de llan√ßament **AMSA-WP-Template** i configureu la resta de par√†metres segons les vostres necessitats.

- Nombre d'inst√†ncies: 2
- Subxarxa: Seleccioneu la subxarxa **AMSA-Private01** per a la primera inst√†ncia i **AMSA-Private02** per a la segona inst√†ncia. Les podeu anomenar **AMSA-WP-01** i **AMSA-WP-02** respectivament.


:::{.callout-important title="Nota sobre les inst√†ncies EC2 üñ•Ô∏è"}
Aquestes inst√†ncies no tindran IP p√∫blica, ja que nom√©s seran accessibles a trav√©s del balancejador de c√†rrega que configurarem m√©s endavant. Ara mateix no podreu accedir-hi directament ni per SSH ni per HTTP.
:::



## Configuraci√≥ del Balancejador de C√†rrega

En aquest punt, crearem un balancejador de c√†rrega per a les nostres inst√†ncies EC2. Aquest balancejador de c√†rrega ser√† responsable de distribuir uniformement el tr√†fic entre les inst√†ncies EC2 que allotgen WordPress.

Existeixen 3 tipus de balancejadors de c√†rrega a AWS: **Application Load Balancer (ALB)**, **Network Load Balancer (NLB)** i **Gateway Load Balancer (GWLB)**. En aquest cas, utilitzarem un **Application Load Balancer (ALB)**, ja que √©s el recomanat per a aplicacions web que utiltizen HTTP i HTTPS.

Navegueu a la consola de AWS i seleccioneu el servei **EC2**. A la barra lateral, seleccioneu **Load Balancers** i despr√©s **Create Load Balancer**. Seleccioneu **Application Load Balancer** i feu clic a **Create**.

- **Nom del balancejador de c√†rrega**: AMSA-ALB
- **Scheme**: Internet-facing
- **IP Address Type**: IPv4

![Configuraci√≥ del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/lb-01.png)

- **VPC**: AMSA-VPC
- **Availability Zones**: Seleccionar les zones de disponibilitat on tenim la subxarxa p√∫blica **AMSA-DMZ-01** (us-east-1a) i les **AMSA-DMZ-02** (us-east-1b).

- **Grups de Seguretat**: Nou grup de seguretat (**AMSA-ALB-SG**), aquest grup de seguretat permetr√† el tr√†fic d'entrada per als ports 80 (HTTP) i 443 (HTTPS) des de qualsevol origen per√≤ restringir√† el tr√†fic de sortida a les inst√†ncies EC2 (grup de seguretat **AMSA-WP-SG**).

    ![Grup de Seguretat per al balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/AMSA-ALB-SG.png)

    ![Configuraci√≥ del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/lb-03.png)

- **Listeners**: Crearem un listener per al port 80 (HTTP), que redirigir√† el tr√†fic al port 80 de les inst√†ncies EC2. Al port 443 (HTTPS) de moment no configurarem cap redirecci√≥. Per fer-ho, primer haureu de crear un **Target Group**. Aquest grup es necessari per indicar al balancejador de c√†rrega on enviar el tr√†fic.

  - *Target Group*:
    - **Target Type**: Instances
    - **Nom**: AMSA-WP-TG
    - **Protocol**: HTTP
    - **Port**: 80
    - **VPC**: AMSA-VPC
    - **Health checks**: HTTP, ruta **/**


    ![Configuraci√≥ del target group](../../figs/laboratories/03-aws-wp/wordpress/tg-03.png)

:::{.callout-note title="Health Check üéØ"}
El balancejador de c√†rrega comprova la salut de les inst√†ncies EC2 a trav√©s del port 80 i la ruta **/**. Aix√≤ significa que el balancejador de c√†rrega enviar√† tr√†fic a les inst√†ncies EC2 que responguin correctament a les peticions HTTP a la ruta **/**. Com que les nostres inst√†ncies EC2 tenen WordPress instal¬∑lat, aquestes inst√†ncies respondran correctament a les peticions HTTP a la ruta **/**. *Podem deixar la configuraci√≥ per defecte*. La instal¬∑laci√≥ de WordPress inclou una p√†gina d'inici que respondr√† amb 302 (Found) quan s'accedeixi a la ruta arrel (/), per aix√≤ pot passar que el health check mostri que la inst√†ncia no est√† saludable. Un cop configurat el WordPress, el health check mostrar√† que la inst√†ncia est√† saludable.
:::

- Seleccionarem les dos inst√†ncies EC2 que allotgen WordPress (AMSA-WP-01 i AMSA-WP-02) i les afegirem al target group. Utilitzant el bot√≥ **Include as pending below** i despr√©s **Add to registered**.

    ![Configuraci√≥ del target group](../../figs/laboratories/03-aws-wp/wordpress/tg-04.png)


- Un cop creat el target group, el seleccionarem com a target del listener del balancejador de c√†rrega.

    ![Configuraci√≥ del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/lb-05.png)

- Un cop creat el balancejador de c√†rrega, heu d'esperar uns minuts fins que el seu estat passi de **Provisioning** a **Active**. Un cop l'estat sigui **Active**, podeu accedir al balancejador de c√†rrega a trav√©s de la seva adre√ßa DNS.

![Balancejador de c√†rrega actiu](../../figs/laboratories/03-aws-wp/wordpress/lb-active.png)

- Ara ja podem accedir al balancejador de c√†rrega a trav√©s de la seva adre√ßa DNS i veure la p√†gina d'instal¬∑laci√≥ de WordPress:

![Instal¬∑laci√≥ de WordPress a trav√©s del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/wp-config-01.png)

Procedirem a instal¬∑lar WordPress a trav√©s del balancejador de c√†rrega. Seguiu els passos de la instal¬∑laci√≥ i configureu l'usuari administrador i la contrasenya. Ara ja teniu el servidor web configurat amb WordPress i el balancejador de c√†rrega per distribuir el tr√†fic entre les inst√†ncies EC2.

## Configuraci√≥ VPN

### EC2 per desplegar el servidor VPN

Per desplegar el servidor VPN, crearem una nova inst√†ncia EC2 que actuar√† com a servidor VPN. Aquesta inst√†ncia EC2 haur√† d'estar en una subxarxa p√∫blica connectada a interent. Anomenarem aquesta inst√†ncia **AMSA-VPN** i la situarem a la subxarxa p√∫blica **AMSA-DMZ-01**. Aquesta inst√†ncia EC2 utilitzar√† el grup de seguretat **AMSA-VPN-SG** que permetr√† el tr√†fic necessari per al funcionament del servidor VPN.

1. Navegueu a la consola de AWS i seleccioneu el servei **EC2**. A la barra lateral, seleccioneu **Instances** i despr√©s **Launch Instances**.
2. Seleccioneu la imatge **Ubuntu Server 22.04 LTS**.
3. Seleccioneu la inst√†ncia **t2.micro**.
4. Configureu la inst√†ncia:
    - **Network**: AMSA-VPC
    - **Subnet**: AMSA-DMZ-01
    - **Auto-assign Public IP**: Enable

    ![Configuraci√≥ de la inst√†ncia EC2 per al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/AMSA-VPN.png)

5. Configureu el grup de seguretat: **AMSA-VPN-SG**.

    Si reviseu la documentaci√≥ d'instal¬∑laci√≥ del servidor OpenVPN: [OpenVPN Access Server System Administrator Guide ](https://openvpn.net/images/pdf/OpenVPN_Access_Server_Sysadmin_Guide_Rev.pdf). Veure que necessitem els seg√ºents ports oberts: **TCP 943, UDP 1194**.

    ![Configuraci√≥ del grup de seguretat per al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/AMSA-SG-VPN.png)

6. Connecteu-vos a la inst√†ncia EC2 a trav√©s de la consola online de AWS o amb una connexi√≥ SSH i executeu la seg√ºent comanda per instal¬∑lar el servidor OpenVPN:

    ```bash
    sudo apt update -y
    sudo apt install ca-certificates gnupg wget net-tools -y
    sudo wget https://as-repository.openvpn.net/as-repo-public.asc -qO /etc/apt/trusted.gpg.d/as-repo-public.asc
    sudo echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/as-repo-public.asc] http://as-repository.openvpn.net/as/debian jammy main" | sudo tee /etc/apt/sources.list.d/openvpn-as-repo.list
    sudo apt update && sudo apt install openvpn-as -y
    ```

    ![Instal¬∑laci√≥ del servidor OpenVPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-config.png)

7. Amb aquestes credencials, podreu accedir a la interf√≠cie web del servidor OpenVPN a trav√©s del vostre navegador web. Navegueu a la IP p√∫blica de la inst√†ncia EC2 (en el meu cas https://44.199.196.242:943/admin), com no tenim el certificat SSL configurat, ens sortir√† un missatge d'advert√®ncia, ignoreu-lo i continueu. Inicieu sessi√≥ amb les credencials que heu configurat anteriorment.

    > Nota: Si heu perdut les credencials de l'usuari `openvpn`, les podeu recuperar consultat el fitxer de logs del servidor OpenVPN. Per exemple, podeu consultar el fitxer de logs amb la seg√ºent comanda:
    >
    > ```bash
    > sudo less /usr/local/openvpn_as/init.log 
    > ```

    ![Interf√≠cie web del servidor OpenVPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-login.png)

    - Accepteu els termes de llic√®ncia.
  
    ![Acceptaci√≥ dels termes de llic√®ncia](../../figs/laboratories/03-aws-wp/wordpress/VPN-accept-terms.png)

    - Aneu a **VPN Server/Network Settings** i configureu el **Hostname or IP Address** amb la IP p√∫blica de la inst√†ncia EC2 on teniu el servidor OpenVPN. Un cop fet, clicareu a **Save**.

        ![Configuraci√≥ de la IP p√∫blica del servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-01.png)


    - Aneu a **Access Controls/Internet Access and DNS** i seleccioneu l'opci√≥ **Split Tunnel** per evitar que tot el tr√†fic del client sigui redirigit a trav√©s de la VPN. √önicament el tr√†fic dirigit a les subxarxes de la VPC ser√† redirigit a trav√©s de la VPN.

        ![Configuraci√≥ de Split Tunnel](../../figs/laboratories/03-aws-wp/wordpress/VPN-Split-Tunnel.png)

    - Aneu a **Access Controls/Global Access Rules** i afegiu una regla per permetre el tr√†fic de la VPN a les subxarxes de la VPC:
  
        ![Configuraci√≥ de les regles d'acc√©s global](../../figs/laboratories/03-aws-wp/wordpress/VPN-Global-Acces.png)

    - Aneu a **User** i creu-vos un usuari i una contrasenya per connectar-vos al servidor VPN.

        ![Creaci√≥ d'un usuari per al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-User.png)

    - Un cop tinguem el fitxer de configuraci√≥, ja podeu fer un **Restart** del servei OpenVPN per aplicar tots els canvis. Torneu a accedir a la interf√≠cie web del servidor OpenVPN.

    - Aneu a **User/user/Connection Profiles** i creeu un perfil de connexi√≥ per defecte. Un cop creat us baixar√† un fitxer de configuraci√≥ que despr√©s utilitzarem per connectar-nos al servidor VPN.

        ![Desc√†rrega del fitxer de configuraci√≥ del client VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-Connection-Profile.png)

    

    - Installeu l'aplicaci√≥ [OpenVPN Connect](https://openvpn.net/client/) al vostre ordinador. Aquesta aplicaci√≥ √©s el client VPN que utilitzarem per connectar-nos al servidor VPN.

    - Un cop instal¬∑lat, obriu l'aplicaci√≥ i importeu el fitxer de configuraci√≥ que heu descarregat anteriorment.

        
8.  Un cop tot configurat, actualitzarem el grup de seguretat de les inst√†ncies EC2 per permetre el tr√†fic al port 22 √∫nicament provinent del servidor VPN. Aix√≤ significa que les inst√†ncies EC2 nom√©s acceptaran tr√†fic SSH del servidor VPN i no de qualsevol altre origen.

    ![Configuraci√≥ tr√†fic SSH a Ec2 del servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/ec2-ssh-only-vpn.png)

En aquest punt, ja no podreu accedir a les inst√†ncies EC2 on teniu el servei de WordPress a trav√©s de SSH, ja que el tr√†fic SSH nom√©s es permet des del servidor VPN. Per accedir a les inst√†ncies EC2, primer heu de connectar-vos al servidor VPN i despr√©s connectar-vos a les inst√†ncies EC2. Per fer-ho:

- Importeu el fitxer de configuraci√≥ del client OpenVPN Connect a l'aplicaci√≥ i connecteu-vos al servidor VPN.
  
    ![Connexi√≥ al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-01.png)

    > **TroubleShooting**: Si en el fitxer de configuraci√≥ veieu (**Server Hostname**) una ip del rang 10.0.X.X, aix√≤ vol dir que la VPN no s'ha configurat correctament. Assegureu-vos de reiniciar el servidor i tornar a descarregar el fitxer de configuraci√≥ del client, ha de tenir la ip p√∫blica del servidor VPN.

- Utilitzeu la mateixa contrasenya del usuari `openvpn` per connectar-vos al servidor VPN.

    ![Connexi√≥ al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-02.png)

- Si tot ha anat b√©, veureu que esteu connectats al servidor VPN.

    ![Connexi√≥ al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-03.png)
  
Finalment, connecteu-vos a les inst√†ncies EC2:

![Acc√©s a les inst√†ncies EC2 a trav√©s del servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-SSH.png)

> **Consideracions importants**: El servidor VPN ens permet accedir a les inst√†ncies EC2 a trav√©s de SSH, per√≤ a partir de l'adre√ßa interna (10.0.X.X) de la inst√†ncia EC2. No podrem accedir a les inst√†ncies EC2 a trav√©s de la seva adre√ßa p√∫blica ja que hem configurat la VPN per accedir a les subxarxes de la VPC.

## Cleanup

Once completed, you can delete all EC2 instances and the RDS database to avoid unnecessary charges to your AWS account.