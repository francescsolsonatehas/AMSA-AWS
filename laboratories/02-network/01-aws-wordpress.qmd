---
title: Deployment of a high-availability web application with AWS
lang: en
---


**ARCHITECTURE**

In this lab, we will design and implement a robust and secure network architecture to host a WordPress application. The architecture is based on the  use of 2 **Availability Zones (AZ)** located in 1 **Region** to ensure that our WordPress is highly available and fault-tolerant.

![Diagram of components, connections, and elements of the architecture](../../figs/laboratories/03-aws-wp/wordpress/infra.png) 

The image shows how, through the internet, users access the Load Balancer, which distributes traffic to the EC2 instances hosting WordPress. These instances connect to the RDS database to manage WordPress content. The EC2 instance in the DMZ allows secure access for the administration of private resources

**Components:**

- **VPC, subnets, route tables, and security groups**.
- Secure **VPN** for administrative access.
- Wordpress EC2 instances distributed across private subnets in different AZs, accessible only through the Load Balancer, never directly from the Internet.‚Äù.
 - **Load Balancer** which acts as a public entry point that ensures the uniform distribution of traffic to the WordPress EC2 instances.
- High available **Data Base RDS (MySQL)** located in dedicated private subnets.
- **DMZ** designed with an EC2 instance in a public subnet that will act as a secure access point (via SSH tunnel) for managing all private resources.


##  1. VPC and Subnets

The first step in our architecture is to define a VPC (Virtual Private Cloud) and the necessary subnets to isolate the different components of the application. The VPC will provide a virtualized network environment where we can deploy our AWS resources. We will configure it with the network **10.0.0.0/16**, which gives us up to 65,536 IP addresses, more than enough for our use case.

:::{.callout-note title="CIDR, Hosts and Reserved Adresses üß†"}
The subnet mask determines the number of IP addresses available within a network or subnet. This is expressed using CIDR notation (Classless Inter-Domain Routing), where the value (/n) indicates the number of bits reserved for the Network portion. A subnet mask of /16 means that the first 16 bits of the IP address are reserved for network identification, leaving the other 16 bits for host identification. This allows up to 65,536 IP addresses ($2^{32-16}$) within that network.

When you perform subnetting to create subnets within your VPC, you increase the CIDR value (for example, from /16 to /24) to reduce the size of the subnets and better isolate traffic. For example, a subnet with CIDR /24 has 256 IP addresses ($2^{32-24}$).

Remember that the total calculated addresses are not the total usable addresses for your servers (hosts). Some addresses are reserved for special uses, such as network identification and broadcast.
:::

Podem definir la VPC a trav√©s de la interf√≠cie web d'AWS, utilitzant els formularis disponibles:

![VPC definition](../../figs/laboratories/03-aws-wp/wordpress/vpc.png)


### 1.2. Creating the Subnets

Add the necessary subnets for our architecture. Go to **VPC** ‚Üí **Subnets** ‚Üí **Create subnet**. Select the VPC we just created and add the following subnets:

- **AMSA-DMZ-01**: Public subnet in the zone **us-east-1a**. This subnet will host the EC2 instance that will serve as a secure access bridge (via SSH tunnel) for managing all private resources. *(10.0.1.0/24)*.

![AMSA-DMZ-01](../../figs/laboratories/03-aws-wp/AMSA-DMZ-01.png)

- **AMSA-DMZ-02**: Public subnet in the zone **us-east-1b**. This subnet will host the EC2 instance that will serve as a secure access bridge (via SSH tunnel) for managing all private resources. *(10.0.2.0/24)*.

![AMSA-DMZ-02](../../figs/laboratories/03-aws-wp/AMSA-DMZ-02.png)

- **AMSA-Private01**: Private subnet for the WordPress instances in the availability zone **us-east-1a**. *(10.0.3.0/24)*.

![AMSA-Private01](../../figs/laboratories/03-aws-wp/AMSA-Private01.png)

- **AMSA-Private02**: Private subnet for the WordPress instances in the availability zone **us-east-1b**. *(10.0.4.0/24)*

![AMSA-Private02](../../figs/laboratories/03-aws-wp/AMSA-Private02.png)

- **AMSA-Data**: Private subnet for the WordPress instances in the availability zone **us-east-1c**. *(10.0.5.0/24)*

![AMSA-Data](../../figs/laboratories/03-aws-wp/AMSA-Data.png)

## 2. Routing Tables and Associations

To manage traffic routes and determine how it is distributed among the subnets, we will create route tables and associate them with the corresponding subnets.. 

### 2.1. Internet Gateway Configuration

We will use an **Internet Gateway (IGW)** to allow the public subnets *(AMSA-DMZ-01 and AMSA-DMZ-02)* to have both inbound and outbound Internet access. To do this, we will first create the IGW and then associate it with our VPC.

The first step is to create the Internet Gateway. Go to **VPC** ‚Üí **Internet Gateways** ‚Üí **Create internet gateway**. Once created, name it  **AMSA-IG**.

![Internet Gateway for the VPC](../../figs/laboratories/03-aws-wp/wordpress/ig.png)

The second step is to associate the Internet Gateway with the VPC. Select the Internet Gateway we just created and click on **Actions** ‚Üí **Attach to VPC**. Select the VPC **AMSA-VPC** and click on **Attach internet gateway**.

![Association of the Internet Gateway with the VPC](../../figs/laboratories/03-aws-wp/wordpress/attachIG.png)


![Association of the Internet Gateway with the VPC](../../figs/laboratories/03-aws-wp/wordpress/attachIG2.png)

:::{.callout-warning title="Attached IGW üõë"}
Make sure the Internet Gateway is correctly associated with the VPC. If it is not associated, the public subnets will not be able to access the Internet.
:::

### 2.2. Creation of Routing Tables

Each subnet needs a route table to define how inbound and outbound traffic is directed. We will create specific route tables for each type of subnet (public and private) and associate them with the corresponding subnets.


#### 2.2.1. Routing for public subnets (DMZ)

The first step is to create the route table for the public subnets. Go to **VPC** ‚Üí **Route Tables** ‚Üí **Create route table**. Select VPC **AMSA-VPC** and name the route table **AMSA-DMZ01-RT**.

![Route table for the subnet AMSA-DMZ01-RT](../../figs/laboratories/03-aws-wp/AMSA-DMZ01-RT.png)

The second step is to associate the route table (*AMSA-DMZ01-RT*) with the subnet **AMSA-DMZ-01** allow outbound traffic to the Internet through the Internet Gateway we created earlier. 

![Association of the route table with the subnet AMSA-DMZ-01](../../figs/laboratories/03-aws-wp/AMSA-DMZ-Subnet-Association.png)

The third step is to allow outbound traffic to the Internet through the Internet Gateway we created earlier. To do this, go to the section *Routes* and click on *Edit routes*. Next, **Add route** and edit (Destination: 0.0.0.0/0; Target:Seleccionar el **AMSA-IG**).

![Allowing traffic with the outside through the IG](../../figs/laboratories/03-aws-wp/wordpress/IG.png)


:::{.callout-warning title="AMSA-DMZ-02 üõë"}
Perform the same steps for the subnet **AMSA-DMZ-02**, modifying only the name of the route table and the association with the subnet.
:::

#### 2.2.2. Routing for private subnets

Private subnets do not have direct access to the Internet for security reasons. Therefore, we need to configure the route tables for these subnets so that they can access the Internet through a NAT Gateway (Network Address Translation Gateway). This will allow instances within the private subnets to initiate outbound connections, but prevent external sources from initiating connections to them. 

:::{.callout-note title="NAT Gateway üß†"}
A NAT Gateway is a managed service by AWS that allows instances in a private subnet to access the Internet for software updates, package downloads, etc., without exposing those instances directly to the Internet. The NAT Gateway translates the private IP addresses of the instances into a public IP address when those instances make requests to the Internet.
:::

To create the NAT Gateway, we need an Elastic IP. Therefore, we will first create an Elastic IP and then use it to create the NAT Gateway. Name it **AMSA-NAT-EIP**.
  
![Creating the Elastic IP](../../figs/laboratories/03-aws-wp/wordpress/ElasticIP-NAT.png)

![Update the name of the Elastic IP](../../figs/laboratories/03-aws-wp/wordpress/ElasticIp-Nat2.png)

Once we have the Elastic IP, we can create the NAT Gateway. Name it **AMSA-NG** and associate it with the subnet **AMSA-DMZ-01**. 

![Creating the NAT Gateway](../../figs/laboratories/03-aws-wp/wordpress/nat-gw-create.png)

Create the route table (*AMSA-Private01-RT*) for the subnet **AMSA-Private01** and we will associate it with the subnet. This route table will allow the instances within this subnet to access the Internet through the NAT Gateway.

![Route table for the subnet AMSA-Private01](../../figs/laboratories/03-aws-wp/wordpress/AMSA-Private01-RT.png)

The second step is to associate the route table (*AMSA-Private01-RT*) with the subnet **AMSA-Private01** and allow outbound traffic to the Internet through the NAT Gateway we created earlier. 

![Creating the route table for the subnet AMSA-Private01](../../figs/laboratories/03-aws-wp/AMSA-Private01-RT-create.png)

The third step is to allow outbound traffic to the Internet through the NAT Gateway we created earlier. To do this, go to the section *Routes* and click on *Edit routes*. Next, **Add route** and edit (Destination: 0.0.0.0/0; Target:Select **AMSA-NG**).

:::{.callout-warning title="AMSA-Private02 üõë"}
Repeat the same steps for the subnet **AMSA-Private02**, modifying only the name of the route table and the association with the subnet.
:::

#### 2.2.3. Routing for the data subnet (AMSA-Data)

The subnet **AMSA-Data** will not host instances that require Internet access. Therefore, we do not need to configure any route for this subnet. We will create an empty route table and associate it with the subnet **AMSA-Data**. This network will be completely isolated and will only allow internal communication within the VPC.


## 3. Security Groups

Security Groups are a tool for controlling network traffic for instances and other AWS resources, acting as a virtual firewall. They allow defining rules that specify which connections are allowed for both inbound and outbound traffic

- **Trafic inbound**: It allows you to decide which types of incoming connections (to the resource) are permitted.
- **Trafic outbound**: Control which outbound connections (from the resource to other destinations) are authorized.
  
### 3.1. Security Group for EC2 instances

- **Inbound connections** for web services HTTP (port 80) and HTTPS (port 443), accessible from any origin.
- **SSH conections (port 22)** for remote administration, also accessible from any origin (initially, but later they will be restricted).
- All outbound connections (**outbound**). By default, they are allowed in AWS, which enables EC2 instances to communicate with other resources such as RDS.

To do this, we will navigate to the AWS VPC console, select the *Security Groups* section, and click *Create security group*. Next, we will fill in the fields with the necessary information and click *Create security group*. You can name it **AMSA-WP-SG**.

![Security Group for EC2 instances](../../figs/laboratories/03-aws-wp/wordpress/AMSA-WP-SG.png)

:::{.callout-note title="Nota sobre la seguretat üîê"}
Now we allow all network traffic for web services and SSH. Once everything is configured, we will restrict this access only to inbound traffic coming from the load balancer for web services and from our internal network for SSH.
:::

### Security Group for the database RDS

- **Inbound connections**: t will only allow traffic on port 3306 (MySQL) and exclusively from EC2 instances that belong to the security group **AMSA-WP-SG**.
- **Outbound connections**: By default, AWS will allow all outbound connections, which ensures that the database can communicate with other resources if necessary.

To do this, we will navigate to the AWS VPC console, select the Security Groups section, and click Create security group. Next, we will fill in the fields with the necessary information and click *Create security group*.

![Security Group for the database RDS](../../figs/laboratories/03-aws-wp/wordpress/AMSA-DB-SG.png)

### Resum

| Grup de Seguretat | Inbound | Outbound |
|-------------------|---------|----------|
| AMSA-WP-SG       | HTTP (80) and HTTPS (443) des de 0.0.0.0/0; SSH (22) des de 0.0.0.0/0| All allowed |
| AMSA-DB-SG        | MySQL (3306) des de AMSA-Web-SG | All allowed |


## Creaci√≥ de la Base de Dades RDS

We already configured the database in the previous lab Deploying a web application with AWS. The only difference is that now the database is located in a private subnet and is only accessible from EC2 instances that belong to the security group **AMSA-Web-SG**.

- **Compute resources**: Don't connect to an EC2 compute resource
- **VPC**: AMSA-VPC
- **Subnet Group**: Create new DB Subnet Group
- **Public accessibility**: No
- **VPC security group**: AMSA-DB-SG
- **Availability Zone**: us-east-1d


## Creation of EC2 instances

The EC2 instances that will host WordPress will be deployed in private subnets. AWS allows us to create instance templates (Launch Templates) that make it easier to create instances with a predefined configuration. Therefore, we will create an instance template that includes the necessary configuration for our WordPress EC2 instances.

# Configuraci√≥ del Servidor Web amb WordPress

1. Creareu una instancia EC2 amb Amazon Linux, seleccionant la VPC **AMSA-VPC** i la subxarxa **AMSA-DMZ-01**. Assegureu-vos que l'inst√†ncia utilitzi el grup de seguretat **AMSA-WP-SG**. La podeu anomenar **AMSA-DB-Config**. Seleccionar *assignar ip p√∫blica*. Aquesta inst√†ncia nom√©s la farem servir per inicialitzar la base de dades i despr√©s la podrem eliminar.

2. Un cop configurada la inst√†ncia, connecteu-vos-hi mitjan√ßant SSH utilitzant la clau privada corresponent a la clau p√∫blica que vau associar a la inst√†ncia durant la seva creaci√≥. I realitzeu la configuraci√≥ de la base de dades MySQL per a WordPress.

3. Anem a crear una plantilla de llan√ßament (**Launch Template**) per a les inst√†ncies EC2 que allotjaran WordPress. Aquesta plantilla inclour√† la configuraci√≥ necess√†ria per a les inst√†ncies, incloent-hi el script d'instal¬∑laci√≥ i configuraci√≥ de WordPress.

   - Nom de la plantilla: **AMSA-WP-Template**
   - AMI: Amazon Linux 2023 (64-bit x86)
   - Inst√†ncia Type: t2.micro
   - Key Pair: AMSA-KEY
   - Subxarxa: No seleccionar cap subxarxa (es seleccionar√† din√†micament)
   - Grup de Seguretat: *AMSA-WP-SG*
   - Advanced Details: Afegiu el seg√ºent script a la secci√≥ de UserData.

:::{.callout-note title="Script d'instal¬∑laci√≥ i configuraci√≥ de WordPress üìù"}

Modifiqueu les dades de connexi√≥ a la base de dades segons les vostres dades.

```bash
#!/bin/bash
# sudo bash install_wp.sh

# Ajusteu les dades seg√ºents segons les vostres dades
DB_NAME="" 
DB_USER=""
DB_USER_PASSWORD=""
DB_HOST="" 

if [ "$(id -u)" -ne 0 ]; then
    echo "Please run this script with sudo or as root."
    exit 1
fi

dnf install -y wget php-mysqlnd httpd php-fpm php-mysqli php-json php php-devel php-gd expect

cd /tmp
wget https://wordpress.org/latest.tar.gz
tar -xzf latest.tar.gz

# Configure WordPress
cp wordpress/wp-config-sample.php wordpress/wp-config.php
sed -i "s/database_name_here/$DB_NAME/g" wordpress/wp-config.php
sed -i "s/username_here/$DB_USER/g" wordpress/wp-config.php
sed -i "s/password_here/$DB_USER_PASSWORD/g" wordpress/wp-config.php
sed -i "s/localhost/$DB_HOST/g" wordpress/wp-config.php

sudo cp -r wordpress/* /var/www/html/

sudo sed -i 's/AllowOverride None/AllowOverride All/g' /etc/httpd/conf/httpd.conf

sudo chown -R apache:apache /var/www
sudo chmod 2775 /var/www

sudo systemctl restart httpd
```
:::

Un cop creada la plantilla de llan√ßament, podeu utilitzar-la per crear inst√†ncies EC2 amb WordPress ja configurat i preparades per connectar amb la vostra base de dades RDS. Aneu a **EC2** i seleccioneu **Launch Instance**. A continuaci√≥, seleccioneu la plantilla de llan√ßament **AMSA-WP-Template** i configureu la resta de par√†metres segons les vostres necessitats.

- Nombre d'inst√†ncies: 2
- Subxarxa: Seleccioneu la subxarxa **AMSA-Private01** per a la primera inst√†ncia i **AMSA-Private02** per a la segona inst√†ncia. Les podeu anomenar **AMSA-WP-01** i **AMSA-WP-02** respectivament.


:::{.callout-important title="Nota sobre les inst√†ncies EC2 üñ•Ô∏è"}
Aquestes inst√†ncies no tindran IP p√∫blica, ja que nom√©s seran accessibles a trav√©s del balancejador de c√†rrega que configurarem m√©s endavant. Ara mateix no podreu accedir-hi directament ni per SSH ni per HTTP.
:::



## Configuraci√≥ del Balancejador de C√†rrega

En aquest punt, crearem un balancejador de c√†rrega per a les nostres inst√†ncies EC2. Aquest balancejador de c√†rrega ser√† responsable de distribuir uniformement el tr√†fic entre les inst√†ncies EC2 que allotgen WordPress.

Existeixen 3 tipus de balancejadors de c√†rrega a AWS: **Application Load Balancer (ALB)**, **Network Load Balancer (NLB)** i **Gateway Load Balancer (GWLB)**. En aquest cas, utilitzarem un **Application Load Balancer (ALB)**, ja que √©s el recomanat per a aplicacions web que utiltizen HTTP i HTTPS.

Navegueu a la consola de AWS i seleccioneu el servei **EC2**. A la barra lateral, seleccioneu **Load Balancers** i despr√©s **Create Load Balancer**. Seleccioneu **Application Load Balancer** i feu clic a **Create**.

- **Nom del balancejador de c√†rrega**: AMSA-ALB
- **Scheme**: Internet-facing
- **IP Address Type**: IPv4

![Configuraci√≥ del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/lb-01.png)

- **VPC**: AMSA-VPC
- **Availability Zones**: Seleccionar les zones de disponibilitat on tenim la subxarxa p√∫blica **AMSA-DMZ-01** (us-east-1a) i les **AMSA-DMZ-02** (us-east-1b).

- **Grups de Seguretat**: Nou grup de seguretat (**AMSA-ALB-SG**), aquest grup de seguretat permetr√† el tr√†fic d'entrada per als ports 80 (HTTP) i 443 (HTTPS) des de qualsevol origen per√≤ restringir√† el tr√†fic de sortida a les inst√†ncies EC2 (grup de seguretat **AMSA-WP-SG**).

    ![Grup de Seguretat per al balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/AMSA-ALB-SG.png)

    ![Configuraci√≥ del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/lb-03.png)

- **Listeners**: Crearem un listener per al port 80 (HTTP), que redirigir√† el tr√†fic al port 80 de les inst√†ncies EC2. Al port 443 (HTTPS) de moment no configurarem cap redirecci√≥. Per fer-ho, primer haureu de crear un **Target Group**. Aquest grup es necessari per indicar al balancejador de c√†rrega on enviar el tr√†fic.

  - *Target Group*:
    - **Target Type**: Instances
    - **Nom**: AMSA-WP-TG
    - **Protocol**: HTTP
    - **Port**: 80
    - **VPC**: AMSA-VPC
    - **Health checks**: HTTP, ruta **/**


    ![Configuraci√≥ del target group](../../figs/laboratories/03-aws-wp/wordpress/tg-03.png)

:::{.callout-note title="Health Check üéØ"}
El balancejador de c√†rrega comprova la salut de les inst√†ncies EC2 a trav√©s del port 80 i la ruta **/**. Aix√≤ significa que el balancejador de c√†rrega enviar√† tr√†fic a les inst√†ncies EC2 que responguin correctament a les peticions HTTP a la ruta **/**. Com que les nostres inst√†ncies EC2 tenen WordPress instal¬∑lat, aquestes inst√†ncies respondran correctament a les peticions HTTP a la ruta **/**. *Podem deixar la configuraci√≥ per defecte*. La instal¬∑laci√≥ de WordPress inclou una p√†gina d'inici que respondr√† amb 302 (Found) quan s'accedeixi a la ruta arrel (/), per aix√≤ pot passar que el health check mostri que la inst√†ncia no est√† saludable. Un cop configurat el WordPress, el health check mostrar√† que la inst√†ncia est√† saludable.
:::

- Seleccionarem les dos inst√†ncies EC2 que allotgen WordPress (AMSA-WP-01 i AMSA-WP-02) i les afegirem al target group. Utilitzant el bot√≥ **Include as pending below** i despr√©s **Add to registered**.

    ![Configuraci√≥ del target group](../../figs/laboratories/03-aws-wp/wordpress/tg-04.png)


- Un cop creat el target group, el seleccionarem com a target del listener del balancejador de c√†rrega.

    ![Configuraci√≥ del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/lb-05.png)

- Un cop creat el balancejador de c√†rrega, heu d'esperar uns minuts fins que el seu estat passi de **Provisioning** a **Active**. Un cop l'estat sigui **Active**, podeu accedir al balancejador de c√†rrega a trav√©s de la seva adre√ßa DNS.

![Balancejador de c√†rrega actiu](../../figs/laboratories/03-aws-wp/wordpress/lb-active.png)

- Ara ja podem accedir al balancejador de c√†rrega a trav√©s de la seva adre√ßa DNS i veure la p√†gina d'instal¬∑laci√≥ de WordPress:

![Instal¬∑laci√≥ de WordPress a trav√©s del balancejador de c√†rrega](../../figs/laboratories/03-aws-wp/wordpress/wp-config-01.png)

Procedirem a instal¬∑lar WordPress a trav√©s del balancejador de c√†rrega. Seguiu els passos de la instal¬∑laci√≥ i configureu l'usuari administrador i la contrasenya. Ara ja teniu el servidor web configurat amb WordPress i el balancejador de c√†rrega per distribuir el tr√†fic entre les inst√†ncies EC2.

## Configuraci√≥ VPN

### EC2 per desplegar el servidor VPN

Per desplegar el servidor VPN, crearem una nova inst√†ncia EC2 que actuar√† com a servidor VPN. Aquesta inst√†ncia EC2 haur√† d'estar en una subxarxa p√∫blica connectada a interent. Anomenarem aquesta inst√†ncia **AMSA-VPN** i la situarem a la subxarxa p√∫blica **AMSA-DMZ-01**. Aquesta inst√†ncia EC2 utilitzar√† el grup de seguretat **AMSA-VPN-SG** que permetr√† el tr√†fic necessari per al funcionament del servidor VPN.

1. Navegueu a la consola de AWS i seleccioneu el servei **EC2**. A la barra lateral, seleccioneu **Instances** i despr√©s **Launch Instances**.
2. Seleccioneu la imatge **Ubuntu Server 22.04 LTS**.
3. Seleccioneu la inst√†ncia **t2.micro**.
4. Configureu la inst√†ncia:
    - **Network**: AMSA-VPC
    - **Subnet**: AMSA-DMZ-01
    - **Auto-assign Public IP**: Enable

    ![Configuraci√≥ de la inst√†ncia EC2 per al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/AMSA-VPN.png)

5. Configureu el grup de seguretat: **AMSA-VPN-SG**.

    Si reviseu la documentaci√≥ d'instal¬∑laci√≥ del servidor OpenVPN: [OpenVPN Access Server System Administrator Guide ](https://openvpn.net/images/pdf/OpenVPN_Access_Server_Sysadmin_Guide_Rev.pdf). Veure que necessitem els seg√ºents ports oberts: **TCP 943, UDP 1194**.

    ![Configuraci√≥ del grup de seguretat per al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/AMSA-SG-VPN.png)

6. Connecteu-vos a la inst√†ncia EC2 a trav√©s de la consola online de AWS o amb una connexi√≥ SSH i executeu la seg√ºent comanda per instal¬∑lar el servidor OpenVPN:

    ```bash
    sudo apt update -y
    sudo apt install ca-certificates gnupg wget net-tools -y
    sudo wget https://as-repository.openvpn.net/as-repo-public.asc -qO /etc/apt/trusted.gpg.d/as-repo-public.asc
    sudo echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/as-repo-public.asc] http://as-repository.openvpn.net/as/debian jammy main" | sudo tee /etc/apt/sources.list.d/openvpn-as-repo.list
    sudo apt update && sudo apt install openvpn-as -y
    ```

    ![Instal¬∑laci√≥ del servidor OpenVPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-config.png)

7. Amb aquestes credencials, podreu accedir a la interf√≠cie web del servidor OpenVPN a trav√©s del vostre navegador web. Navegueu a la IP p√∫blica de la inst√†ncia EC2 (en el meu cas https://44.199.196.242:943/admin), com no tenim el certificat SSL configurat, ens sortir√† un missatge d'advert√®ncia, ignoreu-lo i continueu. Inicieu sessi√≥ amb les credencials que heu configurat anteriorment.

    > Nota: Si heu perdut les credencials de l'usuari `openvpn`, les podeu recuperar consultat el fitxer de logs del servidor OpenVPN. Per exemple, podeu consultar el fitxer de logs amb la seg√ºent comanda:
    >
    > ```bash
    > sudo less /usr/local/openvpn_as/init.log 
    > ```

    ![Interf√≠cie web del servidor OpenVPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-login.png)

    - Accepteu els termes de llic√®ncia.
  
    ![Acceptaci√≥ dels termes de llic√®ncia](../../figs/laboratories/03-aws-wp/wordpress/VPN-accept-terms.png)

    - Aneu a **VPN Server/Network Settings** i configureu el **Hostname or IP Address** amb la IP p√∫blica de la inst√†ncia EC2 on teniu el servidor OpenVPN. Un cop fet, clicareu a **Save**.

        ![Configuraci√≥ de la IP p√∫blica del servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-admin-01.png)


    - Aneu a **Access Controls/Internet Access and DNS** i seleccioneu l'opci√≥ **Split Tunnel** per evitar que tot el tr√†fic del client sigui redirigit a trav√©s de la VPN. √önicament el tr√†fic dirigit a les subxarxes de la VPC ser√† redirigit a trav√©s de la VPN.

        ![Configuraci√≥ de Split Tunnel](../../figs/laboratories/03-aws-wp/wordpress/VPN-Split-Tunnel.png)

    - Aneu a **Access Controls/Global Access Rules** i afegiu una regla per permetre el tr√†fic de la VPN a les subxarxes de la VPC:
  
        ![Configuraci√≥ de les regles d'acc√©s global](../../figs/laboratories/03-aws-wp/wordpress/VPN-Global-Acces.png)

    - Aneu a **User** i creu-vos un usuari i una contrasenya per connectar-vos al servidor VPN.

        ![Creaci√≥ d'un usuari per al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-User.png)

    - Un cop tinguem el fitxer de configuraci√≥, ja podeu fer un **Restart** del servei OpenVPN per aplicar tots els canvis. Torneu a accedir a la interf√≠cie web del servidor OpenVPN.

    - Aneu a **User/user/Connection Profiles** i creeu un perfil de connexi√≥ per defecte. Un cop creat us baixar√† un fitxer de configuraci√≥ que despr√©s utilitzarem per connectar-nos al servidor VPN.

        ![Desc√†rrega del fitxer de configuraci√≥ del client VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-Connection-Profile.png)

    

    - Installeu l'aplicaci√≥ [OpenVPN Connect](https://openvpn.net/client/) al vostre ordinador. Aquesta aplicaci√≥ √©s el client VPN que utilitzarem per connectar-nos al servidor VPN.

    - Un cop instal¬∑lat, obriu l'aplicaci√≥ i importeu el fitxer de configuraci√≥ que heu descarregat anteriorment.

        
8.  Un cop tot configurat, actualitzarem el grup de seguretat de les inst√†ncies EC2 per permetre el tr√†fic al port 22 √∫nicament provinent del servidor VPN. Aix√≤ significa que les inst√†ncies EC2 nom√©s acceptaran tr√†fic SSH del servidor VPN i no de qualsevol altre origen.

    ![Configuraci√≥ tr√†fic SSH a Ec2 del servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/ec2-ssh-only-vpn.png)

En aquest punt, ja no podreu accedir a les inst√†ncies EC2 on teniu el servei de WordPress a trav√©s de SSH, ja que el tr√†fic SSH nom√©s es permet des del servidor VPN. Per accedir a les inst√†ncies EC2, primer heu de connectar-vos al servidor VPN i despr√©s connectar-vos a les inst√†ncies EC2. Per fer-ho:

- Importeu el fitxer de configuraci√≥ del client OpenVPN Connect a l'aplicaci√≥ i connecteu-vos al servidor VPN.
  
    ![Connexi√≥ al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-01.png)

    > **TroubleShooting**: Si en el fitxer de configuraci√≥ veieu (**Server Hostname**) una ip del rang 10.0.X.X, aix√≤ vol dir que la VPN no s'ha configurat correctament. Assegureu-vos de reiniciar el servidor i tornar a descarregar el fitxer de configuraci√≥ del client, ha de tenir la ip p√∫blica del servidor VPN.

- Utilitzeu la mateixa contrasenya del usuari `openvpn` per connectar-vos al servidor VPN.

    ![Connexi√≥ al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-02.png)

- Si tot ha anat b√©, veureu que esteu connectats al servidor VPN.

    ![Connexi√≥ al servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/vpn-connection-03.png)
  
Finalment, connecteu-vos a les inst√†ncies EC2:

![Acc√©s a les inst√†ncies EC2 a trav√©s del servidor VPN](../../figs/laboratories/03-aws-wp/wordpress/VPN-SSH.png)

> **Consideracions importants**: El servidor VPN ens permet accedir a les inst√†ncies EC2 a trav√©s de SSH, per√≤ a partir de l'adre√ßa interna (10.0.X.X) de la inst√†ncia EC2. No podrem accedir a les inst√†ncies EC2 a trav√©s de la seva adre√ßa p√∫blica ja que hem configurat la VPN per accedir a les subxarxes de la VPC.

## Cleanup

Once completed, you can delete all EC2 instances and the RDS database to avoid unnecessary charges to your AWS account.