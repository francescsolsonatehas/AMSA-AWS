---
title: "Laboratori: Desplegament dâ€™un servidor web amb LVM"
lang: ca
---

En aquest laboratori aprendrem a utilitzar **LVM (Logical Volume Manager)** per administrar lâ€™emmagatzematge dâ€™un servidor web. Simularem un entorn real on diferents tipus de dades (codi font, dades de la web, i fitxers temporals) es gestionen mitjanÃ§ant **volums lÃ²gics**, millorant la flexibilitat i escalabilitat del sistema.


## ðŸŽ¯ Objectius

1. Entendre el funcionament i components de **LVM**: PV, VG i LV.  
2. Crear, formatar i muntar volums lÃ²gics per a un servei web.  
3. Ampliar o reduir la mida dels volums.  
4. Crear i utilitzar **snapshots** per fer cÃ²pies de seguretat en calent.

## ðŸ§± Escenari

Gestionarem una aplicaciÃ³ web desplegada en un servidor AlmaLinux.  

| **Directori** | **FunciÃ³** | **Exemple de contingut** |
|------------|--------|----------------------|
| `/opt/webapp/sources` | Codi font Django | Python, HTML, JS |
| `/opt/webapp/data` | Dades, imatges, logs | CSV, JPG, LOG |
| `/opt/webapp/run` | Fitxers temporals i sockets | PID, sock |

---

## ðŸ§© PreparaciÃ³ de la mÃ quina virtual

1. **Crea una nova MV** amb AlmaLinux i un disc principal de 20 GB.  
   Durant la instalÂ·laciÃ³, selecciona *LVM com a esquema de particionat*.  

2. **Afegeix dos discos addicionals de 20 GB** cadascun (ex. `nvme0n2` i `nvme0n3`).

3. **Comprova lâ€™estat inicial del sistema:**

   ```bash
   lsblk
    ```
    Hauries de veure una sortida semblant a:

    ```bash
    nvme0n1     20G  
    â”œâ”€nvme0n1p1 600M  /boot/efi
    â”œâ”€nvme0n1p2   1G  /boot
    â”œâ”€nvme0n1p3   2G  [SWAP]
    â””â”€nvme0n1p4 16.4G /
    nvme0n2     20G
    nvme0n3     20G
    ```

## ðŸ§  Activitat 1. CreaciÃ³ dels volums fÃ­sics i grup de volums

### Pas 1: Crear els volums fÃ­sics

```bash
pvcreate /dev/nvme0n2 /dev/nvme0n3
```

::: {.callout-warning title="ðŸ’¡ Comprova l'estat dels PV"}
Quin Ã©s lâ€™estat del camp **Allocatable** abans de crear el grup de volums?
:::

### Pas 2: Crear el grup de volums `vg_webapp`

```bash
vgcreate vg_webapp /dev/nvme0n2 /dev/nvme0n3
```

::: {.callout-warning title="ðŸ’¡ Comprova l'estat del VG"}
- Quina Ã©s la mida total del grup de volums `vg_webapp`?
- Quants extents tÃ© el VG i quina Ã©s la mida de cada extent?
:::

## âš™ï¸ Activitat 2. CreaciÃ³ i muntatge dels volums lÃ²gics

### Pas 1: Crear els LV

```bash
lvcreate -L 1G -n lv_sources vg_webapp
lvcreate -L 10G -n lv_data vg_webapp
lvcreate -L 1G -n lv_run vg_webapp
```

### Pas 2: Formatar els LV amb sistemes de fitxers

```bash
mkfs.xfs /dev/vg_webapp/lv_sources
mkfs.ext4 /dev/vg_webapp/lv_data
mkfs.xfs /dev/vg_webapp/lv_run
```

:::{.callout-warning title="ðŸ’¡ DiscussiÃ³"}
Per quÃ¨ podria ser interessant utilitzar **xfs** per a `/run` i **ext4** per a `/data` o al revÃ©s?
:::


### Pas 3: Muntar els volums

```bash
mkdir -p /opt/webapp/{sources,data,run}
mount /dev/vg_webapp/lv_sources /opt/webapp/sources
mount /dev/vg_webapp/lv_data /opt/webapp/data
mount /dev/vg_webapp/lv_run /opt/webapp/run
```

::: {.callout-warning title="ðŸ’¡ Comprova els muntatges"}
- Utilitza `df -h` per verificar que els volums estan muntats correctament.
- Afegeix les entrades corresponents a `/etc/fstab` per muntar-los automÃ ticament en reiniciar.
:::

## ðŸ“ Activitat 3. Redimensionar volums lÃ²gics

### Escenari 1: Augmentar lv_data de 10 GB a 20 GB

Quan sâ€™amplia un volum lÃ²gic, sâ€™afegeixen nous extents al final del volum. Si el sistema de fitxers Ã©s **ext4**, cal actualitzar-ne la taula dâ€™espai amb `resize2fs`.

```bash
lvextend -L +10G /dev/vg_webapp/lv_data
resize2fs /dev/vg_webapp/lv_data
```

### Escenari 2: Reduir lv_run de 1 GB a 500 MB

El sistema de fitxers *xfs* no permet reduir volums.

```bash
umount /opt/webapp/run
lvremove /dev/vg_webapp/lv_run
lvcreate -L 500M -n lv_run vg_webapp
mkfs.xfs -f /dev/vg_webapp/lv_run
mount /dev/vg_webapp/lv_run /opt/webapp/run
```

:::{.callout-warning title="ðŸ’¡ Reduir o Ampliar"}
QuÃ¨ creus que Ã©s mÃ©s segur: redimensionar un volum lÃ²gic cap amunt o cap avall? Per quÃ¨?
:::

## ðŸ’¾ Activitat 4. CreaciÃ³ dâ€™snapshots

Els snapshots LVM permeten fer cÃ²pies de seguretat en calent del sistema de fitxers.
Aquest mecanisme utilitza la tÃ¨cnica **Copy-on-Write (COW)** per mantenir versions consistents de les dades mentre sâ€™estan utilitzant.

### Pas 1: Crear dades

```bash
echo "Hello, World1!" > /opt/webapp/data/file1.txt
echo "Hello, World2!" > /opt/webapp/data/file2.txt
echo "Hello, World3!" > /opt/webapp/data/file3.txt
```

### Pas 2: Crear snapshot

```bash
lvcreate -L 1G -s -n snap_data /dev/vg_webapp/lv_data
```

### Pas 3: Muntar snapshot

```bash
mkdir /snaps
mount /dev/vg_webapp/snap_data /snaps
diff -r /opt/webapp/data /snaps
```

### Pas 4: Modificar dades originals i comparar

```bash
dd if=/dev/zero of=/opt/webapp/data/file3.txt bs=1M count=100
diff -r /opt/webapp/data /snaps
```

::: {.callout-warning title="ðŸ’¡ ReflexiÃ³: Mida snapshot"}
QuÃ¨ passa amb la mida de lâ€™snapshot quan sâ€™escriuen noves dades?
:::

### Pas 5: Crear un segon snapshot i comprovar versions

```bash
lvcreate -L 1G -s -n snap_data2 /dev/vg_webapp/lv_data
umount /snaps
mount /dev/vg_webapp/snap_data2 /snaps
ls -li /opt/webapp/data /snaps/
```

:::{.callout-warning title="Inodes"}
Els fitxers inalterats comparteixen inode; els modificats tenen un inode nou.
:::

### ðŸ§¹ Neteja 

```bash
umount /snaps
lvremove /dev/vg_webapp/snap_data
lvremove /dev/vg_webapp/snap_data2
```

## Exercicis addicionals

- Descriu els passos per migrar un `LV` existent a un altre `PV` utilitzant `pvmove`.  Quin avantatge tÃ© aquest procediment respecte a copiar fitxers manualment?
- Configura un mirall de `/opt/webapp/data` utilitzant LVM. Realitza una prova simulant la fallada dâ€™un disc i comprova que les dades es mantenen accessibles. Quines implicacions tÃ© sobre el rendiment?
- Cerca informaciÃ³ sobre l'eina `fio` i realitza un experiment per avaluar el rendiment dâ€™un volum *striped*. Representa una grÃ fica amb els resultats per diferents valors de `--stripe-size` (`64K`, `128K`, `256K`, `512K`, `1M`, `2M`). Interpreta la relaciÃ³ entre mida de bloc i rendiment.

